<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Thu/Chi - TLCGroup Intranet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;      /* Blue-500 */
            --primary-hover: #2563eb; /* Blue-600 */
            --success: #10b981;      /* Emerald-500 */
            --warning: #f59e0b;      /* Amber-500 */
            --error: #ef4444;        /* Red-500 */
            --text-primary: #0f172a;  /* Slate-900 */
            --text-secondary: #64748b; /* Slate-500 */
            --border: #e2e8f0;       /* Slate-200 */
            --background: #f8fafc;    /* Slate-50 */
            --card-bg: #ffffff;      /* White */
            /* Legacy support */
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --text-color: #0f172a;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.04);
            --success-color: #10b981;
            --error-color: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Navigation Bar - Kissflow Style */
        nav.sticky {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .form-section-container {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            padding: 2rem;
        }
        
        .form-section-container:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.02);
            transform: translateY(-2px);
        }
        
        h1 {
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.25rem; /* text-xl - same as "Order to Cash" */
            letter-spacing: -0.025em;
            font-family: 'Inter', sans-serif;
            line-height: 1.2;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.125rem; /* text-lg on mobile */
            }
        }
        
        /* Progress Stepper */
        .progress-stepper {
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }
        
        .stepper-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .stepper-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }
        
        .stepper-line-progress {
            position: absolute;
            top: 20px;
            left: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s ease;
            z-index: 1;
        }
        
        .stepper-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }
        
        .stepper-step:not(:last-child) {
            margin-right: 0;
        }
        
        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .stepper-step.active .stepper-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .stepper-step.completed .stepper-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .stepper-step.completed .stepper-circle::before {
            content: '‚úì';
            font-size: 1.25rem;
        }
        
        .stepper-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            max-width: 120px;
            transition: color 0.3s ease;
        }
        
        .stepper-step.active .stepper-label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .stepper-step.completed .stepper-label {
            color: var(--success);
        }
        
        @media (max-width: 768px) {
            .stepper-label {
                font-size: 0.625rem;
                max-width: 80px;
            }
            
            .stepper-circle {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }
        }
        
        /* Form Steps */
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .step-navigation button {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .step-navigation button:hover:not(:disabled) {
            background: var(--background);
        }
        
        .step-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .step-navigation .btn-next {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .step-navigation .btn-next:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        
        .step-navigation .btn-submit {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .step-navigation .btn-submit:hover:not(:disabled) {
            background: #059669;
        }
        
        h2 {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
        }

        h2 .tooltip-icon {
            cursor: help;
            font-size: 18px;
            color: var(--primary-color);
            position: relative;
        }

        h2 .tooltip-icon .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: var(--text-color);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
        }

        h2 .tooltip-icon .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-color) transparent transparent transparent;
        }

        h2 .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
            padding: 0;
            background: transparent;
            border: none;
            margin-top: 0;
        }
        
        .company-info, .voucher-info {
            flex: 1;
            min-width: 300px;
        }
        
        .form-row {
            margin-bottom: 1.25rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            transition: all 0.15s ease;
            background-color: white;
            color: var(--text-primary);
        }
        
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input:read-only, textarea:read-only {
            background-color: #f8fafc;
            color: #64748b;
            cursor: default;
        }
        
        label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
            letter-spacing: 0;
            text-transform: none;
        }
        
        select {
            background-color: white;
            cursor: pointer;
            height: 42px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .button-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            justify-content: flex-end;
        }
        
        button {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        button:not(:disabled):hover {
            transform: translateY(-1px);
        }
        
        button:not(:disabled):active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }
        
        .btn-secondary {
            background-color: white;
            color: #475569;
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--background);
            border-color: #cbd5e1;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
            box-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            box-shadow: 0 1px 2px rgba(239, 68, 68, 0.2);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.025em;
            margin-top: 0.5rem;
            max-width: fit-content;
            font-family: 'Inter', sans-serif;
        }
        
        .status-pending {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .amounts {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .amount-row {
            display: flex;
            justify-content: space-between;
        }
        
        .amount-row.total {
            font-weight: 700;
            font-size: 18px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            margin-top: 10px;
        }
        
        .upload-container {
            border: 2px dashed var(--border);
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            background-color: var(--background);
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .upload-container:hover {
            background-color: #f1f5f9;
            border-color: var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .company-details {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: none;
        }
        
        .company-details.show {
            display: block;
        }
        
        .approval-section {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .approval-history {
            margin-top: 1rem;
            padding: 1.25rem;
            background-color: #ffffff;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid #e5e7eb;
        }

        .approval-history h3 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #111827;
        }

        .approval-history ul {
            list-style: none;
            padding: 0;
        }

        .approval-history li {
            margin-bottom: 5px;
            padding-left: 10px;
            border-left: 3px solid var(--border-color);
        }

        /* Expense section fields - inside B·∫£ng k√™ section */
        .expense-section-fields {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
        }

        .expense-section-fields .form-group {
            margin-bottom: 15px;
        }

        /* Signature Upload Styles */
        .signature-container {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1rem;
            background: #fafbfc;
        }

        .signature-preview-area {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border);
            margin-bottom: 0.75rem;
        }

        .signature-preview-area img {
            max-width: 200px;
            max-height: 80px;
            object-fit: contain;
        }

        #signature-placeholder {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .signature-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .signature-upload-btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signature-note {
            color: #64748b;
            font-size: 0.75rem;
        }

        .signature-note small {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .expense-section-fields .form-group:last-child {
            margin-bottom: 0;
        }

        .expense-section-fields label {
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-transform: none;
            margin-bottom: 0.375rem;
        }

        .expense-section-fields textarea {
            min-height: 100px;
        }

        /* Table styles - Modern Kissflow Design */
        .expense-table-container {
            margin-top: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0, 0, 0, 0.02);
            overflow-x: auto;
            border: 1px solid var(--border);
        }

        .expense-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 0;
            overflow: hidden;
            min-width: 800px;
        }

        .expense-table th, .expense-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: top;
        }

        .expense-table th {
            background: var(--background);
            font-size: 0.8125rem;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid var(--border);
            text-transform: none;
            letter-spacing: 0;
        }
        
        .expense-table tbody tr {
            transition: background-color 0.15s ease;
            border-bottom: 1px solid var(--border);
        }
        
        .expense-table tbody tr:hover {
            background: var(--background);
        }
        
        .expense-table tbody tr:last-child td {
            border-bottom: none;
        }

        .expense-table td input[type="text"],
        .expense-table td input[type="number"] {
            border: none;
            padding: 5px;
            width: 100%;
            background-color: transparent;
        }

        .expense-table td input[type="number"] {
            text-align: right;
        }

        .expense-table td .remove-row-btn {
            background-color: transparent;
            color: var(--error-color);
            border: none;
            padding: 5px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }

        .expense-table td .remove-row-btn:hover {
            color: #a00;
            transform: none;
        }

        .expense-table-footer {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 15px 20px;
            background-color: var(--background);
            border-top: 1px solid var(--border);
            border-radius: 0;
            font-weight: 700;
            font-size: 18px;
            gap: 10px;
        }

        .expense-table-footer .footer-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .expense-table-footer .footer-row span:first-child {
            margin-right: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .expense-table-footer .footer-row span:last-child {
            color: var(--primary);
            font-weight: 700;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .attachment-cell {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .attachment-cell .attachment-button {
            padding: 6px 10px;
            font-size: 14px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            max-width: fit-content;
        }

        .attachment-cell .attachment-button:hover {
            background-color: #3367d6;
        }

        .attachment-cell .file-list {
            font-size: 12px;
            color: #555;
            max-height: 60px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: 4px;
            background-color: #fcfcfc;
        }

        .attachment-cell .file-list p {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .loading-indicator.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Validation Styles */
        .form-group {
            position: relative;
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .error-message.show {
            display: block;
        }

        input.invalid, select.invalid, textarea.invalid {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 2px rgba(234, 67, 53, 0.2) !important;
        }

        input.valid, select.valid, textarea.valid {
            border-color: var(--success-color) !important;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notification Styles - Matching Intranet */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            font-size: 14px;
            font-weight: 500;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: #666;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Auto-save Indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .auto-save-indicator.show {
            display: block;
        }

        .auto-save-indicator.saving {
            background-color: var(--primary-color);
        }

        .auto-save-indicator.saved {
            background-color: var(--success-color);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Confirmation Dialog */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .confirmation-overlay.show {
            display: flex;
        }

        .confirmation-dialog {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirmation-dialog h3 {
            margin-bottom: 12px;
            color: var(--text-color);
            font-size: 18px;
        }

        .confirmation-dialog p {
            margin-bottom: 20px;
            color: #666;
        }

        .confirmation-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirmation-actions button {
            min-width: 80px;
        }

        /* File validation styles */
        .file-error {
            color: var(--error-color);
            font-size: 11px;
            margin-top: 4px;
        }

        .file-size-info {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* Search dropdown styles */
        .searchable-select {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .dropdown-options {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dropdown-options.show {
            display: block;
        }

        .dropdown-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-option:hover {
            background-color: var(--light-gray);
        }

        .dropdown-option.hidden {
            display: none;
        }

        /* File preview styles */
        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .file-preview-item {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            background: var(--light-gray);
            max-width: 150px;
        }

        .file-preview-item img {
            max-width: 100%;
            max-height: 100px;
            border-radius: 4px;
        }

        .file-preview-item .file-name {
            font-size: 11px;
            margin-top: 5px;
            word-break: break-word;
        }

        .file-preview-item .file-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal.show {
            display: flex;
        }

        .file-preview-modal img,
        .file-preview-modal iframe {
            max-width: 90%;
            max-height: 90%;
        }

        .file-preview-modal .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 24px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .button-row, .table-actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }

            .form-header {
                flex-direction: column;
            }

            .toast-container {
                left: 20px;
                right: 20px;
                top: 10px;
            }

            .toast {
                min-width: auto;
                max-width: 100%;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation Bar - Kissflow Style + Sign In -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="if(window.opener) window.close(); else window.location.href='index.html'">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-base font-bold" style="font-family: 'Inter', sans-serif;">TLC</span>
                </div>
                <span class="font-semibold text-lg text-gray-900 tracking-tight" style="font-family: 'Inter', sans-serif;">TLCGroup</span>
            </div>
            <div class="flex items-center" style="gap: 12px;">
                <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 font-medium transition flex items-center gap-2 px-3 py-2" style="background: transparent; border-radius: 8px;">
                    <i class="fas fa-arrow-left text-sm"></i>
                    <span>Quay l·∫°i Intranet</span>
                </button>
                <button onclick="window.location.href='index.html'" class="btn-primary" style="min-height: 36px;">
                    <i class="fas fa-sign-in-alt" style="margin-right: 6px;"></i>
                    <span>Sign In</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="flex-1 py-6">
        <div class="container form-section-container" id="voucher-form">
        <h1 id="form-title">PHI·∫æU THU/CHI</h1>
        
        <!-- Progress Stepper -->
        <div class="progress-stepper">
            <div class="stepper-container">
                <div class="stepper-line"></div>
                <div class="stepper-line-progress" id="stepper-progress"></div>
                <div class="stepper-step active" data-step="1" onclick="goToStep(1)">
                    <div class="stepper-circle">1</div>
                    <div class="stepper-label">Th√¥ng tin c∆° b·∫£n</div>
                </div>
                <div class="stepper-step" data-step="2" onclick="goToStep(2)">
                    <div class="stepper-circle">2</div>
                    <div class="stepper-label">Th√¥ng tin ƒë·ªëi t∆∞·ª£ng</div>
                </div>
                <div class="stepper-step" data-step="3" onclick="goToStep(3)">
                    <div class="stepper-circle">3</div>
                    <div class="stepper-label">Chi ti·∫øt chi ph√≠</div>
                </div>
                <div class="stepper-step" data-step="4" onclick="goToStep(4)">
                    <div class="stepper-circle">4</div>
                    <div class="stepper-label">Ph√™ duy·ªát</div>
                </div>
                <div class="stepper-step" data-step="5" onclick="goToStep(5)">
                    <div class="stepper-circle">5</div>
                    <div class="stepper-label">Xem l·∫°i & G·ª≠i</div>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Th√¥ng tin c∆° b·∫£n -->
        <div class="form-step active" id="step-1">
        <div class="form-header">
            <div class="company-info">
                <div class="form-group">
                    <label for="company">C√¥ng ty:</label>
                    <select id="company" name="company" required onchange="updateCompanyDetails()">
                        <option value="">-- Ch·ªçn c√¥ng ty --</option>
                    </select>
                    <div class="error-message"></div>
                    <div id="company-details" class="company-details">
                        <p id="company-address"></p>
                    </div>
                </div>
            </div>
            <div class="voucher-info">
                <div class="form-group">
                    <label for="voucher-type">Lo·∫°i phi·∫øu:</label>
                    <select id="voucher-type" name="voucher-type" required onchange="updateVoucherTitle()">
                        <option value="">-- Ch·ªçn lo·∫°i phi·∫øu --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="voucher-number">S·ªë phi·∫øu:</label>
                    <input type="text" id="voucher-number" name="voucher-number" value="TL-2023-" required readonly>
                </div>
                <div class="form-group">
                    <label for="voucher-date">Ng√†y l·∫≠p phi·∫øu:</label>
                    <input type="date" id="voucher-date" name="voucher-date" required>
                    <small class="form-hint" style="display: block; margin-top: 0.25rem; color: #6b7280; font-size: 0.875rem;">Ch·ªâ ƒë∆∞·ª£c ch·ªçn ng√†y hi·ªán t·∫°i tr·ªü ƒëi</small>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="employee">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</label>
                <select id="employee" name="employee" required onchange="updateEmployeeDepartment()">
                    <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
                </select>
                <div class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="department">B·ªô ph·∫≠n:</label>
                <input type="text" id="department" name="department" readonly>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" disabled class="btn-prev">‚Üê Quay l·∫°i</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(2)">Ti·∫øp theo ‚Üí</button>
        </div>
        </div>
        
        <!-- Step 2: Th√¥ng tin ƒë·ªëi t∆∞·ª£ng -->
        <div class="form-step" id="step-2">
        <h2>Th√¥ng tin ƒë·ªëi t∆∞·ª£ng</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="payee-dropdown">Ch·ªçn ng∆∞·ªùi n·ªôp/nh·∫≠n:</label>
                <select id="payee-dropdown" name="payee-dropdown" onchange="document.getElementById('payee-name').value = this.value;">
                    <option value="">-- Ch·ªçn ng∆∞·ªùi n·ªôp/nh·∫≠n --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="payee-name">H·ªç t√™n ng∆∞·ªùi n·ªôp/nh·∫≠n:</label>
                <input type="text" id="payee-name" name="payee-name" required>
                <div class="error-message"></div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="reason">L√Ω do:</label>
                <textarea id="reason" name="reason" required></textarea>
                <div class="error-message"></div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="amount">T·ªïng s·ªë ti·ªÅn:</label>
                <input type="text" id="amount" name="amount" required readonly>
            </div>
        </div>

        <!-- Signature Upload Section -->
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="signature-upload">Ch·ªØ k√Ω ng∆∞·ªùi ƒë·ªÅ ngh·ªã: <span class="required">*</span></label>
                <div class="signature-container">
                    <div class="signature-preview-area" id="signature-preview-area">
                        <img id="signature-preview" src="" alt="Ch·ªØ k√Ω" style="display: none; max-height: 80px;">
                        <span id="signature-placeholder">Ch∆∞a c√≥ ch·ªØ k√Ω</span>
                    </div>
                    <div class="signature-actions">
                        <label for="signature-upload" class="btn-secondary signature-upload-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            T·∫£i ch·ªØ k√Ω l√™n
                        </label>
                        <input type="file" id="signature-upload" accept="image/*" style="display: none;" onchange="handleSignatureUpload(event)">
                        <button type="button" class="btn-secondary" onclick="clearSignature()" id="clear-signature-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            X√≥a
                        </button>
                    </div>
                    <div class="signature-note">
                        <small>üí° Ch·ªØ k√Ω s·∫Ω ƒë∆∞·ª£c l∆∞u ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c phi·∫øu sau. H·ªó tr·ª£: PNG, JPG, GIF (n·ªÅn trong su·ªët khuy·∫øn ngh·ªã)</small>
                    </div>
                </div>
                <div class="error-message" id="signature-error"></div>
            </div>
        </div>

        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(1)">‚Üê Quay l·∫°i</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(3)">Ti·∫øp theo ‚Üí</button>
        </div>
        </div>
        
        <!-- Step 3: Chi ti·∫øt chi ph√≠ -->
        <div class="form-step" id="step-3">
        <h2>
            B·∫£ng k√™ t√†i li·ªáu ƒë√≠nh k√®m
            <span class="tooltip-icon">
                ‚ÑπÔ∏è
                <span class="tooltip-text">
                    H∆Ø·ªöNG D·∫™N B·∫¢NG K√ä CHI PH√ç: <br>
                    ‚Ä¢ STT: T·ª± ƒë·ªông tƒÉng, kh√¥ng c·∫ßn nh·∫≠p <br>
                    ‚Ä¢ N·ªôi dung: M√¥ t·∫£ chi ti·∫øt kho·∫£n chi <br>
                    ‚Ä¢ S·ªë ti·ªÅn: Nh·∫≠p s·ªë, t·ª± ƒë·ªông format ti·ªÅn Vi·ªát Nam <br>
                    ‚Ä¢ ƒê√≠nh k√®m: T·∫£i l√™n c√°c t√†i li·ªáu li√™n quan ƒë·∫øn kho·∫£n chi n√†y
                </span>
            </span>
        </h2>
        
        <div class="expense-section-fields">
            <div class="form-row">
                <div class="form-group">
                    <label for="currency">Lo·∫°i ti·ªÅn:</label>
                    <select id="currency" name="currency" required>
                        <option value="">-- Ch·ªçn lo·∫°i ti·ªÅn --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
            </div>
            
            <!-- Hidden input for amount-in-words (for JavaScript compatibility) -->
            <input type="hidden" id="amount-in-words" name="amount-in-words">
        </div>
        
        <div class="table-actions">
            <button type="button" class="btn-secondary" id="add-row-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Th√™m d√≤ng
            </button>
            <button type="button" class="btn-secondary" id="copy-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                D√°n t·ª´ Excel
            </button>
            <button type="button" class="btn-secondary" id="import-table-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Nh·∫≠p file Excel
            </button>
        </div>

        <div class="expense-table-container">
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>N·ªôi dung</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>ƒê√≠nh k√®m</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                </tbody>
            </table>
            <div class="expense-table-footer">
                <div class="footer-row">
                    <span>T·ªïng c·ªông:</span> <span id="grand-total">0 VNƒê</span>
                </div>
                <div class="footer-row">
                    <span>S·ªë ti·ªÅn b·∫±ng ch·ªØ:</span> <span id="amount-in-words-display"></span>
                </div>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(2)">‚Üê Quay l·∫°i</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(4)">Ti·∫øp theo ‚Üí</button>
        </div>
        </div>
        
        <!-- Step 4: Ph√™ duy·ªát -->
        <div class="form-step" id="step-4">
        <div class="approval-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="approver">Ng∆∞·ªùi ph√™ duy·ªát:</label>
                    <select id="approver" name="approver" required>
                        <option value="">-- Ch·ªçn ng∆∞·ªùi ph√™ duy·ªát --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="approval-status-display">Tr·∫°ng th√°i ph√™ duy·ªát:</label>
                    <div class="status-indicator status-pending" id="approval-status-display">
                        Pending
                    </div>
                </div>
            </div>
            <div class="approval-history">
                <h3>L·ªãch s·ª≠ ph√™ duy·ªát</h3>
                <ul id="approval-history-list">
                    <li>Ch∆∞a c√≥ y√™u c·∫ßu ph√™ duy·ªát n√†o ƒë∆∞·ª£c g·ª≠i.</li>
                </ul>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(3)">‚Üê Quay l·∫°i</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(5)">Ti·∫øp theo ‚Üí</button>
        </div>
        </div>
        
        <!-- Step 5: Xem l·∫°i & G·ª≠i -->
        <div class="form-step" id="step-5">
        <h2>Xem l·∫°i th√¥ng tin</h2>
        
        <!-- Review Section - Full Details -->
        <div class="review-section" style="background: var(--background); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Th√¥ng tin chung</h3>
                <button type="button" onclick="editStepFromReview(1)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Ch·ªânh s·ª≠a
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">C√¥ng ty</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-company">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Lo·∫°i phi·∫øu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-type">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">S·ªë phi·∫øu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-number">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ng√†y l·∫≠p phi·∫øu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-date">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-employee">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">B·ªô ph·∫≠n</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-department">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ng∆∞·ªùi n·ªôp/nh·∫≠n</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-payee">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ch·ªØ k√Ω ng∆∞·ªùi ƒë·ªÅ ngh·ªã</div>
                    <div style="padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid var(--border); display: inline-block;">
                        <img id="review-signature" src="" alt="Ch·ªØ k√Ω" style="max-height: 60px; max-width: 150px; display: none;">
                        <span id="review-signature-placeholder" style="color: #94a3b8; font-size: 0.875rem;">Ch∆∞a c√≥</span>
                    </div>
                </div>
            </div>
            
            <!-- Ph√™ duy·ªát section with edit button -->
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Th√¥ng tin ph√™ duy·ªát</h3>
                    <button type="button" onclick="editStepFromReview(4)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Ch·ªânh s·ª≠a
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;">
                    <div class="review-item">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ng∆∞·ªùi ph√™ duy·ªát</div>
                        <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-approver-display">-</div>
                    </div>
                    <div class="review-item">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Tr·∫°ng th√°i</div>
                        <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-status">Pending</div>
                    </div>
                </div>
            </div>
            
            <div class="review-item" style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.375rem;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">L√Ω do</div>
                    <button type="button" onclick="editStepFromReview(2)" class="btn-edit-review" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.375rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Ch·ªânh s·ª≠a
                    </button>
                </div>
                <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary); padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid var(--border);" id="review-reason">-</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">T·ªïng s·ªë ti·ªÅn</div>
                    <div style="font-size: 1.125rem; font-weight: 600; color: var(--primary);" id="review-amount">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">S·ªë ti·ªÅn b·∫±ng ch·ªØ</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary); font-style: italic;" id="review-amount-words">-</div>
                </div>
            </div>
            
            <!-- Chi ti·∫øt c√°c kho·∫£n m·ª•c -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Chi ti·∫øt c√°c kho·∫£n m·ª•c</h3>
                <button type="button" onclick="editStepFromReview(3)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Ch·ªânh s·ª≠a
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden;">
                    <thead>
                        <tr style="background: var(--background);">
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">STT</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">N·ªôi dung</th>
                            <th style="padding: 0.75rem; text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">S·ªë ti·ªÅn</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">ƒê√≠nh k√®m</th>
                        </tr>
                    </thead>
                    <tbody id="review-expense-items">
                        <tr>
                            <td colspan="4" style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="button-row">
            <button type="button" class="btn-primary" id="save-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                L∆∞u phi·∫øu
            </button>
            <button type="button" class="btn-success" id="send-approval-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                G·ª≠i ph√™ duy·ªát
            </button>
            <div class="loading-indicator" id="loading-indicator">
                <div class="spinner"></div>
                <span>ƒêang g·ª≠i...</span>
            </div>
            <button type="button" class="btn-secondary" id="export-pdf-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Xu·∫•t PDF
            </button>
            <button type="button" class="btn-secondary" id="export-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Xu·∫•t Excel
            </button>
            <button type="button" class="btn-secondary" id="import-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Nh·∫≠p t·ª´ Excel (Form)
            </button>
            <button type="button" class="btn-secondary" id="save-template-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                L∆∞u Template
            </button>
            <button type="button" class="btn-secondary" id="load-template-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Load Template
            </button>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(4)">‚Üê Quay l·∫°i</button>
            <button type="button" class="btn-submit" onclick="sendForApproval()">G·ª≠i ph√™ duy·ªát</button>
        </div>
        </div>
    </div>
    
    <!-- Footer - Matching Intranet Style -->
    <footer class="mt-auto border-t border-slate-200 py-6 bg-white text-center text-xs text-slate-400">
        <p>&copy; 2025 TLCGroup. All rights reserved.</p>
    </footer>
    
    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="auto-save-indicator"></div>
    
    <!-- Confirmation Dialog -->
    <div class="confirmation-overlay" id="confirmation-overlay">
        <div class="confirmation-dialog">
            <h3 id="confirmation-title">X√°c nh·∫≠n</h3>
            <p id="confirmation-message"></p>
            <div class="confirmation-actions">
                <button type="button" class="btn-secondary" id="confirmation-cancel">H·ªßy</button>
                <button type="button" class="btn-danger" id="confirmation-confirm">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    <script>
        const data = (function(b64){
  const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  return JSON.parse(new TextDecoder('utf-8').decode(bytes));
})("eyJmb3JtX3RpdGxlIjoiUEhJ4bq+VSBUSFUvQ0hJIiwidm91Y2hlcl90eXBlcyI6WyJUaHUiLCJDaGkiXSwiY3VycmVuY3lfb3B0aW9ucyI6WyJWTsSQIiwiVVNEIiwiRVVSIl0sImNvbXBhbnlfbmFtZXMiOlsiQ8OUTkcgVFkgVE5ISCBUxq8gVuG6pE4gVExDIiwiQ8OUTkcgVFkgVE5ISCBFR0cgVkVOVFVSRVMiLCJDw5RORyBUWSBD4buUIFBI4bqmTiDEkOG6plUgVMavIENISU5IIFBIT05HIiwiQ8OUTkcgVFkgVE5ISCBNRURJQSBJTlNJREVSIiwiQ8OUTkcgVFkgQ+G7lCBQSOG6pk4gxJDhuqZVIFTGryBUTEMgR1JPVVAiLCJDw5RORyBUWSBD4buUIFBI4bqmTiBXT1JLU01BUlQiLCJDw5RORyBUWSBD4buUIFBI4bqmTiBJTlNJREVSUyIsIkPDlE5HIFRZIFROSEggRUdHIFZFTlRVUkVTIiwiQ8OUTkcgVFkgVFLDgUNIIE5ISeG7hk0gSOG7rlUgSOG6oE4gROG7ikNIIFbhu6QgUklPVCBHQU1FUyJdLCJlbXBsb3llZV9uYW1lcyI6WyJMw6ogTmfDom4gQW5oIiwiTmd1eeG7hW4gVsSDbiBDaGluaCIsIkzDqiBUaMO5eSBMaW5oIiwiTmd1eeG7hW4gTOG7sWMiLCJMw6ogTWluaCIsIkzDqiBNaW5oIEFuaCIsIk5ndXnhu4VuIFRo4buLIE5oYW5oIiwiTMawIEvhu7MgTmjDoyIsIk5ndXllbiBQaG9uZyIsIlRy4bqnbiBUaGFuaCIsIkFuaCBUaMawIFRow6FpIFRo4buLIiwiTmd1eeG7hW4gTMawIEFuaCBUaMawIiwiTmd1eWVuIFRpbW90aHkiLCJOZ3V5ZW4gVGluYSBMaW5oIiwiUGjhuqFtIFRyw60iXSwiYXBwcm92ZXJfbmFtZXMiOlsiTMOqIE5nw6JuIEFuaCIsIk5ndXnhu4VuIFbEg24gQ2hpbmgiLCJMw6ogVGjDuXkgTGluaCIsIk5ndXnhu4VuIEzhu7FjIiwiTMOqIE1pbmgiLCJMw6ogTWluaCBBbmgiLCJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkzGsCBL4buzIE5ow6MiLCJOZ3V5ZW4gUGhvbmciLCJUcuG6p24gVGhhbmgiLCJBbmggVGjGsCBUaMOhaSBUaOG7iyIsIk5ndXnhu4VuIEzGsCBBbmggVGjGsCIsIk5ndXllbiBUaW1vdGh5IiwiTmd1eWVuIFRpbmEgTGluaCIsIlBo4bqhbSBUcsOtIl0sImNvbXBhbmllc19kYXRhIjpbeyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IlRMQyIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIFTGryBW4bqkTiBUTEMiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxMzUxOTc1NiIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJFLlYiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgVE5ISCBFR0cgVkVOVFVSRVMiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNDQ5NDA2MCIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJDLlAiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgQ+G7lCBQSOG6pk4gxJDhuqZVIFTGryBDSElOSCBQSE9ORyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE0MDk3NTA3IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6Ik0uSSIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIE1FRElBIElOU0lERVIiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNTM4MDQyOSIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJUTENHIiwiVMOqbiBjw7RuZyB0eSI6IkPDlE5HIFRZIEPhu5QgUEjhuqZOIMSQ4bqmVSBUxq8gVExDIEdST1VQIiwixJDhu4thIGNo4buJIjoiQi4zLjA5LCBU4bqnbmcgMywgTMO0IEIsIFPhu5EgMzQtMzUgQuG6v24gVsOibiDEkOG7k24sIFBoxrDhu51uZyAxMywgUXXhuq1uIDQsIFRow6BuaCBwaOG7kSBI4buTIENow60gTWluaCwgVmnhu4d0IE5hbSIsIk3DoyBz4buRIHRodeG6vyI6IjAzMTUzMDc2NzYiLCJFbWFpbCDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6ImFuaC5sZUBtZWRpYWluc2lkZXIudm4iLCLEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IkzDqiBOZ8OibiBBbmgiLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTmd1eeG7hW4gVGjhu4sgTmhhbmgiLCJDaOG7ryBrw70gS+G6vyB0b8OhbiB0csaw4bufbmciOiIiLCJFbWFpbCBUaOG7pyBxdeG7uSI6ImxpbmgubGVAdGwtYy5jb20udm4iLCJUaOG7pyBxdeG7uSI6IkzDqiBUaHXhu7MgTGluaCIsIkNo4buvIGvDvSBUaOG7pyBxdeG7uSI6IiIsIk5nw6B5IGhp4buHdSBs4buxYyI6IjEyLzIyLzIwMjUifSx7IlTDqm4gY8O0bmcgdHkgdmnhur90IHThuq90IjoiVy5TIiwiVMOqbiBjw7RuZyB0eSI6IkPDlE5HIFRZIEPhu5QgUEjhuqZOIFdPUktTTUFSVCIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE1MjQwMjA2IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IklOUyIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBD4buUIFBI4bqmTiBJTlNJREVSUyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgWMOzbSBDaGnhur91LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzEzNTIyODA4IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTmd1eeG7hW4gVGjhu4sgTmhhbmgiLCJDaOG7ryBrw70gS+G6vyB0b8OhbiB0csaw4bufbmciOiIiLCJFbWFpbCBUaOG7pyBxdeG7uSI6ImxpbmgubGVAdGwtYy5jb20udm4iLCJUaOG7pyBxdeG7uSI6IkzDqiBUaHXhu7MgTGluaCIsIkNo4buvIGvDvSBUaOG7pyBxdeG7uSI6IiIsIk5nw6B5IGhp4buHdSBs4buxYyI6IjEyLzIyLzIwMjUifSx7IlTDqm4gY8O0bmcgdHkgdmnhur90IHThuq90IjoiRVZfS1RUXzIwNU5UUCIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIEVHRyBWRU5UVVJFUyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE0NDk0MDYwIiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IlJJT1QiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgVFLDgUNIIE5ISeG7hk0gSOG7rlUgSOG6oE4gROG7ikNIIFbhu6QgUklPVCBHQU1FUyIsIsSQ4buLYSBjaOG7iSI6IlThuqduZyAxMSwgVMOyYSBuaMOgIE1pc3Mgw6FvIETDoGksIHPhu5EgMjEgxJDGsOG7nW5nIE5ndXnhu4VuLCBQaMaw4budbmcgQuG6v24gTmdow6kgLCBRdeG6rW4gMSAsIFRQIEjhu5MgQ2jDrSBNaW5oIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNDQxOTA3MCIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoibGluaC5sZUB0bC1jLmNvbS52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiUGjhuqFtIEtpw6puIFPGoW4iLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In1dfQ==");;

        // IMPORTANT: Replace this with your actual Google Apps Script Web App URL
        // Instructions:
        // 1. Go to script.google.com and create a new project.
        // 2. Copy the Apps Script code provided below into Code.gs.
        // 3. Save the project.
        // 4. Click "Deploy" -> "New deployment".
        // 5. Select "Web app" as the type.
        // 6. Set "Execute as" to "Me" (your Google account).
        // 7. Set "Who has access" to "Anyone".
        // 8. Click "Deploy".
        // 9. Copy the "Web app URL" and paste it here.
        // 10. Ensure your Google account has permissions to send emails via Gmail (usually default).
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyA2NFLA4uIcNwwQBlM4g5qOOlFcP19NX11CggNOt_OZg5HA5yd_Sg1kKchVF9GLYyt/exec';

        // Initialize email mappings based on provided exact emails and company data
        const employeeEmailMap = {
            "L√™ Ng√¢n Anh": "anh.le@mediainsider.vn",
            "Nguy·ªÖn VƒÉn Chinh": "chinh.nguyen@mediainsider.vn",
            "L√™ Th√πy Linh": "linh.le@tl-c.com.vn",
            "Nguy·ªÖn L·ª±c": "hieuluc.nguyen@gmail.com"
        };

        const approverEmailMap = {
            "L√™ Ng√¢n Anh": "anh.le@mediainsider.vn",
            "Nguy·ªÖn VƒÉn Chinh": "chinh.nguyen@mediainsider.vn",
            "L√™ Th√πy Linh": "linh.le@tl-c.com.vn",
            "Nguy·ªÖn L·ª±c": "hieuluc.nguyen@gmail.com"
        };

        // Augment employeeEmailMap and approverEmailMap with emails from companies_data
        data.companies_data.forEach(company => {
            if (company["ƒê·∫°i di·ªán ph√°p lu·∫≠t"] && company["Email ƒê·∫°i di·ªán ph√°p lu·∫≠t"]) {
                employeeEmailMap[company["ƒê·∫°i di·ªán ph√°p lu·∫≠t"]] = company["Email ƒê·∫°i di·ªán ph√°p lu·∫≠t"];
                approverEmailMap[company["ƒê·∫°i di·ªán ph√°p lu·∫≠t"]] = company["Email ƒê·∫°i di·ªán ph√°p lu·∫≠t"];
            }
            if (company["K·∫ø to√°n tr∆∞·ªüng"] && company["Email K·∫ø to√°n tr∆∞·ªüng"]) {
                employeeEmailMap[company["K·∫ø to√°n tr∆∞·ªüng"]] = company["Email K·∫ø to√°n tr∆∞·ªüng"];
                approverEmailMap[company["K·∫ø to√°n tr∆∞·ªüng"]] = company["Email K·∫ø to√°n tr∆∞·ªüng"];
            }
            if (company["Th·ªß qu·ªπ"] && company["Email Th·ªß qu·ªπ"]) {
                employeeEmailMap[company["Th·ªß qu·ªπ"]] = company["Email Th·ªß qu·ªπ"];
                // Th·ªß qu·ªπ might not always be an approver, but including for completeness if they are in approver_names
                approverEmailMap[company["Th·ªß qu·ªπ"]] = company["Email Th·ªß qu·ªπ"];
            }
        });

        // Add employee departments (assuming this data exists or can be derived)
        // For demonstration, creating a simple map. In a real app, this would come from backend.
        data.employee_departments = {};
        data.employee_names.forEach(name => {
            if (name === "L√™ Ng√¢n Anh") data.employee_departments[name] = "Ban Gi√°m ƒë·ªëc";
            else if (name === "Nguy·ªÖn VƒÉn Chinh") data.employee_departments[name] = "Ph√≤ng Kinh doanh";
            else if (name === "L√™ Th√πy Linh") data.employee_departments[name] = "Ph√≤ng K·∫ø to√°n";
            else if (name === "Nguy·ªÖn L·ª±c") data.employee_departments[name] = "Ph√≤ng K·ªπ thu·∫≠t";
            else if (name === "Nguy·ªÖn Th·ªã Nhanh") data.employee_departments[name] = "Ph√≤ng K·∫ø to√°n";
            else data.employee_departments[name] = "Ph√≤ng ban kh√°c";
        });


        let expenseItems = [];
        let approvalHistory = [];
        let autoSaveTimeout = null;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const AUTO_SAVE_DELAY = 2000; // 2 seconds
        let currentStep = 1; // Current step in the stepper
        let highestStepReached = 1; // Track the highest step user has reached
        let editingFromReview = false; // Flag to know if user is editing from review step

        // Toast Notification Functions
        function showToast(message, type = 'info', title = '') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Confirmation Dialog Functions
        function showConfirmation(message, title = 'X√°c nh·∫≠n') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmation-overlay');
                const titleEl = document.getElementById('confirmation-title');
                const messageEl = document.getElementById('confirmation-message');
                const confirmBtn = document.getElementById('confirmation-confirm');
                const cancelBtn = document.getElementById('confirmation-cancel');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.classList.add('show');
                
                const handleConfirm = () => {
                    overlay.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    overlay.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        // Validation Functions
        function validateField(fieldId, value, fieldName) {
            const field = document.getElementById(fieldId);
            const errorEl = field.parentElement.querySelector('.error-message');
            
            if (!field) return true;
            
            let isValid = true;
            let errorMessage = '';
            
            // Required field validation
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = `${fieldName} l√† b·∫Øt bu·ªôc`;
            }
            
            // Specific validations
            if (value) {
                if (fieldId === 'payee-name' && value.length < 2) {
                    isValid = false;
                    errorMessage = 'T√™n ng∆∞·ªùi n·ªôp/nh·∫≠n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±';
                }
                if (fieldId === 'reason' && value.length < 10) {
                    isValid = false;
                    errorMessage = 'L√Ω do ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±';
                }
            }
            
            // Update UI
            if (isValid) {
                field.classList.remove('invalid');
                field.classList.add('valid');
                if (errorEl) {
                    errorEl.classList.remove('show');
                }
            } else {
                field.classList.remove('valid');
                field.classList.add('invalid');
                if (errorEl) {
                    errorEl.textContent = errorMessage;
                    errorEl.classList.add('show');
                } else {
                    const newErrorEl = document.createElement('div');
                    newErrorEl.className = 'error-message show';
                    newErrorEl.textContent = errorMessage;
                    field.parentElement.appendChild(newErrorEl);
                }
            }
            
            return isValid;
        }

        function validateAllFields() {
            const fields = [
                { id: 'company', name: 'C√¥ng ty' },
                { id: 'voucher-type', name: 'Lo·∫°i phi·∫øu' },
                { id: 'employee', name: 'Ng∆∞·ªùi ƒë·ªÅ ngh·ªã' },
                { id: 'payee-name', name: 'Ng∆∞·ªùi n·ªôp/nh·∫≠n' },
                { id: 'currency', name: 'Lo·∫°i ti·ªÅn' },
                { id: 'reason', name: 'L√Ω do' }
            ];
            
            let isValid = true;
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!validateField(field.id, element ? element.value : '', field.name)) {
                    isValid = false;
                }
            });
            
            // Validate expense items
            if (expenseItems.length === 0) {
                showToast('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt d√≤ng chi ti·∫øt', 'error');
                isValid = false;
            } else {
                const invalidItems = expenseItems.filter(item => !item.content || item.amount === 0);
                if (invalidItems.length > 0) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß N·ªôi dung v√† S·ªë ti·ªÅn cho t·∫•t c·∫£ c√°c d√≤ng', 'error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Auto-save Functions
        function saveToLocalStorage() {
            try {
                const formData = {
                    company: document.getElementById('company').value,
                    voucherType: document.getElementById('voucher-type').value,
                    employee: document.getElementById('employee').value,
                    payeeName: document.getElementById('payee-name').value,
                    currency: document.getElementById('currency').value,
                    reason: document.getElementById('reason').value,
                    voucherDate: getCurrentVoucherDate(), // Always use current system date
                    voucherNumber: document.getElementById('voucher-number').value,
                    approver: document.getElementById('approver').value,
                    expenseItems: expenseItems.map(item => ({
                        content: item.content,
                        amount: item.amount,
                        attachments: item.attachments.map(f => ({ name: f.name, size: f.size }))
                    })),
                    approvalHistory: approvalHistory,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('voucher_draft', JSON.stringify(formData));
                showAutoSaveIndicator('saved');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('voucher_draft');
                if (saved) {
                    const formData = JSON.parse(saved);
                    
                    // Restore form fields
                    if (formData.company) document.getElementById('company').value = formData.company;
                    if (formData.voucherType) {
                        document.getElementById('voucher-type').value = formData.voucherType;
                        updateVoucherTitle(); // Update title when loading saved data
                    }
                    if (formData.employee) {
                        document.getElementById('employee').value = formData.employee;
                        updateEmployeeDepartment();
                    }
                    if (formData.payeeName) document.getElementById('payee-name').value = formData.payeeName;
                    if (formData.currency) document.getElementById('currency').value = formData.currency;
                    if (formData.reason) document.getElementById('reason').value = formData.reason;
                    // Don't restore voucherDate from localStorage - always use current date
                    // This prevents back date submission
                    // if (formData.voucherDate) document.getElementById('voucher-date').value = formData.voucherDate;
                    if (formData.voucherNumber) document.getElementById('voucher-number').value = formData.voucherNumber;
                    if (formData.approver) document.getElementById('approver').value = formData.approver;
                    
                    // Restore expense items (without file objects)
                    if (formData.expenseItems && formData.expenseItems.length > 0) {
                        expenseItems = formData.expenseItems.map(item => ({
                            content: item.content,
                            amount: item.amount,
                            attachments: [] // Files can't be restored from localStorage
                        }));
                        renderExpenseTable();
                    }
                    
                    if (formData.approvalHistory) {
                        approvalHistory = formData.approvalHistory;
                        renderApprovalHistory();
                    }
                    
                    updateCompanyDetails();
                    updateGrandTotal();
                    
                    showToast('ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu ƒë√£ l∆∞u', 'info', 'Kh√¥i ph·ª•c');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        function showAutoSaveIndicator(status) {
            const indicator = document.getElementById('auto-save-indicator');
            indicator.className = `auto-save-indicator ${status} show`;
            
            if (status === 'saving') {
                indicator.textContent = 'ƒêang l∆∞u...';
            } else if (status === 'saved') {
                indicator.textContent = 'ƒê√£ l∆∞u t·ª± ƒë·ªông';
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function debounceAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            showAutoSaveIndicator('saving');
            autoSaveTimeout = setTimeout(() => {
                saveToLocalStorage();
            }, AUTO_SAVE_DELAY);
        }

        // File Validation
        function validateFile(file) {
            if (file.size > MAX_FILE_SIZE) {
                showToast(`File "${file.name}" qu√° l·ªõn. K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 10MB`, 'error');
                return false;
            }
            return true;
        }

        // Function to update voucher title based on voucher type
        function updateVoucherTitle() {
            const voucherType = document.getElementById('voucher-type').value;
            const titleElement = document.getElementById('form-title');
            
            if (voucherType === 'Thu') {
                titleElement.textContent = 'PHI·∫æU THU';
            } else if (voucherType === 'Chi') {
                titleElement.textContent = 'PHI·∫æU CHI';
            } else {
                titleElement.textContent = 'PHI·∫æU THU/CHI';
            }
        }
        
        // Step Navigation Functions
        function validateStep(step) {
            switch(step) {
                case 1:
                    const company = document.getElementById('company').value;
                    const voucherType = document.getElementById('voucher-type').value;
                    const employee = document.getElementById('employee').value;
                    return company && voucherType && employee;
                case 2:
                    const payeeName = document.getElementById('payee-name').value;
                    const reason = document.getElementById('reason').value;
                    return payeeName && reason;
                case 3:
                    const currency = document.getElementById('currency').value;
                    return currency && expenseItems.length > 0 && 
                           expenseItems.every(item => item.content && item.amount > 0);
                case 4:
                    const approver = document.getElementById('approver').value;
                    return approver;
                case 5:
                    return true; // Review step, no validation needed
                default:
                    return false;
            }
        }
        
        function goToStep(step) {
            // Validate current step before moving (only if moving forward and not editing from review)
            if (step > currentStep && !editingFromReview && !validateStep(currentStep)) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ·ªü b∆∞·ªõc hi·ªán t·∫°i', 'error', 'Thi·∫øu th√¥ng tin');
                return;
            }
            
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            // Show target step
            const targetStep = document.getElementById(`step-${step}`);
            if (targetStep) {
                targetStep.classList.add('active');
                currentStep = step;
                
                // Update highest step reached
                if (step > highestStepReached) {
                    highestStepReached = step;
                }
                
                updateStepperProgress();
                
                // Update review section if on step 5
                if (step === 5) {
                    updateReviewSection();
                    editingFromReview = false; // Reset flag when reaching review step
                }
                
                // Scroll to top of form
                document.getElementById('voucher-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function editStepFromReview(stepToEdit) {
            // Set flag to indicate we're editing from review
            editingFromReview = true;
            
            // Go to the step to edit
            goToStep(stepToEdit);
            
            showToast(`ƒê√£ chuy·ªÉn ƒë·∫øn b∆∞·ªõc ${stepToEdit} ƒë·ªÉ ch·ªânh s·ª≠a`, 'info', 'Ch·ªânh s·ª≠a');
        }
        
        function goToStepAfterEdit(nextStep) {
            // If editing from review, go back to review step (5) after editing
            if (editingFromReview) {
                // Validate current step first
                if (!validateStep(currentStep)) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ·ªü b∆∞·ªõc hi·ªán t·∫°i', 'error', 'Thi·∫øu th√¥ng tin');
                    return;
                }
                
                // Validate signature if leaving step 2
                if (currentStep === 2 && !validateSignature()) {
                    showToast('Vui l√≤ng t·∫£i l√™n ch·ªØ k√Ω', 'error', 'Thi·∫øu ch·ªØ k√Ω');
                    return;
                }
                
                // Go back to review step
                editingFromReview = false;
                goToStep(5);
            } else {
                // Validate signature if leaving step 2
                if (currentStep === 2 && nextStep > 2 && !validateSignature()) {
                    showToast('Vui l√≤ng t·∫£i l√™n ch·ªØ k√Ω', 'error', 'Thi·∫øu ch·ªØ k√Ω');
                    return;
                }
                
                // Normal flow - go to next step
                goToStep(nextStep);
            }
        }
        
        function updateStepperProgress() {
            // Update stepper visual state
            const steps = document.querySelectorAll('.stepper-step');
            const progressLine = document.getElementById('stepper-progress');
            
            steps.forEach((stepEl, index) => {
                const stepNum = index + 1;
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    stepEl.classList.add('completed');
                } else if (stepNum === currentStep) {
                    stepEl.classList.add('active');
                }
            });
            
            // Update progress line
            if (progressLine) {
                const progress = ((currentStep - 1) / (steps.length - 1)) * 100;
                progressLine.style.width = `${progress}%`;
            }
        }
        
        function updateReviewSection() {
            // Update review section with current form values
            // Helper function to safely set text content
            const safeSetText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || '-';
                } else {
                    console.warn(`Element with id "${id}" not found`);
                }
            };
            
            const companySelect = document.getElementById('company');
            const companyValue = companySelect ? companySelect.value : '';
            safeSetText('review-company', companyValue);
            
            const voucherTypeSelect = document.getElementById('voucher-type');
            const voucherTypeValue = voucherTypeSelect ? voucherTypeSelect.value : '';
            safeSetText('review-type', voucherTypeValue);
            
            const voucherNumber = document.getElementById('voucher-number');
            safeSetText('review-number', voucherNumber ? voucherNumber.value : '');
            
            // Display voucher date from form input (user selected date)
            const voucherDateInput = document.getElementById('voucher-date');
            let reviewDateText = '-';
            if (voucherDateInput && voucherDateInput.value) {
                const selectedDate = new Date(voucherDateInput.value);
                const formattedDate = selectedDate.toLocaleDateString('vi-VN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                reviewDateText = formattedDate;
            } else {
                // Fallback to current date if no date selected
                const now = new Date();
                const formattedDate = now.toLocaleDateString('vi-VN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                reviewDateText = formattedDate;
            }
            safeSetText('review-date', reviewDateText);
            
            const employee = document.getElementById('employee');
            safeSetText('review-employee', employee ? employee.value : '');
            
            const department = document.getElementById('department');
            safeSetText('review-department', department ? department.value : '');
            
            const payeeName = document.getElementById('payee-name');
            safeSetText('review-payee', payeeName ? payeeName.value : '');
            
            // Update signature in review
            const reviewSignature = document.getElementById('review-signature');
            const reviewSignaturePlaceholder = document.getElementById('review-signature-placeholder');
            if (currentSignatureData) {
                reviewSignature.src = currentSignatureData;
                reviewSignature.style.display = 'block';
                reviewSignaturePlaceholder.style.display = 'none';
            } else {
                reviewSignature.style.display = 'none';
                reviewSignaturePlaceholder.style.display = 'block';
            }
            
            const reason = document.getElementById('reason');
            safeSetText('review-reason', reason ? reason.value : '');
            
            const amount = document.getElementById('amount');
            safeSetText('review-amount', amount ? amount.value : '');
            
            const amountInWordsInput = document.getElementById('amount-in-words');
            const amountInWordsDisplay = document.getElementById('amount-in-words-display');
            const amountInWords = (amountInWordsInput && amountInWordsInput.value) || 
                                  (amountInWordsDisplay ? amountInWordsDisplay.textContent : '');
            safeSetText('review-amount-words', amountInWords);
            
            const approverValue = document.getElementById('approver').value || '-';
            const reviewApproverDisplay = document.getElementById('review-approver-display');
            if (reviewApproverDisplay) {
                reviewApproverDisplay.textContent = approverValue;
            }
            // Note: review-approver element doesn't exist, only review-approver-display exists
            
            // Update status
            const statusDisplay = document.getElementById('approval-status-display');
            const statusText = statusDisplay ? statusDisplay.textContent : 'Pending';
            const reviewStatus = document.getElementById('review-status');
            if (reviewStatus) {
                reviewStatus.textContent = statusText;
            }
            
            // Update expense items table
            // First, try to get data from DOM (expense table) to ensure we have the latest data
            const expenseTableBody = document.getElementById('expense-table-body');
            let currentExpenseItems = expenseItems; // Use global expenseItems as default
            
            // If expense table exists, try to extract data from it
            if (expenseTableBody && expenseTableBody.rows.length > 0) {
                currentExpenseItems = [];
                Array.from(expenseTableBody.rows).forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length >= 3) {
                        const contentInput = cells[1].querySelector('input');
                        const amountInput = cells[2].querySelector('input');
                        const content = contentInput ? contentInput.value.trim() : '';
                        const amount = amountInput ? parseCurrency(amountInput.value) : 0;
                        
                        // Get attachments from the row's expenseItems entry if available
                        const attachments = (expenseItems[index] && expenseItems[index].attachments) 
                            ? expenseItems[index].attachments 
                            : [];
                        
                        if (content || amount > 0) {
                            currentExpenseItems.push({
                                content: content,
                                amount: amount,
                                attachments: attachments
                            });
                        }
                    }
                });
            }
            
            const reviewTableBody = document.getElementById('review-expense-items');
            if (reviewTableBody) {
                console.log('=== updateReviewSection: expenseItems ===', currentExpenseItems);
                console.log('expenseItems length:', currentExpenseItems ? currentExpenseItems.length : 0);
                
                if (!currentExpenseItems || currentExpenseItems.length === 0) {
                    reviewTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                        </tr>
                    `;
                } else {
                    const tableRows = currentExpenseItems.map((item, index) => {
                        console.log(`Processing item ${index}:`, item);
                        
                        // Handle attachments - can be File objects or plain objects with name property
                        let attachmentsList = 'Kh√¥ng c√≥';
                        if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                            const fileNames = item.attachments.map(f => {
                                // Handle both File objects and plain objects
                                if (f instanceof File) {
                                    return f.name;
                                } else if (f && typeof f === 'object' && f.name) {
                                    return f.name;
                                }
                                return '';
                            }).filter(name => name); // Remove empty strings
                            
                            if (fileNames.length > 0) {
                                attachmentsList = fileNames.join(', ');
                            }
                        }
                        
                        const content = item.content || '-';
                        const amount = item.amount || 0;
                        const formattedAmount = formatCurrency(amount);
                        
                        console.log(`Item ${index} - Content: "${content}", Amount: ${amount}, Attachments: ${attachmentsList}`);
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary);">${index + 1}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary);">${escapeHtml(content)}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary); text-align: right; font-weight: 500;">${formattedAmount}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(attachmentsList)}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log('Generated table rows:', tableRows);
                    reviewTableBody.innerHTML = tableRows;
                }
            } else {
                console.error('review-expense-items element not found!');
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            generateVoucherNumber();
            renderExpenseTable();

            // Load saved data (but voucherDate will not be restored - always use current date)
            loadFromLocalStorage();
            
            // Load saved signature from localStorage
            loadSavedSignature();
            
            // Always set current date after loading saved data (to prevent back date)
            setCurrentDate();
            
            // Update title based on initial voucher type value
            updateVoucherTitle();
            
            // Initialize stepper
            updateStepperProgress();

            // Add event listeners for buttons
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('import-excel-btn').addEventListener('click', importFromExcelForm);
            // sync-sheets-btn removed - files now upload during sendForApproval
            document.getElementById('save-template-btn').addEventListener('click', saveTemplate);
            document.getElementById('load-template-btn').addEventListener('click', loadTemplate);
            document.getElementById('save-btn').addEventListener('click', saveVoucher);
            document.getElementById('send-approval-btn').addEventListener('click', sendForApproval);
            
            // Initialize searchable dropdowns
            initializeSearchableDropdowns();
            
            document.getElementById('add-row-btn').addEventListener('click', addExpenseRow);
            document.getElementById('copy-excel-btn').addEventListener('click', copyFromExcelToTable);
            document.getElementById('import-table-excel-btn').addEventListener('click', importExcelToTable);

            // Add real-time validation listeners
            const fieldsToValidate = ['company', 'voucher-type', 'employee', 'payee-name', 'currency', 'reason'];
            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const fieldNames = {
                            'company': 'C√¥ng ty',
                            'voucher-type': 'Lo·∫°i phi·∫øu',
                            'employee': 'Ng∆∞·ªùi ƒë·ªÅ ngh·ªã',
                            'payee-name': 'Ng∆∞·ªùi n·ªôp/nh·∫≠n',
                            'currency': 'Lo·∫°i ti·ªÅn',
                            'reason': 'L√Ω do'
                        };
                        validateField(fieldId, this.value, fieldNames[fieldId]);
                        debounceAutoSave();
                    });
                    
                    field.addEventListener('input', function() {
                        // Remove invalid class on input
                        if (this.classList.contains('invalid')) {
                            this.classList.remove('invalid');
                            const errorEl = this.parentElement.querySelector('.error-message');
                            if (errorEl) errorEl.classList.remove('show');
                        }
                        debounceAutoSave();
                    });
                }
            });

            renderApprovalHistory();
        });
        
        function initializeForm() {
            document.getElementById('form-title').textContent = data.form_title;
            
            const companySelect = document.getElementById('company');
            data.company_names.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            const employeeSelect = document.getElementById('employee');
            const payeeDropdown = document.getElementById('payee-dropdown');
            data.employee_names.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeSelect.appendChild(option);

                const payeeOption = option.cloneNode(true);
                payeeDropdown.appendChild(payeeOption);
            });
            
            const voucherTypeSelect = document.getElementById('voucher-type');
            data.voucher_types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                voucherTypeSelect.appendChild(option);
            });
            
            const currencySelect = document.getElementById('currency');
            data.currency_options.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                currencySelect.appendChild(option);
            });
            
            const approverSelect = document.getElementById('approver');
            data.approver_names.forEach(approver => {
                const option = document.createElement('option');
                option.value = approver;
                option.textContent = approver;
                approverSelect.appendChild(option);
            });
        }
        
        function updateCompanyDetails() {
            const companySelect = document.getElementById('company');
            const companyDetails = document.getElementById('company-details');
            const companyAddress = document.getElementById('company-address');
            
            const selectedCompany = companySelect.value;
            
            if (selectedCompany) {
                const companyData = data.companies_data.find(c => c["T√™n c√¥ng ty"] === selectedCompany);
                if (companyData) {
                    companyAddress.textContent = `ƒê·ªãa ch·ªâ: ${companyData["ƒê·ªãa ch·ªâ"]}`;
                    companyDetails.classList.add('show');
                }
            } else {
                companyDetails.classList.remove('show');
            }
        }

        function updateEmployeeDepartment() {
            const employeeSelect = document.getElementById('employee');
            const departmentInput = document.getElementById('department');
            const selectedEmployee = employeeSelect.value;

            if (selectedEmployee && data.employee_departments) {
                departmentInput.value = data.employee_departments[selectedEmployee] || '';
            } else {
                departmentInput.value = '';
            }
        }
        
        // Helper function to get current system date (YYYY-MM-DD format)
        // Uses local date, not UTC, to match Mac system date
        function getCurrentVoucherDate() {
            const today = new Date();
            // Use local date to match Mac system date, not UTC
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Helper function to convert File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // ============ SIGNATURE FUNCTIONS ============
        let currentSignatureData = null;
        const SIGNATURE_STORAGE_KEY = 'tlcg_user_signature';
        
        // Load saved signature on page load
        function loadSavedSignature() {
            const savedSignature = localStorage.getItem(SIGNATURE_STORAGE_KEY);
            if (savedSignature) {
                currentSignatureData = savedSignature;
                displaySignature(savedSignature);
                console.log('‚úÖ Loaded saved signature from localStorage');
            }
        }
        
        // Handle signature file upload
        async function handleSignatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh (PNG, JPG, GIF)', 'error');
                return;
            }
            
            // Validate file size (max 500KB)
            if (file.size > 500 * 1024) {
                showToast('K√≠ch th∆∞·ªõc ch·ªØ k√Ω t·ªëi ƒëa 500KB', 'error');
                return;
            }
            
            try {
                const base64Data = await fileToBase64(file);
                currentSignatureData = base64Data;
                
                // Save to localStorage for future use
                localStorage.setItem(SIGNATURE_STORAGE_KEY, base64Data);
                
                // Display the signature
                displaySignature(base64Data);
                
                showToast('ƒê√£ t·∫£i ch·ªØ k√Ω l√™n th√†nh c√¥ng! Ch·ªØ k√Ω s·∫Ω ƒë∆∞·ª£c l∆∞u cho c√°c phi·∫øu sau.', 'success');
                console.log('‚úÖ Signature uploaded and saved to localStorage');
            } catch (error) {
                console.error('Error uploading signature:', error);
                showToast('L·ªói khi t·∫£i ch·ªØ k√Ω. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }
        
        // Display signature in preview area
        function displaySignature(base64Data) {
            const preview = document.getElementById('signature-preview');
            const placeholder = document.getElementById('signature-placeholder');
            const clearBtn = document.getElementById('clear-signature-btn');
            const errorDiv = document.getElementById('signature-error');
            
            if (base64Data) {
                preview.src = base64Data;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                clearBtn.style.display = 'inline-flex';
                errorDiv.textContent = '';
            } else {
                preview.src = '';
                preview.style.display = 'none';
                placeholder.style.display = 'block';
                clearBtn.style.display = 'none';
            }
        }
        
        // Clear signature
        function clearSignature() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch·ªØ k√Ω? Ch·ªØ k√Ω ƒë√£ l∆∞u c≈©ng s·∫Ω b·ªã x√≥a.')) {
                currentSignatureData = null;
                localStorage.removeItem(SIGNATURE_STORAGE_KEY);
                displaySignature(null);
                document.getElementById('signature-upload').value = '';
                showToast('ƒê√£ x√≥a ch·ªØ k√Ω', 'info');
            }
        }
        
        // Validate signature before proceeding
        function validateSignature() {
            if (!currentSignatureData) {
                const errorDiv = document.getElementById('signature-error');
                errorDiv.textContent = 'Vui l√≤ng t·∫£i l√™n ch·ªØ k√Ω';
                return false;
            }
            return true;
        }
        
        // Get signature data for submission
        function getSignatureData() {
            return currentSignatureData;
        }
        // ============ END SIGNATURE FUNCTIONS ============
        
        function setCurrentDate() {
            const formattedDate = getCurrentVoucherDate();
            const voucherDateInput = document.getElementById('voucher-date');
            if (voucherDateInput) {
                // Set min date to today (prevent back date selection)
                voucherDateInput.setAttribute('min', formattedDate);
                // Set value to today (current system date) as default
                voucherDateInput.value = formattedDate;
                // Remove readonly to allow user to select date (but only from today onwards)
                voucherDateInput.removeAttribute('readonly');
                // Remove disabled style
                voucherDateInput.style.backgroundColor = '';
                voucherDateInput.style.cursor = '';
                
                // Add validation on change to ensure date is not in the past
                voucherDateInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    selectedDate.setHours(0, 0, 0, 0);
                    
                    if (selectedDate < today) {
                        alert('Ng√†y l·∫≠p phi·∫øu kh√¥ng ƒë∆∞·ª£c l√† ng√†y qu√° kh·ª©. Vui l√≤ng ch·ªçn ng√†y hi·ªán t·∫°i tr·ªü ƒëi.');
                        this.value = formattedDate; // Reset to today
                    }
                });
            }
        }
        
        function generateVoucherNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            const voucherNumber = `TL-${year}${month}-${randomNum}`;
            document.getElementById('voucher-number').value = voucherNumber;
        }
        
        function updateAmountInWords() {
            const amountInput = document.getElementById('amount');
            const amount = parseCurrency(amountInput.value) || 0;
            const amountInWordsInput = document.getElementById('amount-in-words');
            const amountInWordsDisplay = document.getElementById('amount-in-words-display');
            
            const amountInWords = amount > 0 ? convertNumberToWords(amount) + " ƒë·ªìng" : "";
            
            if (amountInWordsInput) {
                amountInWordsInput.value = amountInWords;
            }
            if (amountInWordsDisplay) {
                amountInWordsDisplay.textContent = amountInWords || "Kh√¥ng ƒë·ªìng";
            }
        }
        
        function convertNumberToWords(num) {
            const units = ['', 'm·ªôt', 'hai', 'ba', 'b·ªën', 'nƒÉm', 's√°u', 'b·∫£y', 't√°m', 'ch√≠n'];
            const teens = ['m∆∞·ªùi', 'm∆∞·ªùi m·ªôt', 'm∆∞·ªùi hai', 'm∆∞·ªùi ba', 'm∆∞·ªùi b·ªën', 'm∆∞·ªùi lƒÉm', 'm∆∞·ªùi s√°u', 'm∆∞·ªùi b·∫£y', 'm∆∞·ªùi t√°m', 'm∆∞·ªùi ch√≠n'];
            const tens = ['', 'm∆∞·ªùi', 'hai m∆∞∆°i', 'ba m∆∞∆°i', 'b·ªën m∆∞∆°i', 'nƒÉm m∆∞∆°i', 's√°u m∆∞∆°i', 'b·∫£y m∆∞∆°i', 't√°m m∆∞∆°i', 'ch√≠n m∆∞∆°i'];
            const scales = ['', 'ngh√¨n', 'tri·ªáu', 't·ª∑'];

            function convertLessThanOneThousand(n) {
                let s = '';
                if (n >= 100) {
                    s += units[Math.floor(n / 100)] + ' trƒÉm ';
                    n %= 100;
                }
                if (n >= 20) {
                    s += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                }
                if (n >= 10) {
                    s += teens[n - 10] + ' ';
                    n = 0;
                }
                if (n > 0) {
                    s += units[n] + ' ';
                }
                return s.trim();
            }

            if (num === 0) return 'Kh√¥ng';

            let result = '';
            let i = 0;
            let tempNum = num;

            while (tempNum > 0) {
                const chunk = tempNum % 1000;
                if (chunk !== 0) {
                    let chunkWords = convertLessThanOneThousand(chunk);
                    result = chunkWords + ' ' + scales[i] + ' ' + result;
                }
                tempNum = Math.floor(tempNum / 1000);
                i++;
            }
            return result.trim().replace(/\s+/g, ' ').replace(/m∆∞∆°i m·ªôt/g, 'm∆∞∆°i m·ªët').replace(/m∆∞∆°i nƒÉm/g, 'm∆∞∆°i lƒÉm').replace(/m·ªôt trƒÉm/g, 'm·ªôt trƒÉm').replace(/linh m·ªôt/g, 'l·∫ª m·ªôt').replace(/linh nƒÉm/g, 'l·∫ª nƒÉm');
        }
        
        function exportToPDF() {
            const element = document.getElementById('voucher-form');
            const opt = {
                margin: 10,
                filename: 'phieu_chi_thu.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showToast('ƒê√£ xu·∫•t PDF th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
        }
        
        function exportToExcel() {
            try {
                // Validate form before export
                if (!validateAllFields()) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi xu·∫•t Excel', 'error', 'L·ªói validation');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Form Data
                const formData = [
                    ['PHI·∫æU THU/CHI - TH√îNG TIN CH√çNH'],
                    [],
                    ['C√¥ng ty', document.getElementById('company').value],
                    ['Lo·∫°i phi·∫øu', document.getElementById('voucher-type').value],
                    ['S·ªë phi·∫øu', document.getElementById('voucher-number').value],
                    ['Ng√†y l·∫≠p phi·∫øu', getCurrentVoucherDate()], // Always use current system date
                    ['Ng∆∞·ªùi ƒë·ªÅ ngh·ªã', document.getElementById('employee').value],
                    ['B·ªô ph·∫≠n', document.getElementById('department').value],
                    ['Ng∆∞·ªùi n·ªôp/nh·∫≠n', document.getElementById('payee-name').value],
                    ['Lo·∫°i ti·ªÅn', document.getElementById('currency').value],
                    ['T·ªïng s·ªë ti·ªÅn', document.getElementById('amount').value],
                    ['S·ªë ti·ªÅn b·∫±ng ch·ªØ', document.getElementById('amount-in-words').value],
                    ['L√Ω do', document.getElementById('reason').value],
                    ['Ng∆∞·ªùi ph√™ duy·ªát', document.getElementById('approver').value],
                    ['Tr·∫°ng th√°i', document.getElementById('approval-status-display').textContent]
                ];
                
                const ws1 = XLSX.utils.aoa_to_sheet(formData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Th√¥ng tin phi·∫øu');
                
                // Sheet 2: Expense Items
                const expenseData = [
                    ['STT', 'N·ªôi dung', 'S·ªë ti·ªÅn', 'S·ªë file ƒë√≠nh k√®m']
                ];
                
                expenseItems.forEach((item, index) => {
                    expenseData.push([
                        index + 1,
                        item.content || '',
                        item.amount || 0,
                        item.attachments ? item.attachments.length : 0
                    ]);
                });
                
                // Add total row
                const grandTotal = expenseItems.reduce((sum, item) => sum + (item.amount || 0), 0);
                expenseData.push(['', 'T·ªîNG C·ªòNG', grandTotal, '']);
                
                const ws2 = XLSX.utils.aoa_to_sheet(expenseData);
                
                // Set column widths
                ws2['!cols'] = [
                    { wch: 5 },   // STT
                    { wch: 40 },  // N·ªôi dung
                    { wch: 15 },  // S·ªë ti·ªÅn
                    { wch: 15 }   // S·ªë file ƒë√≠nh k√®m
                ];
                
                XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt chi ph√≠');
                
                // Sheet 3: Approval History
                const historyData = [
                    ['Th·ªùi gian', 'H√†nh ƒë·ªông', 'Ng∆∞·ªùi th·ª±c hi·ªán', 'G·ª≠i ƒë·∫øn']
                ];
                
                if (approvalHistory.length > 0) {
                    approvalHistory.forEach(entry => {
                        historyData.push([
                            entry.timestamp || '',
                            entry.action || '',
                            entry.by || '',
                            entry.to || ''
                        ]);
                    });
                } else {
                    historyData.push(['Ch∆∞a c√≥ l·ªãch s·ª≠ ph√™ duy·ªát']);
                }
                
                const ws3 = XLSX.utils.aoa_to_sheet(historyData);
                XLSX.utils.book_append_sheet(wb, ws3, 'L·ªãch s·ª≠ ph√™ duy·ªát');
                
                // Generate filename with date
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
                const voucherNumber = document.getElementById('voucher-number').value.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `Phieu_Thu_Chi_${voucherNumber}_${dateStr}.xlsx`;
                
                // Export file
                XLSX.writeFile(wb, filename);
                showToast('ƒê√£ xu·∫•t Excel th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi xu·∫•t Excel: ' + error.message, 'error', 'L·ªói');
            }
        }
        
        function importFromExcelForm() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length > 0) {
                        const row = jsonData[0];
                        if (row.company) document.getElementById('company').value = row.company;
                        if (row.employee) document.getElementById('employee').value = row.employee;
                        if (row.payeeName) document.getElementById('payee-name').value = row.payeeName;
                        if (row.reason) document.getElementById('reason').value = row.reason;
                        if (row.approver) document.getElementById('approver').value = row.approver;
                        
                        updateCompanyDetails();
                        updateEmployeeDepartment();
                        updateGrandTotal(); 
                        debounceAutoSave();
                        showToast('ƒê√£ nh·∫≠p d·ªØ li·ªáu t·ª´ Excel v√†o form ch√≠nh th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            input.click();
        }
        
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            spreadsheetId: localStorage.getItem('google_sheets_id') || '',
            sheetName: 'Phi·∫øu Thu Chi',
            apiKey: ''
        };

        // Load saved spreadsheet ID
        if (GOOGLE_SHEETS_CONFIG.spreadsheetId) {
            console.log('Loaded saved Spreadsheet ID:', GOOGLE_SHEETS_CONFIG.spreadsheetId);
        }

        async function syncWithGoogleSheets() {
            try {
                if (!validateAllFields()) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi ƒë·ªìng b·ªô', 'error', 'L·ªói validation');
                    return;
                }

                // Check Google Apps Script URL
                if (!GOOGLE_APPS_SCRIPT_WEB_APP_URL || GOOGLE_APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    const setupUrl = confirm('Ch∆∞a c·∫•u h√¨nh Google Apps Script URL.\n\nB·∫°n c√≥ mu·ªën xem h∆∞·ªõng d·∫´n setup kh√¥ng?');
                    if (setupUrl) {
                        showToast('Vui l√≤ng xem file GOOGLE_APPS_SCRIPT_SETUP.md ƒë·ªÉ bi·∫øt c√°ch c·∫•u h√¨nh', 'info', 'H∆∞·ªõng d·∫´n');
                    }
                    showToast('ƒêang xu·∫•t Excel ƒë·ªÉ b·∫°n c√≥ th·ªÉ import th·ªß c√¥ng...', 'warning', 'C·∫£nh b√°o');
                    exportToExcel();
                    return;
                }

                // Get or prompt for Spreadsheet ID
                if (!GOOGLE_SHEETS_CONFIG.spreadsheetId) {
                    const spreadsheetId = prompt(
                        'Vui l√≤ng nh·∫≠p Google Sheets ID:\n\n' +
                        'C√≥ th·ªÉ l·∫•y t·ª´ URL c·ªßa sheet:\n' +
                        'https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit\n\n' +
                        'L∆∞u √Ω: Sheet ph·∫£i ƒë∆∞·ª£c share v·ªõi email Google Apps Script c·ªßa b·∫°n!'
                    );
                    
                    if (!spreadsheetId || spreadsheetId.trim() === '') {
                        showToast('C·∫ßn Google Sheets ID ƒë·ªÉ ƒë·ªìng b·ªô', 'error', 'L·ªói c·∫•u h√¨nh');
                        return;
                    }
                    
                    GOOGLE_SHEETS_CONFIG.spreadsheetId = spreadsheetId.trim();
                    localStorage.setItem('google_sheets_id', GOOGLE_SHEETS_CONFIG.spreadsheetId);
                    showToast('ƒê√£ l∆∞u Spreadsheet ID', 'success');
                }

                // Show loading
                const syncBtn = document.getElementById('sync-sheets-btn');
                const originalText = syncBtn.innerHTML;
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> ƒêang ƒë·ªìng b·ªô...';

                // Collect files for upload to Drive
                const filesToUpload = [];
                for (let i = 0; i < expenseItems.length; i++) {
                    const item = expenseItems[i];
                    if (item.attachments && item.attachments.length > 0) {
                        for (const file of item.attachments) {
                            if (file instanceof File) {
                                try {
                                    // Convert file to base64
                                    const base64Data = await fileToBase64(file);
                                    filesToUpload.push({
                                        fileName: file.name,
                                        fileData: base64Data,
                                        mimeType: file.type,
                                        fileSize: file.size,
                                        rowIndex: i
                                    });
                                } catch (err) {
                                    console.error('Error converting file to base64:', file.name, err);
                                }
                            }
                        }
                    }
                }

                // Log file information for verification
                console.log('=== FILE UPLOAD INFO ===');
                console.log('Total expense items:', expenseItems.length);
                console.log('Files to upload:', filesToUpload.length);
                if (filesToUpload.length > 0) {
                    console.log('Files details:');
                    filesToUpload.forEach((f, idx) => {
                        const sizeMB = (f.fileSize / (1024 * 1024)).toFixed(2);
                        console.log(`  ${idx + 1}. Row ${f.rowIndex}: ${f.fileName} (${sizeMB} MB, ${f.mimeType})`);
                    });
                } else {
                    console.log('No files attached');
                }

                const voucherData = {
                    timestamp: new Date().toISOString(),
                    voucherNumber: document.getElementById('voucher-number').value,
                    voucherType: document.getElementById('voucher-type').value,
                    voucherDate: getCurrentVoucherDate(), // Always use current system date
                    company: document.getElementById('company').value,
                    employee: document.getElementById('employee').value,
                    department: document.getElementById('department').value,
                    payeeName: document.getElementById('payee-name').value,
                    currency: document.getElementById('currency').value,
                    totalAmount: document.getElementById('amount').value,
                    amountInWords: document.getElementById('amount-in-words').value,
                    reason: document.getElementById('reason').value,
                    approver: document.getElementById('approver').value,
                    status: document.getElementById('approval-status-display').textContent,
                    expenseItems: expenseItems.map((item, index) => ({
                        stt: index + 1,
                        content: item.content,
                        amount: item.amount,
                        attachments: item.attachments.length,
                        attachmentNames: item.attachments.map(f => f instanceof File ? f.name : f.name || 'Unknown').join(', ')
                    })),
                    approvalHistory: approvalHistory,
                    files: filesToUpload  // Send files for Drive upload
                };

                console.log('=== VOUCHER DATA TO SYNC ===');
                console.log('Voucher Number:', voucherData.voucherNumber);
                console.log('Expense Items:', voucherData.expenseItems);
                console.log('Files Info:', voucherData.filesInfo);

                // Retry logic
                let retries = 3;
                let success = false;
                
                while (retries > 0 && !success) {
                    try {
                        // Use a timeout to detect if request hangs
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                        await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'syncToSheets',
                                spreadsheetId: GOOGLE_SHEETS_CONFIG.spreadsheetId,
                                sheetName: GOOGLE_SHEETS_CONFIG.sheetName,
                                data: voucherData
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        success = true;
                        
                        // Store files info for later use in approval email
                        window.lastSyncedVoucherFiles = {
                            voucherNumber: voucherData.voucherNumber,
                            files: filesToUpload
                        };
                        
                        showToast('ƒê√£ ƒë·ªìng b·ªô v·ªõi Google Sheets th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
                        
                        // Update status in approval history
                        const now = new Date();
                        const timestamp = now.toLocaleString('vi-VN');
                        approvalHistory.push({
                            timestamp: timestamp,
                            action: 'ƒê·ªìng b·ªô v·ªõi Google Sheets',
                            by: document.getElementById('employee').value,
                            to: 'Google Sheets'
                        });
                        renderApprovalHistory();
                        
                    } catch (error) {
                        retries--;
                        if (retries > 0) {
                            console.log(`Sync failed, retrying... (${retries} attempts left)`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s before retry
                } else {
                            throw error;
                        }
                    }
                }

                if (!success) {
                    throw new Error('Kh√¥ng th·ªÉ ƒë·ªìng b·ªô sau nhi·ªÅu l·∫ßn th·ª≠');
                }

            } catch (error) {
                console.error('Error syncing with Google Sheets:', error);
                
                let errorMessage = 'C√≥ l·ªói x·∫£y ra khi ƒë·ªìng b·ªô';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast(errorMessage + '\nƒêang xu·∫•t Excel ƒë·ªÉ b·∫°n c√≥ th·ªÉ import th·ªß c√¥ng...', 'error', 'L·ªói');
                
                // Fallback: Export Excel
                setTimeout(() => {
                    exportToExcel();
                    showToast('ƒê√£ xu·∫•t Excel. B·∫°n c√≥ th·ªÉ import v√†o Google Sheets th·ªß c√¥ng.', 'info', 'H∆∞·ªõng d·∫´n');
                }, 1000);
                
            } finally {
                // Restore button
                const syncBtn = document.getElementById('sync-sheets-btn');
                syncBtn.disabled = false;
                syncBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>\n                ƒê·ªìng b·ªô v·ªõi Google Sheets';
            }
        }

        // Function to change Spreadsheet ID
        function changeSpreadsheetId() {
            const currentId = GOOGLE_SHEETS_CONFIG.spreadsheetId || '(ch∆∞a c√≥)';
            const newId = prompt(
                'Spreadsheet ID hi·ªán t·∫°i: ' + currentId + '\n\n' +
                'Nh·∫≠p Spreadsheet ID m·ªõi (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ x√≥a):'
            );
            
            if (newId === null) return; // User cancelled
            
            if (newId.trim() === '') {
                GOOGLE_SHEETS_CONFIG.spreadsheetId = '';
                localStorage.removeItem('google_sheets_id');
                showToast('ƒê√£ x√≥a Spreadsheet ID', 'success');
            } else {
                GOOGLE_SHEETS_CONFIG.spreadsheetId = newId.trim();
                localStorage.setItem('google_sheets_id', GOOGLE_SHEETS_CONFIG.spreadsheetId);
                showToast('ƒê√£ c·∫≠p nh·∫≠t Spreadsheet ID', 'success');
            }
        }

        // Template Functions
        function saveTemplate() {
            if (!validateAllFields()) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi l∆∞u template', 'error', 'L·ªói validation');
                return;
            }

            const templateName = prompt('Nh·∫≠p t√™n template:');
            if (!templateName) return;

            const template = {
                name: templateName,
                company: document.getElementById('company').value,
                voucherType: document.getElementById('voucher-type').value,
                employee: document.getElementById('employee').value,
                payeeName: document.getElementById('payee-name').value,
                currency: document.getElementById('currency').value,
                reason: document.getElementById('reason').value,
                approver: document.getElementById('approver').value,
                expenseItems: expenseItems.map(item => ({
                    content: item.content,
                    amount: item.amount
                })),
                createdAt: new Date().toISOString()
            };

            const templates = JSON.parse(localStorage.getItem('voucher_templates') || '[]');
            templates.push(template);
            localStorage.setItem('voucher_templates', JSON.stringify(templates));
            
            showToast(`ƒê√£ l∆∞u template "${templateName}" th√†nh c√¥ng!`, 'success', 'Th√†nh c√¥ng');
        }

        function loadTemplate() {
            const templates = JSON.parse(localStorage.getItem('voucher_templates') || '[]');
            if (templates.length === 0) {
                showToast('Ch∆∞a c√≥ template n√†o ƒë∆∞·ª£c l∆∞u', 'info', 'Th√¥ng b√°o');
                return;
            }

            const templateNames = templates.map((t, i) => `${i + 1}. ${t.name} (${new Date(t.createdAt).toLocaleDateString('vi-VN')})`).join('\n');
            const choice = prompt(`Ch·ªçn template (nh·∫≠p s·ªë):\n${templateNames}`);
            const index = parseInt(choice) - 1;

            if (isNaN(index) || index < 0 || index >= templates.length) {
                showToast('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá', 'error', 'L·ªói');
                return;
            }

            const template = templates[index];
            document.getElementById('company').value = template.company || '';
            document.getElementById('voucher-type').value = template.voucherType || '';
            document.getElementById('employee').value = template.employee || '';
            if (template.employee) updateEmployeeDepartment();
            document.getElementById('payee-name').value = template.payeeName || '';
            document.getElementById('currency').value = template.currency || '';
            document.getElementById('reason').value = template.reason || '';
            document.getElementById('approver').value = template.approver || '';
            
            if (template.expenseItems && template.expenseItems.length > 0) {
                expenseItems = template.expenseItems.map(item => ({
                    content: item.content,
                    amount: item.amount,
                    attachments: []
                }));
                renderExpenseTable();
            }

            updateCompanyDetails();
            debounceAutoSave();
            showToast(`ƒê√£ load template "${template.name}"`, 'success', 'Th√†nh c√¥ng');
        }

        // Searchable Dropdown Functions
        function initializeSearchableDropdowns() {
            const searchableSelects = ['company', 'employee', 'approver', 'payee-dropdown'];
            searchableSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    makeSearchable(select);
                }
            });
        }

        function makeSearchable(selectElement) {
            const wrapper = document.createElement('div');
            wrapper.className = 'searchable-select';
            selectElement.parentNode.insertBefore(wrapper, selectElement);
            wrapper.appendChild(selectElement);

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.className = 'search-input';
            searchInput.placeholder = 'T√¨m ki·∫øm...';
            wrapper.insertBefore(searchInput, selectElement);

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'dropdown-options';
            wrapper.appendChild(optionsContainer);

            function updateOptions() {
                const searchTerm = searchInput.value.toLowerCase();
                const options = Array.from(selectElement.options);
                
                optionsContainer.innerHTML = '';
                let hasVisible = false;

                options.forEach((option, index) => {
                    if (index === 0) return; // Skip first empty option
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'dropdown-option';
                    if (option.text.toLowerCase().includes(searchTerm)) {
                        optionDiv.textContent = option.text;
                        optionDiv.onclick = () => {
                            selectElement.value = option.value;
                            selectElement.dispatchEvent(new Event('change'));
                            optionsContainer.classList.remove('show');
                            searchInput.value = '';
                        };
                        optionsContainer.appendChild(optionDiv);
                        hasVisible = true;
                    }
                });

                if (hasVisible && searchInput.value) {
                    optionsContainer.classList.add('show');
                } else {
                    optionsContainer.classList.remove('show');
                }
            }

            searchInput.addEventListener('input', updateOptions);
            searchInput.addEventListener('focus', () => {
                if (searchInput.value) updateOptions();
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    optionsContainer.classList.remove('show');
                }
            });
        }

        // File Preview Functions
        function previewFileByIndex(itemIndex, fileIndex) {
            if (!expenseItems[itemIndex] || !expenseItems[itemIndex].attachments[fileIndex]) {
                showToast('File kh√¥ng t·ªìn t·∫°i', 'error');
                return;
            }
            
            const file = expenseItems[itemIndex].attachments[fileIndex];
            const modal = document.createElement('div');
            modal.className = 'file-preview-modal';
            modal.innerHTML = `
                <button class="close-preview" onclick="this.parentElement.remove()">&times;</button>
            `;

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                modal.appendChild(img);
            } else if (file.type === 'application/pdf') {
                const iframe = document.createElement('iframe');
                iframe.src = URL.createObjectURL(file);
                iframe.style.width = '90%';
                iframe.style.height = '90%';
                modal.appendChild(iframe);
            } else {
                modal.innerHTML = `
                    <div style="color: white; text-align: center; padding: 20px;">
                        <p style="font-size: 18px; margin-bottom: 10px;">Kh√¥ng th·ªÉ preview file n√†y</p>
                        <p style="font-size: 14px; margin-bottom: 20px;">${file.name}</p>
                        <p style="font-size: 12px; color: #ccc;">Lo·∫°i file: ${file.type || 'Unknown'}</p>
                        <p style="font-size: 12px; color: #ccc;">K√≠ch th∆∞·ªõc: ${(file.size / 1024).toFixed(2)} KB</p>
                        <button class="close-preview" onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;">ƒê√≥ng</button>
                    </div>
                `;
            }

            document.body.appendChild(modal);
            modal.classList.add('show');
        }

        function removeFileFromRow(rowIndex, fileIndex) {
            if (expenseItems[rowIndex] && expenseItems[rowIndex].attachments) {
                expenseItems[rowIndex].attachments.splice(fileIndex, 1);
                renderExpenseTable();
                debounceAutoSave();
            }
        }

        // Expose functions globally for onclick handlers
        window.previewFileByIndex = previewFileByIndex;
        window.removeFileFromRow = removeFileFromRow;
        window.changeSpreadsheetId = changeSpreadsheetId;
        
        function saveVoucher() {
            if (!validateAllFields()) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc v√† ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng c√≥ l·ªói', 'error', 'L·ªói validation');
                // Scroll to first error
                const firstError = document.querySelector('.invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            // Save to localStorage
            saveToLocalStorage();
            showToast('Phi·∫øu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
        }
        
        async function sendForApproval() {
            // Validate approver field specifically
            const approverField = document.getElementById('approver');
            if (!approverField.value) {
                validateField('approver', '', 'Ng∆∞·ªùi ph√™ duy·ªát');
            }
            
            // Validate all fields including approver
            const requiredFields = ['company', 'voucher-type', 'employee', 'payee-name', 'currency', 'reason', 'approver'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                const fieldNames = {
                    'company': 'C√¥ng ty',
                    'voucher-type': 'Lo·∫°i phi·∫øu',
                    'employee': 'Ng∆∞·ªùi ƒë·ªÅ ngh·ªã',
                    'payee-name': 'Ng∆∞·ªùi n·ªôp/nh·∫≠n',
                    'currency': 'Lo·∫°i ti·ªÅn',
                    'reason': 'L√Ω do',
                    'approver': 'Ng∆∞·ªùi ph√™ duy·ªát'
                };
                if (!validateField(field, element ? element.value : '', fieldNames[field])) {
                    isValid = false;
                }
            });

            if (expenseItems.length === 0 || expenseItems.some(item => !item.content || item.amount === 0)) {
                showToast('Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt d√≤ng chi ti·∫øt v√† ƒëi·ªÅn ƒë·∫ßy ƒë·ªß N·ªôi dung, S·ªë ti·ªÅn', 'error');
                isValid = false;
            }
            
            if (!isValid) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc v√† ki·ªÉm tra l·∫°i c√°c tr∆∞·ªùng c√≥ l·ªói', 'error', 'L·ªói validation');
                // Scroll to first error
                const firstError = document.querySelector('.invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.add('show');
            document.getElementById('send-approval-btn').disabled = true;

            // Ensure voucher number is generated if not already set
            let voucherNumber = document.getElementById('voucher-number').value;
            if (!voucherNumber || voucherNumber.trim() === '' || voucherNumber === 'TL-2023-') {
                console.log('‚ö†Ô∏è Voucher number missing or invalid, generating new one...');
                generateVoucherNumber();
                voucherNumber = document.getElementById('voucher-number').value;
            }
            
            // Validate voucher number format
            if (!voucherNumber || !voucherNumber.match(/^TL-\d{4}\d{2}-\d{4}$/)) {
                console.error('‚ùå Invalid voucher number format:', voucherNumber);
                showToast('L·ªói: S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }
            
            console.log('‚úÖ Voucher number validated:', voucherNumber);
            const voucherType = document.getElementById('voucher-type').value;
            const companyName = document.getElementById('company').value;
            const requestorName = document.getElementById('employee').value;
            const payeeName = document.getElementById('payee-name').value;
            const totalAmount = document.getElementById('amount').value;
            const amountInWords = document.getElementById('amount-in-words').value;
            const reason = document.getElementById('reason').value;
            
            // Get voucher date from input, but validate it's not in the past
            const voucherDateInput = document.getElementById('voucher-date');
            let voucherDate = voucherDateInput ? voucherDateInput.value : '';
            
            // Validate date is not in the past
            if (voucherDate) {
                const selectedDate = new Date(voucherDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    console.warn('‚ö†Ô∏è Selected date is in the past, using current date instead');
                    showToast('Ng√†y l·∫≠p phi·∫øu kh√¥ng ƒë∆∞·ª£c l√† ng√†y qu√° kh·ª©. ƒê√£ t·ª± ƒë·ªông s·ª≠ d·ª•ng ng√†y hi·ªán t·∫°i.', 'warning');
                    voucherDate = getCurrentVoucherDate(); // Use current date
                    if (voucherDateInput) {
                        voucherDateInput.value = voucherDate; // Update input
                    }
                }
            } else {
                // If no date selected, use current date
                voucherDate = getCurrentVoucherDate();
            }
            
            const department = document.getElementById('department').value;

            const selectedApproverName = document.getElementById('approver').value;
            const selectedCompanyData = data.companies_data.find(c => c["T√™n c√¥ng ty"] === companyName);

            // Debug: Log ƒë·ªÉ ki·ªÉm tra
            console.log('=== DEBUG EMAIL ===');
            console.log('Selected Approver:', selectedApproverName);
            console.log('Company Name:', companyName);
            console.log('Company Data:', selectedCompanyData);
            console.log('Approver Email Map:', approverEmailMap);
            console.log('Employee Email Map:', employeeEmailMap);

            // T√¨m email ng∆∞·ªùi ph√™ duy·ªát - th·ª≠ nhi·ªÅu c√°ch
            let approverEmail = approverEmailMap[selectedApproverName];
            if (!approverEmail) {
                // Th·ª≠ t√¨m theo partial match
                const approverKey = Object.keys(approverEmailMap).find(key => 
                    key.includes(selectedApproverName) || selectedApproverName.includes(key)
                );
                if (approverKey) {
                    approverEmail = approverEmailMap[approverKey];
                    console.log('Found approver email by partial match:', approverEmail);
                }
            }

            // L·∫•y email t·ª´ company data
            const directorEmail = selectedCompanyData ? (selectedCompanyData["Email ƒê·∫°i di·ªán ph√°p lu·∫≠t"] || '') : '';
            const chiefAccountantEmail = selectedCompanyData ? (selectedCompanyData["Email K·∫ø to√°n tr∆∞·ªüng"] || '') : '';
            const requestorEmail = employeeEmailMap[requestorName] || '';
            
            // Email regex for validation (declare early so it can be used in debug logs)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // Debug: Check if requestorEmail was found
            console.log('=== REQUESTOR EMAIL DEBUG ===');
            console.log('Requestor Name:', requestorName);
            console.log('Employee Email Map Keys:', Object.keys(employeeEmailMap));
            console.log('Requestor Email Found:', requestorEmail);
            console.log('Requestor Email Valid:', requestorEmail && emailRegex.test(requestorEmail));
            console.log('=== END REQUESTOR EMAIL DEBUG ===');

            console.log('Approver Email:', approverEmail);
            console.log('Director Email:', directorEmail);
            console.log('Chief Accountant Email:', chiefAccountantEmail);
            console.log('Requestor Email:', requestorEmail);

            // T·∫°o danh s√°ch recipients - ∆∞u ti√™n approver, sau ƒë√≥ l√† director v√† accountant
            const recipients = [];
            if (approverEmail) recipients.push(approverEmail);
            if (directorEmail && !recipients.includes(directorEmail)) recipients.push(directorEmail);
            if (chiefAccountantEmail && !recipients.includes(chiefAccountantEmail)) recipients.push(chiefAccountantEmail);
            
            const ccRecipients = [];
            if (requestorEmail && !recipients.includes(requestorEmail)) ccRecipients.push(requestorEmail);

            console.log('Final Recipients:', recipients);
            console.log('Final CC Recipients:', ccRecipients);

            if (recipients.length === 0) {
                // Hi·ªÉn th·ªã th√¥ng tin debug chi ti·∫øt
                let errorMsg = 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ email ng∆∞·ªùi nh·∫≠n.\n\n';
                errorMsg += 'Th√¥ng tin debug:\n';
                errorMsg += `- Ng∆∞·ªùi ph√™ duy·ªát: ${selectedApproverName || '(ch∆∞a ch·ªçn)'}\n`;
                errorMsg += `- Email ng∆∞·ªùi ph√™ duy·ªát: ${approverEmail || 'Kh√¥ng t√¨m th·∫•y'}\n`;
                errorMsg += `- C√¥ng ty: ${companyName || '(ch∆∞a ch·ªçn)'}\n`;
                if (selectedCompanyData) {
                    errorMsg += `- Email ƒê·∫°i di·ªán ph√°p lu·∫≠t: ${directorEmail || 'Kh√¥ng c√≥'}\n`;
                    errorMsg += `- Email K·∫ø to√°n tr∆∞·ªüng: ${chiefAccountantEmail || 'Kh√¥ng c√≥'}\n`;
                } else {
                    errorMsg += '- Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√¥ng ty\n';
                }
                errorMsg += '\nVui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin c√¥ng ty v√† ng∆∞·ªùi ph√™ duy·ªát.';
                
                alert(errorMsg);
                showToast('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ email ng∆∞·ªùi nh·∫≠n. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.', 'error', 'L·ªói email');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }

            const subject = `[PHI·∫æU ${voucherType.toUpperCase()}] Y√™u c·∫ßu ph√™ duy·ªát - ${voucherNumber}`;
            
            // T·∫°o link - Production URL
            // TODO: Update URL n√†y sau khi deploy l√™n web server
            // N·∫øu ƒëang test local, comment d√≤ng d∆∞·ªõi v√† uncomment ph·∫ßn auto-detect
            const baseUrl = 'https://workflow.egg-ventures.com';
            
            // Auto-detect URL (uncomment n·∫øu mu·ªën t·ª± ƒë·ªông detect)
            // let baseUrl;
            // if (window.location.protocol === 'file:') {
            //     baseUrl = '.';
            // } else {
            //     baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            // }
            
            // Debug: Log requestorEmail
            console.log('=== CREATING APPROVAL LINKS ===');
            console.log('Requestor Name:', requestorName);
            console.log('Requestor Email:', requestorEmail);
            console.log('Approver Email:', approverEmail);
            
            if (!requestorEmail || requestorEmail.trim() === '') {
                console.warn('‚ö†Ô∏è WARNING: requestorEmail is empty! Email approval notification may not work.');
                console.warn('Please check employeeEmailMap for:', requestorName);
            }
            
            // T·∫°o query string
            const queryParams = new URLSearchParams({
                voucherNumber: voucherNumber,
                voucherType: voucherType,
                company: companyName,
                employee: requestorName,
                amount: totalAmount,
                requestorEmail: requestorEmail || '',
                approverEmail: approverEmail || ''
            });
            
            console.log('Query Params:', queryParams.toString());
            
            const approvalLink = `${baseUrl}/approve_voucher.html?${queryParams.toString()}`;
            const rejectionLink = `${baseUrl}/reject_voucher.html?${queryParams.toString()}`;
            
            console.log('Approval Link:', approvalLink);

            // Get current date/time for submission (not the form date)
            const submitDateTime = new Date();
            const currentDateTime = submitDateTime.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const formattedSubmitDateTime = `l√∫c ${currentDateTime}`;

            // Email body for APPROVERS (with buttons)
            const approverEmailBodyHtml = `
                <p>K√≠nh g·ª≠i c√°c c·∫•p qu·∫£n l√Ω,</p>
                <p>Phi·∫øu <b>${voucherType}</b> s·ªë <b>${voucherNumber}</b> ƒë√£ ƒë∆∞·ª£c t·∫°o v√† ƒëang ch·ªù ph√™ duy·ªát.</p>
                <p><b>Th√¥ng tin chi ti·∫øt phi·∫øu:</b></p>
                <ul>
                    <li><b>Lo·∫°i phi·∫øu:</b> ${voucherType}</li>
                    <li><b>S·ªë phi·∫øu:</b> ${voucherNumber}</li>
                    <li><b>Ng√†y l·∫≠p phi·∫øu:</b> ${formattedSubmitDateTime}</li>
                    <li><b>C√¥ng ty:</b> ${companyName}</li>
                    <li><b>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</b> ${requestorName} (${requestorEmail || 'Kh√¥ng c√≥ email'})</li>
                    <li><b>B·ªô ph·∫≠n:</b> ${department}</li>
                    <li><b>Ng∆∞·ªùi n·ªôp/nh·∫≠n:</b> ${payeeName}</li>
                    <li><b>T·ªïng s·ªë ti·ªÅn:</b> ${totalAmount}</li>
                    <li><b>S·ªë ti·ªÅn b·∫±ng ch·ªØ:</b> ${amountInWords}</li>
                    <li><b>L√Ω do:</b> ${reason}</li>
                </ul>
                <p><b>Chi ti·∫øt c√°c kho·∫£n m·ª•c:</b></p>
                <table style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">STT</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">N·ªôi dung</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">S·ªë ti·ªÅn</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ƒê√≠nh k√®m</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseItems.map((item, index) => {
                            // Handle attachments - can be File objects or plain objects with name property
                            let attachmentsList = 'Kh√¥ng c√≥';
                            if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                                const fileNames = item.attachments.map(f => {
                                    // Handle both File objects and plain objects
                                    if (f instanceof File) {
                                        return f.name;
                                    } else if (f && typeof f === 'object' && f.name) {
                                        return f.name;
                                    }
                                    return '';
                                }).filter(name => name); // Remove empty strings
                                
                                if (fileNames.length > 0) {
                                    attachmentsList = fileNames.join(', ');
                                }
                            }
                            
                            return `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.content || '-'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatCurrency(item.amount || 0)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${attachmentsList}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p><b>Vui l√≤ng xem x√©t v√† ph√™ duy·ªát/tr·∫£ l·∫°i phi·∫øu n√†y:</b></p>
                <div style="margin: 20px 0;">
                    <a href="${approvalLink}" style="background-color: #34A853; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-right: 10px; display: inline-block; font-weight: bold;">‚úÖ Ph√™ duy·ªát</a>
                    <a href="${rejectionLink}" style="background-color: #EA4335; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;">‚ùå Tr·∫£ l·∫°i / T·ª´ ch·ªëi</a>
                </div>
                <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                    <p style="margin: 0; color: #856404;"><b>L∆∞u √Ω:</b> N·∫øu phi·∫øu c·∫ßn ch·ªânh s·ª≠a, vui l√≤ng click n√∫t "Tr·∫£ l·∫°i / T·ª´ ch·ªëi" v√† ƒëi·ªÅn l√Ω do. Email th√¥ng b√°o s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ng∆∞·ªùi ƒë·ªÅ ngh·ªã.</p>
                </div>
                ${currentSignatureData ? `
                <div style="margin: 20px 0; padding: 15px; border-top: 1px solid #ddd;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">Ch·ªØ k√Ω ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</p>
                    <img src="${currentSignatureData}" alt="Ch·ªØ k√Ω" style="max-height: 80px; max-width: 200px;">
                </div>
                ` : ''}
                <p>Tr√¢n tr·ªçng,<br>H·ªá th·ªëng K·∫ø to√°n T·ª± ƒë·ªông</p>
            `;
            
            // Email body for REQUESTER (info only, NO buttons)
            const requesterEmailBodyHtml = `
                <p>K√≠nh g·ª≠i ${requestorName},</p>
                <p>Phi·∫øu <b>${voucherType}</b> s·ªë <b>${voucherNumber}</b> ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·ªÉ ph√™ duy·ªát.</p>
                <p><b>Th√¥ng tin chi ti·∫øt phi·∫øu:</b></p>
                <ul>
                    <li><b>Lo·∫°i phi·∫øu:</b> ${voucherType}</li>
                    <li><b>S·ªë phi·∫øu:</b> ${voucherNumber}</li>
                    <li><b>Ng√†y l·∫≠p phi·∫øu:</b> ${formattedSubmitDateTime}</li>
                    <li><b>C√¥ng ty:</b> ${companyName}</li>
                    <li><b>Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</b> ${requestorName}</li>
                    <li><b>B·ªô ph·∫≠n:</b> ${department}</li>
                    <li><b>Ng∆∞·ªùi n·ªôp/nh·∫≠n:</b> ${payeeName}</li>
                    <li><b>T·ªïng s·ªë ti·ªÅn:</b> ${totalAmount}</li>
                    <li><b>S·ªë ti·ªÅn b·∫±ng ch·ªØ:</b> ${amountInWords}</li>
                    <li><b>L√Ω do:</b> ${reason}</li>
                    <li><b>Ng∆∞·ªùi ph√™ duy·ªát:</b> ${selectedApproverName}</li>
                </ul>
                <p><b>Chi ti·∫øt c√°c kho·∫£n m·ª•c:</b></p>
                <table style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">STT</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">N·ªôi dung</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">S·ªë ti·ªÅn</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">ƒê√≠nh k√®m</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseItems.map((item, index) => {
                            // Handle attachments - can be File objects or plain objects with name property
                            let attachmentsList = 'Kh√¥ng c√≥';
                            if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                                const fileNames = item.attachments.map(f => {
                                    // Handle both File objects and plain objects
                                    if (f instanceof File) {
                                        return f.name;
                                    } else if (f && typeof f === 'object' && f.name) {
                                        return f.name;
                                    }
                                    return '';
                                }).filter(name => name); // Remove empty strings
                                
                                if (fileNames.length > 0) {
                                    attachmentsList = fileNames.join(', ');
                                }
                            }
                            
                            return `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.content || '-'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatCurrency(item.amount || 0)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${attachmentsList}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p style="color: #666; font-style: italic;">Email th√¥ng b√°o k·∫øt qu·∫£ ph√™ duy·ªát s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn b·∫°n sau khi ng∆∞·ªùi ph√™ duy·ªát x·ª≠ l√Ω.</p>
                ${currentSignatureData ? `
                <div style="margin: 20px 0; padding: 15px; border-top: 1px solid #ddd;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">Ch·ªØ k√Ω c·ªßa b·∫°n:</p>
                    <img src="${currentSignatureData}" alt="Ch·ªØ k√Ω" style="max-height: 80px; max-width: 200px;">
                </div>
                ` : ''}
                <p>Tr√¢n tr·ªçng,<br>H·ªá th·ªëng K·∫ø to√°n T·ª± ƒë·ªông</p>
            `;

            // Validate email format (emailRegex already declared earlier)
            const validRecipients = recipients.filter(email => emailRegex.test(email));
            const validCCRecipients = ccRecipients.filter(email => emailRegex.test(email));

            if (validRecipients.length === 0) {
                showToast('Kh√¥ng c√≥ email h·ª£p l·ªá ƒë·ªÉ g·ª≠i. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.', 'error', 'L·ªói email');
                console.error('No valid email addresses found');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }
            
            // Ensure requester email is included even if not in CC
            if (!validCCRecipients.includes(requestorEmail) && requestorEmail && emailRegex.test(requestorEmail)) {
                validCCRecipients.push(requestorEmail);
                console.log('Added requestor email to notification list:', requestorEmail);
            }
            
            // CRITICAL FIX: Ensure requesterEmail.to is always set if requestorEmail is valid
            // Priority: 1) validCCRecipients (if has requestorEmail), 2) requestorEmail directly
            let requesterEmailTo = '';
            if (validCCRecipients.length > 0) {
                requesterEmailTo = validCCRecipients.join(',');
            }
            // If requesterEmailTo is still empty but requestorEmail is valid, use it directly
            if (!requesterEmailTo && requestorEmail && emailRegex.test(requestorEmail)) {
                requesterEmailTo = requestorEmail;
                console.log('‚ö†Ô∏è validCCRecipients was empty, using requestorEmail directly:', requestorEmail);
            }
            // Final fallback: if still empty but requestorEmail exists (even if not in map), use it
            if (!requesterEmailTo && requestorEmail && requestorEmail.trim() !== '') {
                requesterEmailTo = requestorEmail.trim();
                console.log('‚ö†Ô∏è Using requestorEmail as final fallback:', requestorEmail);
            }
            
            console.log('Final requesterEmail.to:', requesterEmailTo);
            console.log('requestorEmail value:', requestorEmail);
            console.log('validCCRecipients:', validCCRecipients);

            // Collect files for upload to Drive
            const filesToUpload = [];
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB max per file
            
            for (let i = 0; i < expenseItems.length; i++) {
                const item = expenseItems[i];
                if (item.attachments && item.attachments.length > 0) {
                    for (const file of item.attachments) {
                        if (file instanceof File) {
                            // Check file size
                            if (file.size > MAX_FILE_SIZE) {
                                console.warn(`File ${file.name} is too large (${(file.size / 1024 / 1024).toFixed(2)} MB). Max: 10MB. Skipping.`);
                                continue;
                            }
                            
                            try {
                                // Convert file to base64
                                const base64Data = await fileToBase64(file);
                                
                                // Verify base64 data was generated
                                if (!base64Data || base64Data.length < 100) {
                                    console.error(`Failed to convert ${file.name} to base64. Result was empty or too short.`);
                                    continue;
                                }
                                
                                console.log(`‚úÖ File ${file.name}: ${file.size} bytes -> ${base64Data.length} chars base64`);
                                
                                filesToUpload.push({
                                    fileName: file.name,
                                    fileData: base64Data,
                                    mimeType: file.type || 'application/octet-stream',
                                    fileSize: file.size,
                                    rowIndex: i
                                });
                            } catch (err) {
                                console.error('Error converting file to base64:', file.name, err);
                            }
                        }
                    }
                }
            }

            // Log file information for verification
            console.log('=== FILE UPLOAD INFO ===');
            console.log('Total expense items:', expenseItems.length);
            console.log('Files to upload:', filesToUpload.length);
            if (filesToUpload.length > 0) {
                console.log('Files details:');
                filesToUpload.forEach((f, idx) => {
                    const sizeMB = (f.fileSize / (1024 * 1024)).toFixed(2);
                    console.log(`  ${idx + 1}. Row ${f.rowIndex}: ${f.fileName} (${sizeMB} MB, ${f.mimeType})`);
                });
            } else {
                console.log('No files attached');
            }

            const payload = {
                action: 'sendApprovalEmail',
                email: {
                    to: validRecipients.join(','),
                    cc: '', // No CC - requester will get separate email
                    subject: subject,
                    body: approverEmailBodyHtml // Email with buttons for approvers
                },
                requesterEmail: {
                    to: requesterEmailTo, // Requester gets separate email (always set if requestorEmail is valid)
                    subject: `[TH√îNG B√ÅO] Phi·∫øu ${voucherType} ${voucherNumber} ƒë√£ ƒë∆∞·ª£c g·ª≠i ph√™ duy·ªát`,
                    body: requesterEmailBodyHtml // Email without buttons for requester
                },
                voucher: {
                    voucherNumber: voucherNumber || '',
                    voucherType: voucherType || '',
                    company: companyName || '',
                    employee: requestorName || '',
                    amount: totalAmount || '0',
                    requestorEmail: requestorEmail || '',
                    approverEmail: approverEmail || '',
                    voucherDate: voucherDate || '',
                    department: department || '',
                    payeeName: payeeName || '',
                    reason: reason || '',
                    files: filesToUpload  // Files for Drive upload
                }
            };

            console.log('=== VOUCHER DATA FOR HISTORY ===');
            console.log('Voucher Number:', payload.voucher.voucherNumber);
            console.log('Voucher Type:', payload.voucher.voucherType);
            console.log('Company:', payload.voucher.company);
            console.log('Employee:', payload.voucher.employee);
            console.log('Amount:', payload.voucher.amount);
            console.log('Requestor Email:', payload.voucher.requestorEmail);
            console.log('Full Voucher Object:', payload.voucher);
            console.log('=== END VOUCHER DATA ===');
            
            console.log('=== EMAIL PAYLOAD DEBUG ===');
            console.log('Valid Recipients:', validRecipients);
            console.log('Valid CC Recipients:', validCCRecipients);
            console.log('Requestor Email:', requestorEmail);
            console.log('Requester Email To (final):', requesterEmailTo);
            console.log('Requester Email Subject:', `[TH√îNG B√ÅO] Phi·∫øu ${voucherType} ${voucherNumber} ƒë√£ ƒë∆∞·ª£c g·ª≠i ph√™ duy·ªát`);
            console.log('=== END EMAIL PAYLOAD DEBUG ===');

            // Debug: Log payload tr∆∞·ªõc khi g·ª≠i
            console.log('=== SENDING EMAIL ===');
            console.log('Recipients:', recipients);
            console.log('CC Recipients:', ccRecipients);
            console.log('Google Apps Script URL:', GOOGLE_APPS_SCRIPT_WEB_APP_URL);
            
            // Calculate total payload size
            const payloadString = JSON.stringify(payload);
            const payloadSizeKB = (payloadString.length / 1024).toFixed(2);
            const payloadSizeMB = (payloadString.length / 1024 / 1024).toFixed(2);
            console.log(`üì¶ Total payload size: ${payloadSizeKB} KB (${payloadSizeMB} MB)`);
            console.log(`üìÅ Files in payload: ${filesToUpload.length}`);
            filesToUpload.forEach((f, i) => {
                console.log(`   File ${i+1}: ${f.fileName} - base64 length: ${f.fileData ? f.fileData.length : 0}`);
            });
            
            // Check if payload is too large (> 5MB might fail)
            if (payloadString.length > 5 * 1024 * 1024) {
                console.warn('‚ö†Ô∏è Payload is very large (> 5MB), upload may fail');
            }

            try {
                // Use text/plain to avoid CORS preflight issues with large payloads
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: payloadString,
                });
                
                console.log('Response status:', response.status);
                console.log('Response received (no-cors mode, cannot read body)');

                // Since mode: 'no-cors' is used, response.ok will always be false.
                // We rely on the Apps Script to actually send the email and assume success
                // if no network error occurs. For a more robust solution, the Apps Script
                // should return a JSON response and the client should handle CORS.
                // For this example, we'll assume success if the fetch completes without error.

                // Update UI status and history
                // Update status display with proper status text
                const statusDisplay = document.getElementById('approval-status-display');
                statusDisplay.textContent = 'ƒê√£ g·ª≠i th√¥ng tin'; // Show "ƒê√£ g·ª≠i th√¥ng tin" when sent for approval
                statusDisplay.classList.remove('status-pending', 'status-rejected', 'status-approved');
                statusDisplay.classList.add('status-pending'); // Keep pending style for visual consistency

                // Update review status as well
                const reviewStatus = document.getElementById('review-status');
                if (reviewStatus) {
                    reviewStatus.textContent = 'ƒê√£ g·ª≠i th√¥ng tin';
                }

                const now = new Date();
                const timestamp = now.toLocaleString('vi-VN');
                approvalHistory.push({
                    timestamp: timestamp,
                    action: 'ƒê√£ g·ª≠i th√¥ng tin',
                    by: requestorName,
                    to: [selectedApproverName, selectedCompanyData ? selectedCompanyData["ƒê·∫°i di·ªán ph√°p lu·∫≠t"] : '', selectedCompanyData ? selectedCompanyData["K·∫ø to√°n tr∆∞·ªüng"] : ''].filter(Boolean).join(', ')
                });
                renderApprovalHistory();

                showToast(`ƒê√£ g·ª≠i y√™u c·∫ßu ph√™ duy·ªát cho ${validRecipients.join(', ')}${validCCRecipients.length > 0 ? ' (CC: ' + validCCRecipients.join(', ') + ')' : ''}`, 'success', 'G·ª≠i th√†nh c√¥ng');

            } catch (error) {
                console.error('L·ªói khi g·ª≠i y√™u c·∫ßu ph√™ duy·ªát qua Google Apps Script:', error);
                showToast('Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ph√™ duy·ªát t·ª± ƒë·ªông. ƒêang chuy·ªÉn sang g·ª≠i qua email client', 'warning', 'C·∫£nh b√°o');
                
                // Fallback to mailto: if webhook fails
                const mailtoLink = `mailto:${recipients.join(',')}?cc=${ccRecipients.join(',')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBodyHtml.replace(/<[^>]*>?/gm, ''))}`; // Remove HTML for mailto body
                window.open(mailtoLink, '_blank');
            } finally {
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
            }
        }

        function renderApprovalHistory() {
            const historyList = document.getElementById('approval-history-list');
            historyList.innerHTML = '';

            if (approvalHistory.length === 0) {
                historyList.innerHTML = '<li>Ch∆∞a c√≥ y√™u c·∫ßu ph√™ duy·ªát n√†o ƒë∆∞·ª£c g·ª≠i.</li>';
                return;
            }

            approvalHistory.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.textContent = `${entry.timestamp}: ${entry.action} b·ªüi ${entry.by} (g·ª≠i ƒë·∫øn: ${entry.to})`;
                historyList.appendChild(listItem);
            });
        }

        // Expense Table Functions
        function renderExpenseTable() {
            const tableBody = document.getElementById('expense-table-body');
            tableBody.innerHTML = '';

            expenseItems.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" value="${item.content || ''}" oninput="updateExpenseItem(${index}, 'content', this.value)"></td>
                    <td><input type="text" value="${formatCurrency(item.amount || 0)}" oninput="updateExpenseItem(${index}, 'amount', parseCurrency(this.value))" onblur="this.value = formatCurrency(parseCurrency(this.value))"></td>
                    <td class="attachment-cell">
                        <button type="button" class="attachment-button" onclick="triggerAttachmentInput(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            ƒê√≠nh k√®m (${item.attachments.length})
                        </button>
                        <div class="file-preview-container" id="file-preview-${index}">
                            ${item.attachments.map((file, fileIndex) => {
                                const fileUrl = URL.createObjectURL(file);
                                const isImage = file.type.startsWith('image/');
                                return `
                                <div class="file-preview-item">
                                    ${isImage ? `<img src="${fileUrl}" alt="${file.name}" onclick="previewFileByIndex(${index}, ${fileIndex})" style="cursor: pointer; max-width: 100px; max-height: 100px;">` : ''}
                                    <div class="file-name" title="${file.name}">${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}</div>
                                    <button class="file-remove" onclick="removeFileFromRow(${index}, ${fileIndex})" title="X√≥a file">&times;</button>
                                    ${!isImage ? `<button style="margin-top: 5px; padding: 4px 8px; font-size: 11px; background: var(--primary-color); color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="previewFileByIndex(${index}, ${fileIndex})">Preview</button>` : ''}
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </td>
                    <td><button type="button" class="remove-row-btn" onclick="removeExpenseRow(${index})">&times;</button></td>
                `;
            });
            updateGrandTotal();
        }

        function addExpenseRow() {
            expenseItems.push({ content: '', amount: 0, attachments: [] });
            renderExpenseTable();
            debounceAutoSave();
        }

        async function removeExpenseRow(index) {
            const confirmed = await showConfirmation(
                'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng n√†y kh√¥ng?',
                'X√°c nh·∫≠n x√≥a'
            );
            
            if (confirmed) {
            expenseItems.splice(index, 1);
            renderExpenseTable();
                debounceAutoSave();
                showToast('ƒê√£ x√≥a d√≤ng th√†nh c√¥ng', 'success');
            }
        }

        function updateExpenseItem(index, field, value) {
            expenseItems[index][field] = value;
            if (field === 'amount') {
                updateGrandTotal();
            }
            debounceAutoSave();
        }

        function triggerAttachmentInput(index) {
            // Use a global hidden file input that's always accessible
            let globalFileInput = document.getElementById('global-attachment-input');
            if (!globalFileInput) {
                // Create global file input if it doesn't exist
                globalFileInput = document.createElement('input');
                globalFileInput.type = 'file';
                globalFileInput.multiple = true;
                globalFileInput.id = 'global-attachment-input';
                globalFileInput.style.position = 'fixed';
                globalFileInput.style.left = '-9999px';
                globalFileInput.style.opacity = '0';
                globalFileInput.style.width = '1px';
                globalFileInput.style.height = '1px';
                globalFileInput.style.overflow = 'hidden';
                document.body.appendChild(globalFileInput);
            }
            
            // Store the index for when file is selected
            globalFileInput.setAttribute('data-row-index', index);
            
            // Clear previous value to allow selecting same file again
            globalFileInput.value = '';
            
            // Set up one-time event listener
            const handleFileSelect = (event) => {
                handleRowFileSelect(event, index);
                globalFileInput.removeEventListener('change', handleFileSelect);
            };
            
            globalFileInput.addEventListener('change', handleFileSelect);
            globalFileInput.click();
        }

        function handleRowFileSelect(event, index) {
            const files = Array.from(event.target.files);
            const validFiles = [];
            let hasError = false;
            
            files.forEach(file => {
                if (validateFile(file)) {
                    validFiles.push(file);
                } else {
                    hasError = true;
                }
            });
            
            if (validFiles.length > 0) {
                expenseItems[index].attachments = validFiles;
            renderExpenseTable();
                debounceAutoSave();
                if (validFiles.length === files.length) {
                    showToast(`ƒê√£ th√™m ${validFiles.length} file th√†nh c√¥ng`, 'success');
                } else {
                    showToast(`ƒê√£ th√™m ${validFiles.length}/${files.length} file`, 'warning');
                }
            } else if (!hasError) {
                expenseItems[index].attachments = [];
                renderExpenseTable();
            }
        }

        function updateGrandTotal() {
            const grandTotal = expenseItems.reduce((sum, item) => sum + (item.amount || 0), 0);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('amount').value = formatCurrency(grandTotal);
            updateAmountInWords();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function parseCurrency(currencyString) {
            const cleanedString = currencyString.replace(/[^0-9,.]/g, '');
            const parts = cleanedString.split(',');
            if (parts.length > 1) {
                const lastPart = parts[parts.length - 1];
                if (lastPart.length <= 3 && lastPart.includes('.')) { 
                    return parseFloat(cleanedString.replace(/\./g, '').replace(',', '.'));
                } else if (lastPart.length <= 3 && !lastPart.includes('.')) { 
                    return parseFloat(cleanedString.replace(/,/g, ''));
                }
            }
            return parseFloat(cleanedString.replace(/\./g, '').replace(',', '.')) || 0;
        }

        async function copyFromExcelToTable() {
            try {
                const text = await navigator.clipboard.readText();
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ d√°n t·ª´ clipboard.');
                    return;
                }

                const newItems = [];
                lines.forEach(line => {
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        const content = parts[0] || '';
                        const amount = parseCurrency(parts[1]) || 0;
                        newItems.push({ content, amount, attachments: [] });
                    }
                });

                if (newItems.length > 0) {
                    expenseItems = newItems;
                    renderExpenseTable();
                    debounceAutoSave();
                    showToast('ƒê√£ d√°n d·ªØ li·ªáu t·ª´ Excel v√†o b·∫£ng chi ti·∫øt th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
                } else {
                    showToast('Kh√¥ng th·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu d√°n. Vui l√≤ng ƒë·∫£m b·∫£o ƒë·ªãnh d·∫°ng l√† "N·ªôi dung\\tS·ªë ti·ªÅn"', 'error', 'L·ªói');
                }

            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                showToast('Kh√¥ng th·ªÉ truy c·∫≠p clipboard. Vui l√≤ng ƒë·∫£m b·∫£o b·∫°n ƒë√£ c·∫•p quy·ªÅn cho tr√¨nh duy·ªát ho·∫∑c th·ª≠ nh·∫≠p t·ª´ file', 'error', 'L·ªói');
            }
        }

        function importExcelToTable() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length > 1) {
                        const newItems = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 2) {
                                const content = row[0] || '';
                                const amount = parseFloat(row[1]) || 0;
                                newItems.push({ content, amount, attachments: [] });
                            }
                        }

                        if (newItems.length > 0) {
                            expenseItems = newItems;
                            renderExpenseTable();
                            debounceAutoSave();
                            showToast('ƒê√£ nh·∫≠p d·ªØ li·ªáu t·ª´ file Excel v√†o b·∫£ng chi ti·∫øt th√†nh c√¥ng!', 'success', 'Th√†nh c√¥ng');
                        } else {
                            showToast('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong file Excel. Vui l√≤ng ƒë·∫£m b·∫£o file c√≥ c√°c c·ªôt "N·ªôi dung", "S·ªë ti·ªÅn"', 'error', 'L·ªói');
                        }
                    } else {
                        showToast('File Excel tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu', 'error', 'L·ªói');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            input.click();
        }

        /*
         * Google Apps Script (Code.gs) for sending emails:
         *
         * Instructions:
         * 1. Go to script.google.com and create a new project.
         * 2. Copy the following code into the Code.gs file.
         * 3. Save the project.
         * 4. Deploy the script as a Web App:
         *    - Click "Deploy" -> "New deployment".
         *    - Select "Web app" as the type.
         *    - Set "Execute as" to "Me" (your Google account).
         *    - Set "Who has access" to "Anyone".
         *    - Click "Deploy".
         *    - Authorize the script if prompted (it will ask for permission to send emails on your behalf).
         *    - Copy the "Web app URL" and replace 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' in the HTML with this URL.
         * 5. Test the integration by filling out the form and clicking "G·ª≠i ph√™ duy·ªát".
         */
        /*
        function doPost(e) {
            try {
                const requestBody = JSON.parse(e.postData.contents);
                const action = requestBody.action;

                if (action === 'sendApprovalEmail') {
                    const emailData = requestBody.email;
                    const to = emailData.to;
                    const cc = emailData.cc;
                    const subject = emailData.subject;
                    const body = emailData.body;

                    GmailApp.sendEmail(to, subject, '', {
                        htmlBody: body,
                        cc: cc
                    });

                    return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Email sent successfully.' }))
                        .setMimeType(ContentService.MimeType.JSON);
                } else {
                    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Invalid action.' }))
                        .setMimeType(ContentService.MimeType.JSON);
                }
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.message }))
                    .setMimeType(ContentService.MimeType.JSON);
            }
        }
        */
    </script>
</body>
</html>