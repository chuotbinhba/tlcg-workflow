<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Thu/Chi - TLCGroup Intranet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;      /* Blue-500 */
            --primary-hover: #2563eb; /* Blue-600 */
            --success: #10b981;      /* Emerald-500 */
            --warning: #f59e0b;      /* Amber-500 */
            --error: #ef4444;        /* Red-500 */
            --text-primary: #0f172a;  /* Slate-900 */
            --text-secondary: #64748b; /* Slate-500 */
            --border: #e2e8f0;       /* Slate-200 */
            --background: #f8fafc;    /* Slate-50 */
            --card-bg: #ffffff;      /* White */
            /* Legacy support */
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --text-color: #0f172a;
            --light-gray: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.04);
            --success-color: #10b981;
            --error-color: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Navigation Bar - Kissflow Style */
        nav.sticky {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        .form-section-container {
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            padding: 2rem;
        }
        
        .form-section-container:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0, 0, 0, 0.02);
            transform: translateY(-2px);
        }
        
        h1 {
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.25rem; /* text-xl - same as "Order to Cash" */
            letter-spacing: -0.025em;
            font-family: 'Inter', sans-serif;
            line-height: 1.2;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.125rem; /* text-lg on mobile */
            }
        }
        
        /* Progress Stepper */
        .progress-stepper {
            margin-bottom: 2rem;
            padding: 1.5rem 0;
        }
        
        .stepper-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .stepper-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
            z-index: 0;
        }
        
        .stepper-line-progress {
            position: absolute;
            top: 20px;
            left: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s ease;
            z-index: 1;
        }
        
        .stepper-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }
        
        .stepper-step:not(:last-child) {
            margin-right: 0;
        }
        
        .stepper-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .stepper-step.active .stepper-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .stepper-step.completed .stepper-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .stepper-step.completed .stepper-circle::before {
            content: '✓';
            font-size: 1.25rem;
        }
        
        .stepper-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: center;
            max-width: 120px;
            transition: color 0.3s ease;
        }
        
        .stepper-step.active .stepper-label {
            color: var(--primary);
            font-weight: 600;
        }
        
        .stepper-step.completed .stepper-label {
            color: var(--success);
        }
        
        @media (max-width: 768px) {
            .stepper-label {
                font-size: 0.625rem;
                max-width: 80px;
            }
            
            .stepper-circle {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }
        }
        
        /* Form Steps */
        .form-step {
            display: none;
        }
        
        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .step-navigation button {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            border: 1px solid var(--border);
            background: white;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .step-navigation button:hover:not(:disabled) {
            background: var(--background);
        }
        
        .step-navigation button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .step-navigation .btn-next {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .step-navigation .btn-next:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        
        .step-navigation .btn-submit {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .step-navigation .btn-submit:hover:not(:disabled) {
            background: #059669;
        }
        
        h2 {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
        }

        h2 .tooltip-icon {
            cursor: help;
            font-size: 18px;
            color: var(--primary-color);
            position: relative;
        }

        h2 .tooltip-icon .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: var(--text-color);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
        }

        h2 .tooltip-icon .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--text-color) transparent transparent transparent;
        }

        h2 .tooltip-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
            padding: 0;
            background: transparent;
            border: none;
            margin-top: 0;
        }
        
        .company-info, .voucher-info {
            flex: 1;
            min-width: 300px;
        }
        
        .form-row {
            margin-bottom: 1.25rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            transition: all 0.15s ease;
            background-color: white;
            color: var(--text-primary);
        }
        
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input:read-only, textarea:read-only {
            background-color: #f8fafc;
            color: #64748b;
            cursor: default;
        }
        
        label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
            letter-spacing: 0;
            text-transform: none;
        }
        
        select {
            background-color: white;
            cursor: pointer;
            height: 42px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .button-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            justify-content: flex-end;
        }
        
        button {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        button:not(:disabled):hover {
            transform: translateY(-1px);
        }
        
        button:not(:disabled):active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }
        
        .btn-secondary {
            background-color: white;
            color: #475569;
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--background);
            border-color: #cbd5e1;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
            box-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
        }

        .btn-danger {
            background-color: var(--error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            box-shadow: 0 1px 2px rgba(239, 68, 68, 0.2);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.025em;
            margin-top: 0.5rem;
            max-width: fit-content;
            font-family: 'Inter', sans-serif;
        }
        
        .status-pending {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .amounts {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--background);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .amount-row {
            display: flex;
            justify-content: space-between;
        }
        
        .amount-row.total {
            font-weight: 700;
            font-size: 18px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            margin-top: 10px;
        }
        
        .upload-container {
            border: 2px dashed var(--border);
            padding: 20px;
            text-align: center;
            border-radius: 6px;
            background-color: var(--background);
            transition: all 0.15s ease;
            cursor: pointer;
        }
        
        .upload-container:hover {
            background-color: #f1f5f9;
            border-color: var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .company-details {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--background);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: none;
        }
        
        .company-details.show {
            display: block;
        }
        
        .approval-section {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .approval-history {
            margin-top: 1rem;
            padding: 1.25rem;
            background-color: #ffffff;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid #e5e7eb;
        }

        .approval-history h3 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #111827;
        }

        .approval-history ul {
            list-style: none;
            padding: 0;
        }

        .approval-history li {
            margin-bottom: 5px;
            padding-left: 10px;
            border-left: 3px solid var(--border-color);
        }

        /* Expense section fields - inside Bảng kê section */
        .expense-section-fields {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border: 1px solid var(--border);
        }

        .expense-section-fields .form-group {
            margin-bottom: 15px;
        }

        /* Signature Upload Styles */
        .signature-container {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1rem;
            background: #fafbfc;
        }

        .signature-preview-area {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border);
            margin-bottom: 0.75rem;
        }

        .signature-preview-area img {
            max-width: 200px;
            max-height: 80px;
            object-fit: contain;
        }

        #signature-placeholder {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .signature-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .signature-upload-btn {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signature-note {
            color: #64748b;
            font-size: 0.75rem;
        }

        .signature-note small {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .expense-section-fields .form-group:last-child {
            margin-bottom: 0;
        }

        .expense-section-fields label {
            font-weight: 500;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-transform: none;
            margin-bottom: 0.375rem;
        }

        .expense-section-fields textarea {
            min-height: 100px;
        }

        /* Table styles - Modern Kissflow Design */
        .expense-table-container {
            margin-top: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0, 0, 0, 0.02);
            overflow-x: auto;
            border: 1px solid var(--border);
        }

        .expense-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 0;
            overflow: hidden;
            min-width: 800px;
        }

        .expense-table th, .expense-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            vertical-align: top;
        }

        .expense-table th {
            background: var(--background);
            font-size: 0.8125rem;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid var(--border);
            text-transform: none;
            letter-spacing: 0;
        }
        
        .expense-table tbody tr {
            transition: background-color 0.15s ease;
            border-bottom: 1px solid var(--border);
        }
        
        .expense-table tbody tr:hover {
            background: var(--background);
        }
        
        .expense-table tbody tr:last-child td {
            border-bottom: none;
        }

        .expense-table td input[type="text"],
        .expense-table td input[type="number"] {
            border: none;
            padding: 5px;
            width: 100%;
            background-color: transparent;
        }

        .expense-table td input[type="number"] {
            text-align: right;
        }

        .expense-table td .remove-row-btn {
            background-color: transparent;
            color: var(--error-color);
            border: none;
            padding: 5px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }

        .expense-table td .remove-row-btn:hover {
            color: #a00;
            transform: none;
        }

        .expense-table-footer {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 15px 20px;
            background-color: var(--background);
            border-top: 1px solid var(--border);
            border-radius: 0;
            font-weight: 700;
            font-size: 18px;
            gap: 10px;
        }

        .expense-table-footer .footer-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .expense-table-footer .footer-row span:first-child {
            margin-right: 10px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .expense-table-footer .footer-row span:last-child {
            color: var(--primary);
            font-weight: 700;
        }

        .table-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .attachment-cell {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .attachment-cell .attachment-button {
            padding: 6px 10px;
            font-size: 14px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            max-width: fit-content;
        }

        .attachment-cell .attachment-button:hover {
            background-color: #3367d6;
        }

        .attachment-cell .file-list {
            font-size: 12px;
            color: #555;
            max-height: 60px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: 4px;
            background-color: #fcfcfc;
        }

        .attachment-cell .file-list p {
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .loading-indicator.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Validation Styles */
        .form-group {
            position: relative;
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .error-message.show {
            display: block;
        }

        input.invalid, select.invalid, textarea.invalid {
            border-color: var(--error-color) !important;
            box-shadow: 0 0 0 2px rgba(234, 67, 53, 0.2) !important;
        }

        input.valid, select.valid, textarea.valid {
            border-color: var(--success-color) !important;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notification Styles - Matching Intranet */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            font-size: 14px;
            font-weight: 500;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: #666;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Auto-save Indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .auto-save-indicator.show {
            display: block;
        }

        .auto-save-indicator.saving {
            background-color: var(--primary-color);
        }

        .auto-save-indicator.saved {
            background-color: var(--success-color);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Confirmation Dialog */
        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .confirmation-overlay.show {
            display: flex;
        }

        .confirmation-dialog {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .confirmation-dialog h3 {
            margin-bottom: 12px;
            color: var(--text-color);
            font-size: 18px;
        }

        .confirmation-dialog p {
            margin-bottom: 20px;
            color: #666;
        }

        .confirmation-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .confirmation-actions button {
            min-width: 80px;
        }

        /* File validation styles */
        .file-error {
            color: var(--error-color);
            font-size: 11px;
            margin-top: 4px;
        }

        .file-size-info {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* Search dropdown styles */
        .searchable-select {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .dropdown-options {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dropdown-options.show {
            display: block;
        }

        .dropdown-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-option:hover {
            background-color: var(--light-gray);
        }

        .dropdown-option.hidden {
            display: none;
        }

        /* File preview styles */
        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .file-preview-item {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            background: var(--light-gray);
            max-width: 150px;
        }

        .file-preview-item img {
            max-width: 100%;
            max-height: 100px;
            border-radius: 4px;
        }

        .file-preview-item .file-name {
            font-size: 11px;
            margin-top: 5px;
            word-break: break-word;
        }

        .file-preview-item .file-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal.show {
            display: flex;
        }

        .file-preview-modal img,
        .file-preview-modal iframe {
            max-width: 90%;
            max-height: 90%;
        }

        .file-preview-modal .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 24px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .button-row, .table-actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }

            .form-header {
                flex-direction: column;
            }

            .toast-container {
                left: 20px;
                right: 20px;
                top: 10px;
            }

            .toast {
                min-width: auto;
                max-width: 100%;
            }
        }

        /* ============ RECENT VOUCHERS SECTION ============ */
        .recent-vouchers-section {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .recent-vouchers-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .recent-vouchers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .recent-vouchers-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .voucher-stats {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .stat-item .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .stat-item .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .stat-item.pending .stat-value { color: #f59e0b; }
        .stat-item.approved .stat-value { color: #10b981; }
        .stat-item.rejected .stat-value { color: #ef4444; }

        .voucher-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .voucher-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.15s;
        }

        .voucher-item:hover {
            background: #f8fafc;
        }

        .voucher-item:last-child {
            border-bottom: none;
        }

        .voucher-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .voucher-icon.pending { background: #fef3c7; color: #d97706; }
        .voucher-icon.approved { background: #d1fae5; color: #059669; }
        .voucher-icon.rejected { background: #fee2e2; color: #dc2626; }

        .voucher-info {
            flex: 1;
            min-width: 0;
        }

        .voucher-info .voucher-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
        }

        .voucher-info .voucher-meta {
            font-size: 0.8125rem;
            color: #64748b;
        }

        .voucher-amount {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.9375rem;
            text-align: right;
            margin-left: 1rem;
        }

        .voucher-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            white-space: nowrap;
        }

        .voucher-status.pending { background: #fef3c7; color: #92400e; }
        .voucher-status.approved { background: #d1fae5; color: #065f46; }
        .voucher-status.rejected { background: #fee2e2; color: #991b1b; }

        .no-vouchers {
            padding: 3rem;
            text-align: center;
            color: #94a3b8;
        }

        /* ============ VOUCHER DETAIL MODAL ============ */
        .voucher-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .voucher-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .voucher-modal {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .voucher-modal-overlay.show .voucher-modal {
            transform: scale(1) translateY(0);
        }

        .voucher-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .voucher-modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: #e2e8f0;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close-btn:hover {
            background: #cbd5e1;
            color: #1e293b;
        }

        .voucher-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .voucher-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .voucher-detail-item {
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .voucher-detail-item .label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .voucher-detail-item .value {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1e293b;
        }

        .voucher-detail-section {
            margin-bottom: 1.5rem;
        }

        .voucher-detail-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .approver-signature-section {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .approver-signature-section h4 {
            color: #166534;
            margin-bottom: 1rem;
            border-bottom-color: #86efac;
        }

        .approver-signature-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            background: white;
            border-radius: 8px;
            border: 1px solid #86efac;
            margin-bottom: 0.75rem;
        }

        .approver-signature-preview img {
            max-width: 200px;
            max-height: 80px;
            object-fit: contain;
        }

        .voucher-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .modal-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .modal-btn-secondary:hover {
            background: #cbd5e1;
        }

        .modal-btn-approve {
            background: #10b981;
            color: white;
        }

        .modal-btn-approve:hover {
            background: #059669;
        }

        .modal-btn-reject {
            background: #ef4444;
            color: white;
        }

        .modal-btn-reject:hover {
            background: #dc2626;
        }

        .modal-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
        }

        .modal-loading.show {
            display: flex;
        }

        .modal-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 640px) {
            .voucher-detail-grid {
                grid-template-columns: 1fr;
            }
            
            .voucher-stats {
                flex-wrap: wrap;
            }
            
            .voucher-modal-footer {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation Bar - Kissflow Style + Sign In -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="if(window.opener) window.close(); else window.location.href='index.html'">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white text-base font-bold" style="font-family: 'Inter', sans-serif;">TLC</span>
                </div>
                <span class="font-semibold text-lg text-gray-900 tracking-tight" style="font-family: 'Inter', sans-serif;">TLCGroup</span>
            </div>
            <div class="flex items-center" style="gap: 12px;">
                <button onclick="window.location.href='index.html'" class="text-gray-600 hover:text-gray-900 font-medium transition flex items-center gap-2 px-3 py-2" style="background: transparent; border-radius: 8px;">
                    <i class="fas fa-arrow-left text-sm"></i>
                    <span>Quay lại Intranet</span>
                </button>
                <button onclick="window.location.href='index.html'" class="btn-primary" style="min-height: 36px;">
                    <i class="fas fa-sign-in-alt" style="margin-right: 6px;"></i>
                    <span>Sign In</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="flex-1 py-6">
        <div class="container form-section-container" id="voucher-form">
        <h1 id="form-title">PHIẾU THU/CHI</h1>
        
        <!-- Progress Stepper -->
        <div class="progress-stepper">
            <div class="stepper-container">
                <div class="stepper-line"></div>
                <div class="stepper-line-progress" id="stepper-progress"></div>
                <div class="stepper-step active" data-step="1" onclick="goToStep(1)">
                    <div class="stepper-circle">1</div>
                    <div class="stepper-label">Thông tin cơ bản</div>
                </div>
                <div class="stepper-step" data-step="2" onclick="goToStep(2)">
                    <div class="stepper-circle">2</div>
                    <div class="stepper-label">Thông tin đối tượng</div>
                </div>
                <div class="stepper-step" data-step="3" onclick="goToStep(3)">
                    <div class="stepper-circle">3</div>
                    <div class="stepper-label">Chi tiết chi phí</div>
                </div>
                <div class="stepper-step" data-step="4" onclick="goToStep(4)">
                    <div class="stepper-circle">4</div>
                    <div class="stepper-label">Phê duyệt</div>
                </div>
                <div class="stepper-step" data-step="5" onclick="goToStep(5)">
                    <div class="stepper-circle">5</div>
                    <div class="stepper-label">Xem lại & Gửi</div>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Thông tin cơ bản -->
        <div class="form-step active" id="step-1">
        <div class="form-header">
            <div class="company-info">
                <div class="form-group">
                    <label for="company">Công ty:</label>
                    <select id="company" name="company" required onchange="updateCompanyDetails()">
                        <option value="">-- Chọn công ty --</option>
                    </select>
                    <div class="error-message"></div>
                    <div id="company-details" class="company-details">
                        <p id="company-address"></p>
                    </div>
                </div>
            </div>
            <div class="voucher-info">
                <div class="form-group">
                    <label for="voucher-type">Loại phiếu:</label>
                    <select id="voucher-type" name="voucher-type" required onchange="updateVoucherTitle()">
                        <option value="">-- Chọn loại phiếu --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="voucher-number">Số phiếu:</label>
                    <input type="text" id="voucher-number" name="voucher-number" value="TL-2023-" required readonly>
                </div>
                <div class="form-group">
                    <label for="voucher-date">Ngày lập phiếu:</label>
                    <input type="date" id="voucher-date" name="voucher-date" required>
                    <small class="form-hint" style="display: block; margin-top: 0.25rem; color: #6b7280; font-size: 0.875rem;">Chỉ được chọn ngày hiện tại trở đi</small>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="employee">Người đề nghị:</label>
                <select id="employee" name="employee" required onchange="updateEmployeeDepartment()">
                    <option value="">-- Chọn nhân viên --</option>
                </select>
                <div class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="department">Bộ phận:</label>
                <input type="text" id="department" name="department" readonly>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" disabled class="btn-prev">← Quay lại</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(2)">Tiếp theo →</button>
        </div>
        </div>
        
        <!-- Step 2: Thông tin đối tượng -->
        <div class="form-step" id="step-2">
        <h2>Thông tin đối tượng</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="payee-dropdown">Chọn người nộp/nhận:</label>
                <select id="payee-dropdown" name="payee-dropdown" onchange="document.getElementById('payee-name').value = this.value;">
                    <option value="">-- Chọn người nộp/nhận --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="payee-name">Họ tên người nộp/nhận:</label>
                <input type="text" id="payee-name" name="payee-name" required>
                <div class="error-message"></div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="reason">Lý do:</label>
                <textarea id="reason" name="reason" required></textarea>
                <div class="error-message"></div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="amount">Tổng số tiền:</label>
                <input type="text" id="amount" name="amount" required readonly>
            </div>
        </div>

        <!-- Signature Upload Section -->
        <div class="form-row">
            <div class="form-group" style="width: 100%;">
                <label for="signature-upload">Chữ ký người đề nghị: <span class="required">*</span></label>
                <div class="signature-container">
                    <div class="signature-preview-area" id="signature-preview-area">
                        <img id="signature-preview" src="" alt="Chữ ký" style="display: none; max-height: 80px;">
                        <span id="signature-placeholder">Chưa có chữ ký</span>
                    </div>
                    <div class="signature-actions">
                        <label for="signature-upload" class="btn-secondary signature-upload-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            Tải chữ ký lên
                        </label>
                        <input type="file" id="signature-upload" accept="image/*" style="display: none;" onchange="handleSignatureUpload(event)">
                        <button type="button" class="btn-secondary" onclick="clearSignature()" id="clear-signature-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            Xóa
                        </button>
                    </div>
                    <div class="signature-note">
                        <small>💡 Chữ ký sẽ được lưu để sử dụng cho các phiếu sau. Hỗ trợ: PNG, JPG, GIF (nền trong suốt khuyến nghị)</small>
                    </div>
                </div>
                <div class="error-message" id="signature-error"></div>
            </div>
        </div>

        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(1)">← Quay lại</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(3)">Tiếp theo →</button>
        </div>
        </div>
        
        <!-- Step 3: Chi tiết chi phí -->
        <div class="form-step" id="step-3">
        <h2>
            Bảng kê tài liệu đính kèm
            <span class="tooltip-icon">
                ℹ️
                <span class="tooltip-text">
                    HƯỚNG DẪN BẢNG KÊ CHI PHÍ: <br>
                    • STT: Tự động tăng, không cần nhập <br>
                    • Nội dung: Mô tả chi tiết khoản chi <br>
                    • Số tiền: Nhập số, tự động format tiền Việt Nam <br>
                    • Đính kèm: Tải lên các tài liệu liên quan đến khoản chi này
                </span>
            </span>
        </h2>
        
        <div class="expense-section-fields">
            <div class="form-row">
                <div class="form-group">
                    <label for="currency">Loại tiền:</label>
                    <select id="currency" name="currency" required>
                        <option value="">-- Chọn loại tiền --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
            </div>
            
            <!-- Hidden input for amount-in-words (for JavaScript compatibility) -->
            <input type="hidden" id="amount-in-words" name="amount-in-words">
        </div>
        
        <div class="table-actions">
            <button type="button" class="btn-secondary" id="add-row-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Thêm dòng
            </button>
            <button type="button" class="btn-secondary" id="copy-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Dán từ Excel
            </button>
            <button type="button" class="btn-secondary" id="import-table-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Nhập file Excel
            </button>
        </div>

        <div class="expense-table-container">
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Nội dung</th>
                        <th>Số tiền</th>
                        <th>Đính kèm</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                </tbody>
            </table>
            <div class="expense-table-footer">
                <div class="footer-row">
                    <span>Tổng cộng:</span> <span id="grand-total">0 VNĐ</span>
                </div>
                <div class="footer-row">
                    <span>Số tiền bằng chữ:</span> <span id="amount-in-words-display"></span>
                </div>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(2)">← Quay lại</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(4)">Tiếp theo →</button>
        </div>
        </div>
        
        <!-- Step 4: Phê duyệt -->
        <div class="form-step" id="step-4">
        <div class="approval-section">
            <div class="form-row">
                <div class="form-group">
                    <label for="approver">Người phê duyệt:</label>
                    <select id="approver" name="approver" required>
                        <option value="">-- Chọn người phê duyệt --</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                <div class="form-group">
                    <label for="approval-status-display">Trạng thái phê duyệt:</label>
                    <div class="status-indicator status-pending" id="approval-status-display">
                        Pending
                    </div>
                </div>
            </div>
            <div class="approval-history">
                <h3>Lịch sử phê duyệt</h3>
                <ul id="approval-history-list">
                    <li>Chưa có yêu cầu phê duyệt nào được gửi.</li>
                </ul>
            </div>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(3)">← Quay lại</button>
            <button type="button" class="btn-next" onclick="goToStepAfterEdit(5)">Tiếp theo →</button>
        </div>
        </div>
        
        <!-- Step 5: Xem lại & Gửi -->
        <div class="form-step" id="step-5">
        <h2>Xem lại thông tin</h2>
        
        <!-- Review Section - Full Details -->
        <div class="review-section" style="background: var(--background); padding: 2rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Thông tin chung</h3>
                <button type="button" onclick="editStepFromReview(1)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Chỉnh sửa
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Công ty</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-company">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Loại phiếu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-type">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Số phiếu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-number">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Ngày lập phiếu</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-date">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Người đề nghị</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-employee">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Bộ phận</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-department">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Người nộp/nhận</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-payee">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Chữ ký người đề nghị</div>
                    <div style="padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid var(--border); display: inline-block;">
                        <img id="review-signature" src="" alt="Chữ ký" style="max-height: 60px; max-width: 150px; display: none;">
                        <span id="review-signature-placeholder" style="color: #94a3b8; font-size: 0.875rem;">Chưa có</span>
                    </div>
                </div>
            </div>
            
            <!-- Phê duyệt section with edit button -->
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Thông tin phê duyệt</h3>
                    <button type="button" onclick="editStepFromReview(4)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Chỉnh sửa
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;">
                    <div class="review-item">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Người phê duyệt</div>
                        <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-approver-display">-</div>
                    </div>
                    <div class="review-item">
                        <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Trạng thái</div>
                        <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary);" id="review-status">Pending</div>
                    </div>
                </div>
            </div>
            
            <div class="review-item" style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.375rem;">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Lý do</div>
                    <button type="button" onclick="editStepFromReview(2)" class="btn-edit-review" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.375rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Chỉnh sửa
                    </button>
                </div>
                <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary); padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid var(--border);" id="review-reason">-</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Tổng số tiền</div>
                    <div style="font-size: 1.125rem; font-weight: 600; color: var(--primary);" id="review-amount">-</div>
                </div>
                <div class="review-item">
                    <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.375rem;">Số tiền bằng chữ</div>
                    <div style="font-size: 0.9375rem; font-weight: 500; color: var(--text-primary); font-style: italic;" id="review-amount-words">-</div>
                </div>
            </div>
            
            <!-- Chi tiết các khoản mục -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0;">Chi tiết các khoản mục</h3>
                <button type="button" onclick="editStepFromReview(3)" class="btn-edit-review" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    Chỉnh sửa
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden;">
                    <thead>
                        <tr style="background: var(--background);">
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">STT</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">Nội dung</th>
                            <th style="padding: 0.75rem; text-align: right; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">Số tiền</th>
                            <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid var(--border);">Đính kèm</th>
                        </tr>
                    </thead>
                    <tbody id="review-expense-items">
                        <tr>
                            <td colspan="4" style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">Chưa có dữ liệu</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="button-row">
            <button type="button" class="btn-primary" id="save-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Lưu phiếu
            </button>
            <button type="button" class="btn-success" id="send-approval-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                Gửi phê duyệt
            </button>
            <div class="loading-indicator" id="loading-indicator">
                <div class="spinner"></div>
                <span>Đang gửi...</span>
            </div>
            <button type="button" class="btn-secondary" id="export-pdf-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Xuất PDF
            </button>
            <button type="button" class="btn-secondary" id="export-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Xuất Excel
            </button>
            <button type="button" class="btn-secondary" id="import-excel-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Nhập từ Excel (Form)
            </button>
            <button type="button" class="btn-secondary" id="save-template-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Lưu Template
            </button>
            <button type="button" class="btn-secondary" id="load-template-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Load Template
            </button>
        </div>
        
        <div class="step-navigation">
            <button type="button" class="btn-prev" onclick="goToStep(4)">← Quay lại</button>
            <button type="button" class="btn-submit" onclick="sendForApproval()">Gửi phê duyệt</button>
        </div>
        </div>
    </div>
    
    <!-- Footer - Matching Intranet Style -->
    <footer class="mt-auto border-t border-slate-200 py-6 bg-white text-center text-xs text-slate-400">
        <p>&copy; 2025 TLCGroup. All rights reserved.</p>
    </footer>
    
    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="auto-save-indicator"></div>
    
    <!-- Confirmation Dialog -->
    <div class="confirmation-overlay" id="confirmation-overlay">
        <div class="confirmation-dialog">
            <h3 id="confirmation-title">Xác nhận</h3>
            <p id="confirmation-message"></p>
            <div class="confirmation-actions">
                <button type="button" class="btn-secondary" id="confirmation-cancel">Hủy</button>
                <button type="button" class="btn-danger" id="confirmation-confirm">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <!-- Recent Vouchers Section -->
    <div class="recent-vouchers-section">
        <div class="recent-vouchers-card">
            <div class="recent-vouchers-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <h3>📋 Phiếu gần đây</h3>
                    <span id="last-refresh-time" style="font-size: 0.75rem; color: #64748b; font-weight: normal;"></span>
                </div>
                <button class="refresh-btn" onclick="loadRecentVouchers()" title="Tự động làm mới mỗi 30 giây">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Làm mới
                </button>
            </div>
            <div class="voucher-stats" id="voucher-stats">
                <div class="stat-item pending">
                    <span class="stat-value" id="stat-pending">0</span>
                    <span class="stat-label">Chờ duyệt</span>
                </div>
                <div class="stat-item approved">
                    <span class="stat-value" id="stat-approved">0</span>
                    <span class="stat-label">Đã duyệt</span>
                </div>
                <div class="stat-item rejected">
                    <span class="stat-value" id="stat-rejected">0</span>
                    <span class="stat-label">Từ chối</span>
                </div>
            </div>
            <div class="voucher-list" id="voucher-list">
                <div class="no-vouchers">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <p>Đang tải danh sách phiếu...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voucher Detail Modal -->
    <div class="voucher-modal-overlay" id="voucher-modal-overlay" onclick="closeVoucherModal(event)">
        <div class="voucher-modal" onclick="event.stopPropagation()">
            <div class="voucher-modal-header">
                <h2 id="modal-title">Chi tiết phiếu</h2>
                <button class="modal-close-btn" onclick="closeVoucherModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="voucher-modal-body">
                <div class="modal-loading" id="modal-loading">
                    <div class="modal-spinner"></div>
                    <span>Đang tải...</span>
                </div>
                <div id="modal-content">
                    <!-- Voucher details will be loaded here -->
                </div>
            </div>
            <div class="voucher-modal-footer" id="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
            </div>
        </div>
    </div>
    
    <script>
        const data = (function(b64){
  const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  return JSON.parse(new TextDecoder('utf-8').decode(bytes));
})("eyJmb3JtX3RpdGxlIjoiUEhJ4bq+VSBUSFUvQ0hJIiwidm91Y2hlcl90eXBlcyI6WyJUaHUiLCJDaGkiXSwiY3VycmVuY3lfb3B0aW9ucyI6WyJWTsSQIiwiVVNEIiwiRVVSIl0sImNvbXBhbnlfbmFtZXMiOlsiQ8OUTkcgVFkgVE5ISCBUxq8gVuG6pE4gVExDIiwiQ8OUTkcgVFkgVE5ISCBFR0cgVkVOVFVSRVMiLCJDw5RORyBUWSBD4buUIFBI4bqmTiDEkOG6plUgVMavIENISU5IIFBIT05HIiwiQ8OUTkcgVFkgVE5ISCBNRURJQSBJTlNJREVSIiwiQ8OUTkcgVFkgQ+G7lCBQSOG6pk4gxJDhuqZVIFTGryBUTEMgR1JPVVAiLCJDw5RORyBUWSBD4buUIFBI4bqmTiBXT1JLU01BUlQiLCJDw5RORyBUWSBD4buUIFBI4bqmTiBJTlNJREVSUyIsIkPDlE5HIFRZIFROSEggRUdHIFZFTlRVUkVTIiwiQ8OUTkcgVFkgVFLDgUNIIE5ISeG7hk0gSOG7rlUgSOG6oE4gROG7ikNIIFbhu6QgUklPVCBHQU1FUyJdLCJlbXBsb3llZV9uYW1lcyI6WyJMw6ogTmfDom4gQW5oIiwiTmd1eeG7hW4gVsSDbiBDaGluaCIsIkzDqiBUaMO5eSBMaW5oIiwiTmd1eeG7hW4gTOG7sWMiLCJMw6ogTWluaCIsIkzDqiBNaW5oIEFuaCIsIk5ndXnhu4VuIFRo4buLIE5oYW5oIiwiTMawIEvhu7MgTmjDoyIsIk5ndXllbiBQaG9uZyIsIlRy4bqnbiBUaGFuaCIsIkFuaCBUaMawIFRow6FpIFRo4buLIiwiTmd1eeG7hW4gTMawIEFuaCBUaMawIiwiTmd1eWVuIFRpbW90aHkiLCJOZ3V5ZW4gVGluYSBMaW5oIiwiUGjhuqFtIFRyw60iXSwiYXBwcm92ZXJfbmFtZXMiOlsiTMOqIE5nw6JuIEFuaCIsIk5ndXnhu4VuIFbEg24gQ2hpbmgiLCJMw6ogVGjDuXkgTGluaCIsIk5ndXnhu4VuIEzhu7FjIiwiTMOqIE1pbmgiLCJMw6ogTWluaCBBbmgiLCJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkzGsCBL4buzIE5ow6MiLCJOZ3V5ZW4gUGhvbmciLCJUcuG6p24gVGhhbmgiLCJBbmggVGjGsCBUaMOhaSBUaOG7iyIsIk5ndXnhu4VuIEzGsCBBbmggVGjGsCIsIk5ndXllbiBUaW1vdGh5IiwiTmd1eWVuIFRpbmEgTGluaCIsIlBo4bqhbSBUcsOtIl0sImNvbXBhbmllc19kYXRhIjpbeyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IlRMQyIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIFTGryBW4bqkTiBUTEMiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxMzUxOTc1NiIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJFLlYiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgVE5ISCBFR0cgVkVOVFVSRVMiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNDQ5NDA2MCIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJDLlAiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgQ+G7lCBQSOG6pk4gxJDhuqZVIFTGryBDSElOSCBQSE9ORyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE0MDk3NTA3IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6Ik0uSSIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIE1FRElBIElOU0lERVIiLCLEkOG7i2EgY2jhu4kiOiJCLjMuMDksIFThuqduZyAzLCBMw7QgQiwgU+G7kSAzNC0zNSBC4bq/biBWw6JuIMSQ4buTbiwgUGjGsOG7nW5nIDEzLCBRdeG6rW4gNCwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5oLCBWaeG7h3QgTmFtIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNTM4MDQyOSIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiYW5oLmxlQG1lZGlhaW5zaWRlci52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiTMOqIE5nw6JuIEFuaCIsIkNo4buvIGvDvSDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IiIsIkVtYWlsIEvhur8gdG/DoW4gdHLGsOG7n25nIjoibmd1eWVubmhhbmg4NjNAZ21haWwuY29tIiwiS+G6vyB0b8OhbiB0csaw4bufbmciOiJOZ3V54buFbiBUaOG7iyBOaGFuaCIsIkNo4buvIGvDvSBL4bq/IHRvw6FuIHRyxrDhu59uZyI6IiIsIkVtYWlsIFRo4bunIHF14bu5IjoibGluaC5sZUB0bC1jLmNvbS52biIsIlRo4bunIHF14bu5IjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IFRo4bunIHF14bu5IjoiIiwiTmfDoHkgaGnhu4d1IGzhu7FjIjoiMTIvMjIvMjAyNSJ9LHsiVMOqbiBjw7RuZyB0eSB2aeG6v3QgdOG6r3QiOiJUTENHIiwiVMOqbiBjw7RuZyB0eSI6IkPDlE5HIFRZIEPhu5QgUEjhuqZOIMSQ4bqmVSBUxq8gVExDIEdST1VQIiwixJDhu4thIGNo4buJIjoiQi4zLjA5LCBU4bqnbmcgMywgTMO0IEIsIFPhu5EgMzQtMzUgQuG6v24gVsOibiDEkOG7k24sIFBoxrDhu51uZyAxMywgUXXhuq1uIDQsIFRow6BuaCBwaOG7kSBI4buTIENow60gTWluaCwgVmnhu4d0IE5hbSIsIk3DoyBz4buRIHRodeG6vyI6IjAzMTUzMDc2NzYiLCJFbWFpbCDEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6ImFuaC5sZUBtZWRpYWluc2lkZXIudm4iLCLEkOG6oWkgZGnhu4duIHBow6FwIGx14bqtdCI6IkzDqiBOZ8OibiBBbmgiLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTmd1eeG7hW4gVGjhu4sgTmhhbmgiLCJDaOG7ryBrw70gS+G6vyB0b8OhbiB0csaw4bufbmciOiIiLCJFbWFpbCBUaOG7pyBxdeG7uSI6ImxpbmgubGVAdGwtYy5jb20udm4iLCJUaOG7pyBxdeG7uSI6IkzDqiBUaHXhu7MgTGluaCIsIkNo4buvIGvDvSBUaOG7pyBxdeG7uSI6IiIsIk5nw6B5IGhp4buHdSBs4buxYyI6IjEyLzIyLzIwMjUifSx7IlTDqm4gY8O0bmcgdHkgdmnhur90IHThuq90IjoiVy5TIiwiVMOqbiBjw7RuZyB0eSI6IkPDlE5HIFRZIEPhu5QgUEjhuqZOIFdPUktTTUFSVCIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE1MjQwMjA2IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IklOUyIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBD4buUIFBI4bqmTiBJTlNJREVSUyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgWMOzbSBDaGnhur91LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzEzNTIyODA4IiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTmd1eeG7hW4gVGjhu4sgTmhhbmgiLCJDaOG7ryBrw70gS+G6vyB0b8OhbiB0csaw4bufbmciOiIiLCJFbWFpbCBUaOG7pyBxdeG7uSI6ImxpbmgubGVAdGwtYy5jb20udm4iLCJUaOG7pyBxdeG7uSI6IkzDqiBUaHXhu7MgTGluaCIsIkNo4buvIGvDvSBUaOG7pyBxdeG7uSI6IiIsIk5nw6B5IGhp4buHdSBs4buxYyI6IjEyLzIyLzIwMjUifSx7IlTDqm4gY8O0bmcgdHkgdmnhur90IHThuq90IjoiRVZfS1RUXzIwNU5UUCIsIlTDqm4gY8O0bmcgdHkiOiJDw5RORyBUWSBUTkhIIEVHRyBWRU5UVVJFUyIsIsSQ4buLYSBjaOG7iSI6IkIuMy4wOSwgVOG6p25nIDMsIEzDtCBCLCBT4buRIDM0LTM1IELhur9uIFbDom4gxJDhu5NuLCBQaMaw4budbmcgMTMsIFF14bqtbiA0LCBUaMOgbmggcGjhu5EgSOG7kyBDaMOtIE1pbmgsIFZp4buHdCBOYW0iLCJNw6Mgc+G7kSB0aHXhur8iOiIwMzE0NDk0MDYwIiwiRW1haWwgxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJhbmgubGVAbWVkaWFpbnNpZGVyLnZuIiwixJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiJMw6ogTmfDom4gQW5oIiwiQ2jhu68ga8O9IMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiIiwiRW1haWwgS+G6vyB0b8OhbiB0csaw4bufbmciOiJuZ3V5ZW5uaGFuaDg2M0BnbWFpbC5jb20iLCJL4bq/IHRvw6FuIHRyxrDhu59uZyI6Ik5ndXnhu4VuIFRo4buLIE5oYW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In0seyJUw6puIGPDtG5nIHR5IHZp4bq/dCB04bqvdCI6IlJJT1QiLCJUw6puIGPDtG5nIHR5IjoiQ8OUTkcgVFkgVFLDgUNIIE5ISeG7hk0gSOG7rlUgSOG6oE4gROG7ikNIIFbhu6QgUklPVCBHQU1FUyIsIsSQ4buLYSBjaOG7iSI6IlThuqduZyAxMSwgVMOyYSBuaMOgIE1pc3Mgw6FvIETDoGksIHPhu5EgMjEgxJDGsOG7nW5nIE5ndXnhu4VuLCBQaMaw4budbmcgQuG6v24gTmdow6kgLCBRdeG6rW4gMSAsIFRQIEjhu5MgQ2jDrSBNaW5oIiwiTcOjIHPhu5EgdGh14bq/IjoiMDMxNDQxOTA3MCIsIkVtYWlsIMSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoibGluaC5sZUB0bC1jLmNvbS52biIsIsSQ4bqhaSBkaeG7h24gcGjDoXAgbHXhuq10IjoiUGjhuqFtIEtpw6puIFPGoW4iLCJDaOG7ryBrw70gxJDhuqFpIGRp4buHbiBwaMOhcCBsdeG6rXQiOiIiLCJFbWFpbCBL4bq/IHRvw6FuIHRyxrDhu59uZyI6Im5ndXllbm5oYW5oODYzQGdtYWlsLmNvbSIsIkvhur8gdG/DoW4gdHLGsOG7n25nIjoiTMOqIFRodeG7syBMaW5oIiwiQ2jhu68ga8O9IEvhur8gdG/DoW4gdHLGsOG7n25nIjoiIiwiRW1haWwgVGjhu6cgcXXhu7kiOiJsaW5oLmxlQHRsLWMuY29tLnZuIiwiVGjhu6cgcXXhu7kiOiJMw6ogVGh14buzIExpbmgiLCJDaOG7ryBrw70gVGjhu6cgcXXhu7kiOiIiLCJOZ8OgeSBoaeG7h3UgbOG7sWMiOiIxMi8yMi8yMDI1In1dfQ==");;

        // IMPORTANT: Replace this with your actual Google Apps Script Web App URL
        // Instructions:
        // 1. Go to script.google.com and create a new project.
        // 2. Copy the Apps Script code provided below into Code.gs.
        // 3. Save the project.
        // 4. Click "Deploy" -> "New deployment".
        // 5. Select "Web app" as the type.
        // 6. Set "Execute as" to "Me" (your Google account).
        // 7. Set "Who has access" to "Anyone".
        // 8. Click "Deploy".
        // 9. Copy the "Web app URL" and paste it here.
        // 10. Ensure your Google account has permissions to send emails via Gmail (usually default).
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyFSl3pcx0hEElPj35GhOpK2I2372t7T4jZ7aGQjJZPIx1-NgNqNPEAn9XQlKB-urni/exec';

        // Initialize email mappings based on provided exact emails and company data
        const employeeEmailMap = {
            "Lê Ngân Anh": "anh.le@mediainsider.vn",
            "Nguyễn Văn Chinh": "chinh.nguyen@mediainsider.vn",
            "Lê Thùy Linh": "linh.le@tl-c.com.vn",
            "Nguyễn Lực": "hieuluc.nguyen@gmail.com"
        };

        const approverEmailMap = {
            "Lê Ngân Anh": "anh.le@mediainsider.vn",
            "Nguyễn Văn Chinh": "chinh.nguyen@mediainsider.vn",
            "Lê Thùy Linh": "linh.le@tl-c.com.vn",
            "Nguyễn Lực": "hieuluc.nguyen@gmail.com"
        };

        // Augment employeeEmailMap and approverEmailMap with emails from companies_data
        data.companies_data.forEach(company => {
            if (company["Đại diện pháp luật"] && company["Email Đại diện pháp luật"]) {
                employeeEmailMap[company["Đại diện pháp luật"]] = company["Email Đại diện pháp luật"];
                approverEmailMap[company["Đại diện pháp luật"]] = company["Email Đại diện pháp luật"];
            }
            if (company["Kế toán trưởng"] && company["Email Kế toán trưởng"]) {
                employeeEmailMap[company["Kế toán trưởng"]] = company["Email Kế toán trưởng"];
                approverEmailMap[company["Kế toán trưởng"]] = company["Email Kế toán trưởng"];
            }
            if (company["Thủ quỹ"] && company["Email Thủ quỹ"]) {
                employeeEmailMap[company["Thủ quỹ"]] = company["Email Thủ quỹ"];
                // Thủ quỹ might not always be an approver, but including for completeness if they are in approver_names
                approverEmailMap[company["Thủ quỹ"]] = company["Email Thủ quỹ"];
            }
        });

        // Add employee departments (assuming this data exists or can be derived)
        // For demonstration, creating a simple map. In a real app, this would come from backend.
        data.employee_departments = {};
        data.employee_names.forEach(name => {
            if (name === "Lê Ngân Anh") data.employee_departments[name] = "Ban Giám đốc";
            else if (name === "Nguyễn Văn Chinh") data.employee_departments[name] = "Phòng Kinh doanh";
            else if (name === "Lê Thùy Linh") data.employee_departments[name] = "Phòng Kế toán";
            else if (name === "Nguyễn Lực") data.employee_departments[name] = "Phòng Kỹ thuật";
            else if (name === "Nguyễn Thị Nhanh") data.employee_departments[name] = "Phòng Kế toán";
            else data.employee_departments[name] = "Phòng ban khác";
        });


        let expenseItems = [];
        let approvalHistory = [];
        let autoSaveTimeout = null;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const AUTO_SAVE_DELAY = 2000; // 2 seconds
        let currentStep = 1; // Current step in the stepper
        let highestStepReached = 1; // Track the highest step user has reached
        let editingFromReview = false; // Flag to know if user is editing from review step

        // Toast Notification Functions
        function showToast(message, type = 'info', title = '') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                info: 'ℹ️',
                warning: '⚠️'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Confirmation Dialog Functions
        function showConfirmation(message, title = 'Xác nhận') {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmation-overlay');
                const titleEl = document.getElementById('confirmation-title');
                const messageEl = document.getElementById('confirmation-message');
                const confirmBtn = document.getElementById('confirmation-confirm');
                const cancelBtn = document.getElementById('confirmation-cancel');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.classList.add('show');
                
                const handleConfirm = () => {
                    overlay.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    overlay.classList.remove('show');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        // Validation Functions
        function validateField(fieldId, value, fieldName) {
            const field = document.getElementById(fieldId);
            const errorEl = field.parentElement.querySelector('.error-message');
            
            if (!field) return true;
            
            let isValid = true;
            let errorMessage = '';
            
            // Required field validation
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = `${fieldName} là bắt buộc`;
            }
            
            // Specific validations
            if (value) {
                if (fieldId === 'payee-name' && value.length < 2) {
                    isValid = false;
                    errorMessage = 'Tên người nộp/nhận phải có ít nhất 2 ký tự';
                }
                if (fieldId === 'reason' && value.length < 10) {
                    isValid = false;
                    errorMessage = 'Lý do phải có ít nhất 10 ký tự';
                }
            }
            
            // Update UI
            if (isValid) {
                field.classList.remove('invalid');
                field.classList.add('valid');
                if (errorEl) {
                    errorEl.classList.remove('show');
                }
            } else {
                field.classList.remove('valid');
                field.classList.add('invalid');
                if (errorEl) {
                    errorEl.textContent = errorMessage;
                    errorEl.classList.add('show');
                } else {
                    const newErrorEl = document.createElement('div');
                    newErrorEl.className = 'error-message show';
                    newErrorEl.textContent = errorMessage;
                    field.parentElement.appendChild(newErrorEl);
                }
            }
            
            return isValid;
        }

        function validateAllFields() {
            const fields = [
                { id: 'company', name: 'Công ty' },
                { id: 'voucher-type', name: 'Loại phiếu' },
                { id: 'employee', name: 'Người đề nghị' },
                { id: 'payee-name', name: 'Người nộp/nhận' },
                { id: 'currency', name: 'Loại tiền' },
                { id: 'reason', name: 'Lý do' }
            ];
            
            let isValid = true;
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!validateField(field.id, element ? element.value : '', field.name)) {
                    isValid = false;
                }
            });
            
            // Validate expense items
            if (expenseItems.length === 0) {
                showToast('Vui lòng nhập ít nhất một dòng chi tiết', 'error');
                isValid = false;
            } else {
                const invalidItems = expenseItems.filter(item => !item.content || item.amount === 0);
                if (invalidItems.length > 0) {
                    showToast('Vui lòng điền đầy đủ Nội dung và Số tiền cho tất cả các dòng', 'error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Auto-save Functions
        function saveToLocalStorage() {
            try {
                const formData = {
                    company: document.getElementById('company').value,
                    voucherType: document.getElementById('voucher-type').value,
                    employee: document.getElementById('employee').value,
                    payeeName: document.getElementById('payee-name').value,
                    currency: document.getElementById('currency').value,
                    reason: document.getElementById('reason').value,
                    voucherDate: getCurrentVoucherDate(), // Always use current system date
                    voucherNumber: document.getElementById('voucher-number').value,
                    approver: document.getElementById('approver').value,
                    expenseItems: expenseItems.map(item => ({
                        content: item.content,
                        amount: item.amount,
                        attachments: item.attachments.map(f => ({ name: f.name, size: f.size }))
                    })),
                    approvalHistory: approvalHistory,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('voucher_draft', JSON.stringify(formData));
                showAutoSaveIndicator('saved');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('voucher_draft');
                if (saved) {
                    const formData = JSON.parse(saved);
                    
                    // Restore form fields
                    if (formData.company) document.getElementById('company').value = formData.company;
                    if (formData.voucherType) {
                        document.getElementById('voucher-type').value = formData.voucherType;
                        updateVoucherTitle(); // Update title when loading saved data
                    }
                    if (formData.employee) {
                        document.getElementById('employee').value = formData.employee;
                        updateEmployeeDepartment();
                    }
                    if (formData.payeeName) document.getElementById('payee-name').value = formData.payeeName;
                    if (formData.currency) document.getElementById('currency').value = formData.currency;
                    if (formData.reason) document.getElementById('reason').value = formData.reason;
                    // Don't restore voucherDate from localStorage - always use current date
                    // This prevents back date submission
                    // if (formData.voucherDate) document.getElementById('voucher-date').value = formData.voucherDate;
                    if (formData.voucherNumber) document.getElementById('voucher-number').value = formData.voucherNumber;
                    if (formData.approver) document.getElementById('approver').value = formData.approver;
                    
                    // Restore expense items (without file objects)
                    if (formData.expenseItems && formData.expenseItems.length > 0) {
                        expenseItems = formData.expenseItems.map(item => ({
                            content: item.content,
                            amount: item.amount,
                            attachments: [] // Files can't be restored from localStorage
                        }));
                        renderExpenseTable();
                    }
                    
                    if (formData.approvalHistory) {
                        approvalHistory = formData.approvalHistory;
                        renderApprovalHistory();
                    }
                    
                    updateCompanyDetails();
                    updateGrandTotal();
                    
                    showToast('Đã khôi phục dữ liệu đã lưu', 'info', 'Khôi phục');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }

        function showAutoSaveIndicator(status) {
            const indicator = document.getElementById('auto-save-indicator');
            indicator.className = `auto-save-indicator ${status} show`;
            
            if (status === 'saving') {
                indicator.textContent = 'Đang lưu...';
            } else if (status === 'saved') {
                indicator.textContent = 'Đã lưu tự động';
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function debounceAutoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            showAutoSaveIndicator('saving');
            autoSaveTimeout = setTimeout(() => {
                saveToLocalStorage();
            }, AUTO_SAVE_DELAY);
        }

        // File Validation
        function validateFile(file) {
            if (file.size > MAX_FILE_SIZE) {
                showToast(`File "${file.name}" quá lớn. Kích thước tối đa là 10MB`, 'error');
                return false;
            }
            return true;
        }

        // Function to update voucher title based on voucher type
        function updateVoucherTitle() {
            const voucherType = document.getElementById('voucher-type').value;
            const titleElement = document.getElementById('form-title');
            
            if (voucherType === 'Thu') {
                titleElement.textContent = 'PHIẾU THU';
            } else if (voucherType === 'Chi') {
                titleElement.textContent = 'PHIẾU CHI';
            } else {
                titleElement.textContent = 'PHIẾU THU/CHI';
            }
        }
        
        // Step Navigation Functions
        function validateStep(step) {
            switch(step) {
                case 1:
                    const company = document.getElementById('company').value;
                    const voucherType = document.getElementById('voucher-type').value;
                    const employee = document.getElementById('employee').value;
                    return company && voucherType && employee;
                case 2:
                    const payeeName = document.getElementById('payee-name').value;
                    const reason = document.getElementById('reason').value;
                    return payeeName && reason;
                case 3:
                    const currency = document.getElementById('currency').value;
                    return currency && expenseItems.length > 0 && 
                           expenseItems.every(item => item.content && item.amount > 0);
                case 4:
                    const approver = document.getElementById('approver').value;
                    return approver;
                case 5:
                    return true; // Review step, no validation needed
                default:
                    return false;
            }
        }
        
        function goToStep(step) {
            // Validate current step before moving (only if moving forward and not editing from review)
            if (step > currentStep && !editingFromReview && !validateStep(currentStep)) {
                showToast('Vui lòng điền đầy đủ thông tin ở bước hiện tại', 'error', 'Thiếu thông tin');
                return;
            }
            
            // Hide all steps
            document.querySelectorAll('.form-step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            // Show target step
            const targetStep = document.getElementById(`step-${step}`);
            if (targetStep) {
                targetStep.classList.add('active');
                currentStep = step;
                
                // Update highest step reached
                if (step > highestStepReached) {
                    highestStepReached = step;
                }
                
                updateStepperProgress();
                
                // Update review section if on step 5
                if (step === 5) {
                    updateReviewSection();
                    editingFromReview = false; // Reset flag when reaching review step
                }
                
                // Scroll to top of form
                document.getElementById('voucher-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function editStepFromReview(stepToEdit) {
            // Set flag to indicate we're editing from review
            editingFromReview = true;
            
            // Go to the step to edit
            goToStep(stepToEdit);
            
            showToast(`Đã chuyển đến bước ${stepToEdit} để chỉnh sửa`, 'info', 'Chỉnh sửa');
        }
        
        function goToStepAfterEdit(nextStep) {
            // If editing from review, go back to review step (5) after editing
            if (editingFromReview) {
                // Validate current step first
                if (!validateStep(currentStep)) {
                    showToast('Vui lòng điền đầy đủ thông tin ở bước hiện tại', 'error', 'Thiếu thông tin');
                    return;
                }
                
                // Validate signature if leaving step 2
                if (currentStep === 2 && !validateSignature()) {
                    showToast('Vui lòng tải lên chữ ký', 'error', 'Thiếu chữ ký');
                    return;
                }
                
                // Go back to review step
                editingFromReview = false;
                goToStep(5);
            } else {
                // Validate signature if leaving step 2
                if (currentStep === 2 && nextStep > 2 && !validateSignature()) {
                    showToast('Vui lòng tải lên chữ ký', 'error', 'Thiếu chữ ký');
                    return;
                }
                
                // Normal flow - go to next step
                goToStep(nextStep);
            }
        }
        
        function updateStepperProgress() {
            // Update stepper visual state
            const steps = document.querySelectorAll('.stepper-step');
            const progressLine = document.getElementById('stepper-progress');
            
            steps.forEach((stepEl, index) => {
                const stepNum = index + 1;
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < currentStep) {
                    stepEl.classList.add('completed');
                } else if (stepNum === currentStep) {
                    stepEl.classList.add('active');
                }
            });
            
            // Update progress line
            if (progressLine) {
                const progress = ((currentStep - 1) / (steps.length - 1)) * 100;
                progressLine.style.width = `${progress}%`;
            }
        }
        
        function updateReviewSection() {
            // Update review section with current form values
            // Helper function to safely set text content
            const safeSetText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || '-';
                } else {
                    console.warn(`Element with id "${id}" not found`);
                }
            };
            
            const companySelect = document.getElementById('company');
            const companyValue = companySelect ? companySelect.value : '';
            safeSetText('review-company', companyValue);
            
            const voucherTypeSelect = document.getElementById('voucher-type');
            const voucherTypeValue = voucherTypeSelect ? voucherTypeSelect.value : '';
            safeSetText('review-type', voucherTypeValue);
            
            const voucherNumber = document.getElementById('voucher-number');
            safeSetText('review-number', voucherNumber ? voucherNumber.value : '');
            
            // Display voucher date from form input (user selected date)
            const voucherDateInput = document.getElementById('voucher-date');
            let reviewDateText = '-';
            if (voucherDateInput && voucherDateInput.value) {
                const selectedDate = new Date(voucherDateInput.value);
                const formattedDate = selectedDate.toLocaleDateString('vi-VN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                reviewDateText = formattedDate;
            } else {
                // Fallback to current date if no date selected
                const now = new Date();
                const formattedDate = now.toLocaleDateString('vi-VN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                });
                reviewDateText = formattedDate;
            }
            safeSetText('review-date', reviewDateText);
            
            const employee = document.getElementById('employee');
            safeSetText('review-employee', employee ? employee.value : '');
            
            const department = document.getElementById('department');
            safeSetText('review-department', department ? department.value : '');
            
            const payeeName = document.getElementById('payee-name');
            safeSetText('review-payee', payeeName ? payeeName.value : '');
            
            // Update signature in review
            const reviewSignature = document.getElementById('review-signature');
            const reviewSignaturePlaceholder = document.getElementById('review-signature-placeholder');
            if (currentSignatureData) {
                reviewSignature.src = currentSignatureData;
                reviewSignature.style.display = 'block';
                reviewSignaturePlaceholder.style.display = 'none';
            } else {
                reviewSignature.style.display = 'none';
                reviewSignaturePlaceholder.style.display = 'block';
            }
            
            const reason = document.getElementById('reason');
            safeSetText('review-reason', reason ? reason.value : '');
            
            const amount = document.getElementById('amount');
            safeSetText('review-amount', amount ? amount.value : '');
            
            const amountInWordsInput = document.getElementById('amount-in-words');
            const amountInWordsDisplay = document.getElementById('amount-in-words-display');
            const amountInWords = (amountInWordsInput && amountInWordsInput.value) || 
                                  (amountInWordsDisplay ? amountInWordsDisplay.textContent : '');
            safeSetText('review-amount-words', amountInWords);
            
            const approverValue = document.getElementById('approver').value || '-';
            const reviewApproverDisplay = document.getElementById('review-approver-display');
            if (reviewApproverDisplay) {
                reviewApproverDisplay.textContent = approverValue;
            }
            // Note: review-approver element doesn't exist, only review-approver-display exists
            
            // Update status
            const statusDisplay = document.getElementById('approval-status-display');
            const statusText = statusDisplay ? statusDisplay.textContent : 'Pending';
            const reviewStatus = document.getElementById('review-status');
            if (reviewStatus) {
                reviewStatus.textContent = statusText;
            }
            
            // Update expense items table
            // First, try to get data from DOM (expense table) to ensure we have the latest data
            const expenseTableBody = document.getElementById('expense-table-body');
            let currentExpenseItems = expenseItems; // Use global expenseItems as default
            
            // If expense table exists, try to extract data from it
            if (expenseTableBody && expenseTableBody.rows.length > 0) {
                currentExpenseItems = [];
                Array.from(expenseTableBody.rows).forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length >= 3) {
                        const contentInput = cells[1].querySelector('input');
                        const amountInput = cells[2].querySelector('input');
                        const content = contentInput ? contentInput.value.trim() : '';
                        const amount = amountInput ? parseCurrency(amountInput.value) : 0;
                        
                        // Get attachments from the row's expenseItems entry if available
                        const attachments = (expenseItems[index] && expenseItems[index].attachments) 
                            ? expenseItems[index].attachments 
                            : [];
                        
                        if (content || amount > 0) {
                            currentExpenseItems.push({
                                content: content,
                                amount: amount,
                                attachments: attachments
                            });
                        }
                    }
                });
            }
            
            const reviewTableBody = document.getElementById('review-expense-items');
            if (reviewTableBody) {
                console.log('=== updateReviewSection: expenseItems ===', currentExpenseItems);
                console.log('expenseItems length:', currentExpenseItems ? currentExpenseItems.length : 0);
                
                if (!currentExpenseItems || currentExpenseItems.length === 0) {
                    reviewTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="padding: 1.5rem; text-align: center; color: var(--text-secondary);">Chưa có dữ liệu</td>
                        </tr>
                    `;
                } else {
                    const tableRows = currentExpenseItems.map((item, index) => {
                        console.log(`Processing item ${index}:`, item);
                        
                        // Handle attachments - can be File objects or plain objects with name property
                        let attachmentsList = 'Không có';
                        if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                            const fileNames = item.attachments.map(f => {
                                // Handle both File objects and plain objects
                                if (f instanceof File) {
                                    return f.name;
                                } else if (f && typeof f === 'object' && f.name) {
                                    return f.name;
                                }
                                return '';
                            }).filter(name => name); // Remove empty strings
                            
                            if (fileNames.length > 0) {
                                attachmentsList = fileNames.join(', ');
                            }
                        }
                        
                        const content = item.content || '-';
                        const amount = item.amount || 0;
                        const formattedAmount = formatCurrency(amount);
                        
                        console.log(`Item ${index} - Content: "${content}", Amount: ${amount}, Attachments: ${attachmentsList}`);
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary);">${index + 1}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary);">${escapeHtml(content)}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-primary); text-align: right; font-weight: 500;">${formattedAmount}</td>
                                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(attachmentsList)}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log('Generated table rows:', tableRows);
                    reviewTableBody.innerHTML = tableRows;
                }
            } else {
                console.error('review-expense-items element not found!');
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            generateVoucherNumber();
            renderExpenseTable();

            // Load saved data (but voucherDate will not be restored - always use current date)
            loadFromLocalStorage();
            
            // Load saved signature from localStorage
            loadSavedSignature();
            
            // Always set current date after loading saved data (to prevent back date)
            setCurrentDate();
            
            // Update title based on initial voucher type value
            updateVoucherTitle();
            
            // Initialize stepper
            updateStepperProgress();

            // Add event listeners for buttons
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('import-excel-btn').addEventListener('click', importFromExcelForm);
            // sync-sheets-btn removed - files now upload during sendForApproval
            document.getElementById('save-template-btn').addEventListener('click', saveTemplate);
            document.getElementById('load-template-btn').addEventListener('click', loadTemplate);
            document.getElementById('save-btn').addEventListener('click', saveVoucher);
            document.getElementById('send-approval-btn').addEventListener('click', sendForApproval);
            
            // Initialize searchable dropdowns
            initializeSearchableDropdowns();
            
            document.getElementById('add-row-btn').addEventListener('click', addExpenseRow);
            document.getElementById('copy-excel-btn').addEventListener('click', copyFromExcelToTable);
            document.getElementById('import-table-excel-btn').addEventListener('click', importExcelToTable);

            // Add real-time validation listeners
            const fieldsToValidate = ['company', 'voucher-type', 'employee', 'payee-name', 'currency', 'reason'];
            fieldsToValidate.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        const fieldNames = {
                            'company': 'Công ty',
                            'voucher-type': 'Loại phiếu',
                            'employee': 'Người đề nghị',
                            'payee-name': 'Người nộp/nhận',
                            'currency': 'Loại tiền',
                            'reason': 'Lý do'
                        };
                        validateField(fieldId, this.value, fieldNames[fieldId]);
                        debounceAutoSave();
                    });
                    
                    field.addEventListener('input', function() {
                        // Remove invalid class on input
                        if (this.classList.contains('invalid')) {
                            this.classList.remove('invalid');
                            const errorEl = this.parentElement.querySelector('.error-message');
                            if (errorEl) errorEl.classList.remove('show');
                        }
                        debounceAutoSave();
                    });
                }
            });

            renderApprovalHistory();
        });
        
        function initializeForm() {
            document.getElementById('form-title').textContent = data.form_title;
            
            const companySelect = document.getElementById('company');
            data.company_names.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
            
            const employeeSelect = document.getElementById('employee');
            const payeeDropdown = document.getElementById('payee-dropdown');
            data.employee_names.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeSelect.appendChild(option);

                const payeeOption = option.cloneNode(true);
                payeeDropdown.appendChild(payeeOption);
            });
            
            const voucherTypeSelect = document.getElementById('voucher-type');
            data.voucher_types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                voucherTypeSelect.appendChild(option);
            });
            
            const currencySelect = document.getElementById('currency');
            data.currency_options.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                currencySelect.appendChild(option);
            });
            
            const approverSelect = document.getElementById('approver');
            data.approver_names.forEach(approver => {
                const option = document.createElement('option');
                option.value = approver;
                option.textContent = approver;
                approverSelect.appendChild(option);
            });
        }
        
        function updateCompanyDetails() {
            const companySelect = document.getElementById('company');
            const companyDetails = document.getElementById('company-details');
            const companyAddress = document.getElementById('company-address');
            
            const selectedCompany = companySelect.value;
            
            if (selectedCompany) {
                const companyData = data.companies_data.find(c => c["Tên công ty"] === selectedCompany);
                if (companyData) {
                    companyAddress.textContent = `Địa chỉ: ${companyData["Địa chỉ"]}`;
                    companyDetails.classList.add('show');
                }
            } else {
                companyDetails.classList.remove('show');
            }
        }

        function updateEmployeeDepartment() {
            const employeeSelect = document.getElementById('employee');
            const departmentInput = document.getElementById('department');
            const selectedEmployee = employeeSelect.value;

            if (selectedEmployee && data.employee_departments) {
                departmentInput.value = data.employee_departments[selectedEmployee] || '';
            } else {
                departmentInput.value = '';
            }
        }
        
        // Helper function to get current system date (YYYY-MM-DD format)
        // Uses local date, not UTC, to match Mac system date
        function getCurrentVoucherDate() {
            const today = new Date();
            // Use local date to match Mac system date, not UTC
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Helper function to convert File to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // ============ SIGNATURE FUNCTIONS ============
        let currentSignatureData = null;
        const SIGNATURE_STORAGE_KEY = 'tlcg_user_signature';
        
        // Load saved signature on page load
        function loadSavedSignature() {
            const savedSignature = localStorage.getItem(SIGNATURE_STORAGE_KEY);
            if (savedSignature) {
                currentSignatureData = savedSignature;
                displaySignature(savedSignature);
                console.log('✅ Loaded saved signature from localStorage');
            }
        }
        
        // Handle signature file upload
        async function handleSignatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Vui lòng chọn file hình ảnh (PNG, JPG, GIF)', 'error');
                return;
            }
            
            // Validate file size (max 500KB)
            if (file.size > 500 * 1024) {
                showToast('Kích thước chữ ký tối đa 500KB', 'error');
                return;
            }
            
            try {
                const base64Data = await fileToBase64(file);
                currentSignatureData = base64Data;
                
                // Save to localStorage for future use
                localStorage.setItem(SIGNATURE_STORAGE_KEY, base64Data);
                
                // Display the signature
                displaySignature(base64Data);
                
                showToast('Đã tải chữ ký lên thành công! Chữ ký sẽ được lưu cho các phiếu sau.', 'success');
                console.log('✅ Signature uploaded and saved to localStorage');
            } catch (error) {
                console.error('Error uploading signature:', error);
                showToast('Lỗi khi tải chữ ký. Vui lòng thử lại.', 'error');
            }
        }
        
        // Display signature in preview area
        function displaySignature(base64Data) {
            const preview = document.getElementById('signature-preview');
            const placeholder = document.getElementById('signature-placeholder');
            const clearBtn = document.getElementById('clear-signature-btn');
            const errorDiv = document.getElementById('signature-error');
            
            if (base64Data) {
                preview.src = base64Data;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                clearBtn.style.display = 'inline-flex';
                errorDiv.textContent = '';
            } else {
                preview.src = '';
                preview.style.display = 'none';
                placeholder.style.display = 'block';
                clearBtn.style.display = 'none';
            }
        }
        
        // Clear signature
        function clearSignature() {
            if (confirm('Bạn có chắc muốn xóa chữ ký? Chữ ký đã lưu cũng sẽ bị xóa.')) {
                currentSignatureData = null;
                localStorage.removeItem(SIGNATURE_STORAGE_KEY);
                displaySignature(null);
                document.getElementById('signature-upload').value = '';
                showToast('Đã xóa chữ ký', 'info');
            }
        }
        
        // Validate signature before proceeding
        function validateSignature() {
            if (!currentSignatureData) {
                const errorDiv = document.getElementById('signature-error');
                errorDiv.textContent = 'Vui lòng tải lên chữ ký';
                return false;
            }
            return true;
        }
        
        // Get signature data for submission
        function getSignatureData() {
            return currentSignatureData;
        }
        // ============ END SIGNATURE FUNCTIONS ============
        
        // ============ RECENT VOUCHERS & APPROVAL FUNCTIONS ============
        let currentModalVoucher = null;
        let currentModalMeta = null; // Merged meta from all history entries
        let approverSignatureData = null;
        const APPROVER_SIGNATURE_KEY = 'tlcg_approver_signature';
        
        // Get current user's email from the employee dropdown
        function getCurrentUserEmail() {
            const employeeSelect = document.getElementById('employee');
            if (employeeSelect && employeeSelect.value) {
                return employeeEmailMap[employeeSelect.value] || '';
            }
            return '';
        }
        
        // Get current user's name from the employee dropdown
        function getCurrentUserName() {
            const employeeSelect = document.getElementById('employee');
            return employeeSelect ? employeeSelect.value : '';
        }
        
        // Check if current user is the requester of the voucher
        function isCurrentUserRequester(voucher) {
            const currentEmail = getCurrentUserEmail().toLowerCase().trim();
            const currentName = getCurrentUserName().toLowerCase().trim();
            const voucherRequestorEmail = (voucher.requestorEmail || '').toLowerCase().trim();
            const voucherEmployee = (voucher.employee || '').toLowerCase().trim();
            
            // Match by email or employee name
            const isRequester = (currentEmail && voucherRequestorEmail && currentEmail === voucherRequestorEmail) ||
                               (currentName && voucherEmployee && currentName === voucherEmployee);
            
            console.log('User role check:', {
                currentEmail,
                currentName,
                voucherRequestorEmail,
                voucherEmployee,
                isRequester
            });
            
            return isRequester;
        }
        
        // Load recent vouchers from backend
        async function loadRecentVouchers() {
            const voucherList = document.getElementById('voucher-list');
            voucherList.innerHTML = `
                <div class="no-vouchers">
                    <div class="modal-spinner" style="margin: 0 auto 1rem;"></div>
                    <p>Đang tải danh sách phiếu...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getVoucherSummary`, {
                    method: 'GET'
                });
                
                const result = await response.json();
                console.log('Voucher summary:', result);
                
                if (result.success && result.data) {
                    // Update stats
                    document.getElementById('stat-pending').textContent = result.data.pending || 0;
                    document.getElementById('stat-approved').textContent = result.data.approved || 0;
                    document.getElementById('stat-rejected').textContent = result.data.rejected || 0;
                    
                    // Render voucher list
                    const vouchers = result.data.recent || [];
                    if (vouchers.length === 0) {
                        voucherList.innerHTML = `
                            <div class="no-vouchers">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                <p>Chưa có phiếu nào</p>
                            </div>
                        `;
                    } else {
                        voucherList.innerHTML = vouchers.map(v => renderVoucherItem(v)).join('');
                    }
                } else {
                    voucherList.innerHTML = `
                        <div class="no-vouchers">
                            <p style="color: #ef4444;">Không thể tải danh sách phiếu</p>
                            <p style="font-size: 0.75rem; margin-top: 0.5rem;">${result.message || 'Vui lòng thử lại'}</p>
                        </div>
                    `;
                }
                
                // Update last refresh time
                const lastRefreshEl = document.getElementById('last-refresh-time');
                if (lastRefreshEl) {
                    const now = new Date();
                    lastRefreshEl.textContent = `(Cập nhật: ${now.toLocaleTimeString('vi-VN')})`;
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
                voucherList.innerHTML = `
                    <div class="no-vouchers">
                        <p style="color: #ef4444;">Lỗi kết nối</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem;">Vui lòng kiểm tra kết nối mạng</p>
                    </div>
                `;
            }
        }
        
        // Render a single voucher item
        function renderVoucherItem(voucher) {
            const statusClass = (voucher.status || 'Pending').toLowerCase();
            const statusText = {
                'pending': 'Chờ duyệt',
                'approved': 'Đã duyệt',
                'rejected': 'Từ chối'
            }[statusClass] || voucher.status;
            
            const statusIcon = {
                'pending': '<i class="fas fa-clock"></i>',
                'approved': '<i class="fas fa-check"></i>',
                'rejected': '<i class="fas fa-times"></i>'
            }[statusClass] || '<i class="fas fa-file"></i>';
            
            const amount = typeof voucher.amount === 'number' 
                ? voucher.amount.toLocaleString('vi-VN') + ' ₫'
                : voucher.amount || '0 ₫';
            
            return `
                <div class="voucher-item" onclick="openVoucherDetail('${voucher.voucherNumber}')">
                    <div class="voucher-icon ${statusClass}">
                        ${statusIcon}
                    </div>
                    <div class="voucher-info">
                        <div class="voucher-title">${voucher.voucherNumber || 'N/A'} - ${voucher.voucherType || ''}</div>
                        <div class="voucher-meta">${voucher.employee || ''} • ${voucher.company || ''} • ${voucher.timestamp || ''}</div>
                    </div>
                    <div class="voucher-amount">${amount}</div>
                    <span class="voucher-status ${statusClass}">${statusText}</span>
                </div>
            `;
        }
        
        // Open voucher detail modal
        async function openVoucherDetail(voucherNumber) {
            console.log('=== OPENING VOUCHER DETAIL ===');
            console.log('Voucher Number:', voucherNumber);
            
            const modal = document.getElementById('voucher-modal-overlay');
            const modalContent = document.getElementById('modal-content');
            const modalLoading = document.getElementById('modal-loading');
            const modalFooter = document.getElementById('modal-footer');
            
            if (!modal) {
                console.error('Modal overlay not found!');
                return;
            }
            
            modal.classList.add('show');
            modalLoading.classList.add('show');
            modalContent.innerHTML = '';
            modalFooter.innerHTML = '<button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>';
            
            // Load approver signature from localStorage
            approverSignatureData = localStorage.getItem(APPROVER_SIGNATURE_KEY);
            
            try {
                console.log('Fetching voucher history from:', `${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getVoucherHistory&voucherNumber=${encodeURIComponent(voucherNumber)}`);
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_WEB_APP_URL}?action=getVoucherHistory&voucherNumber=${encodeURIComponent(voucherNumber)}`);
                const result = await response.json();
                
                console.log('Voucher history response:', result);
                
                modalLoading.classList.remove('show');
                
                // Handle both formats: result.data (array) or result.data.history (object with history array)
                let historyData = result.data;
                if (result.data && result.data.history) {
                    historyData = result.data.history;
                }
                
                console.log('History data:', historyData);
                
                if (result.success && historyData && historyData.length > 0) {
                    // Get the most recent entry (first one since sorted by timestamp desc)
                    const voucher = historyData[0];
                    currentModalVoucher = voucher;
                    
                    // Merge meta from all history entries for print function
                    currentModalMeta = {};
                    let mergedAttachments = voucher.attachments || '';
                    
                    historyData.forEach(h => {
                        if (h.meta) {
                            currentModalMeta = { ...currentModalMeta, ...h.meta };
                        }
                        // Get attachments from any history entry (usually the Submit entry has it)
                        if (h.attachments && !mergedAttachments) {
                            mergedAttachments = h.attachments;
                        }
                    });
                    if (voucher.meta) {
                        currentModalMeta = { ...currentModalMeta, ...voucher.meta };
                    }
                    
                    // Store merged attachments URL back to voucher object
                    voucher.attachments = mergedAttachments;
                    
                    console.log('Current voucher:', voucher);
                    console.log('Voucher status:', voucher.status);
                    console.log('Voucher attachments:', voucher.attachments);
                    console.log('Merged modal meta:', currentModalMeta);
                    
                    // Check if current user is the requester
                    const isRequester = isCurrentUserRequester(voucher);
                    console.log('Is current user the requester:', isRequester);
                    
                    document.getElementById('modal-title').textContent = `Phiếu ${voucher.voucherNumber}`;
                    
                    // Render voucher details (pass isRequester to hide approver signature section)
                    modalContent.innerHTML = renderVoucherDetails(voucher, historyData, isRequester);
                    
                    // Add action buttons based on voucher status AND user role
                    if (voucher.status === 'Pending') {
                        if (isRequester) {
                            // Requester can only view and print their pending request
                            modalFooter.innerHTML = `
                                <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
                                <button class="modal-btn" style="background: #6366f1; color: white;" onclick="printVoucher()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    In phiếu
                                </button>
                            `;
                        } else {
                            // Approver can approve or reject
                            modalFooter.innerHTML = `
                                <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
                                <button class="modal-btn" style="background: #6366f1; color: white;" onclick="printVoucher()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    In phiếu
                                </button>
                                <button class="modal-btn modal-btn-reject" onclick="rejectFromModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    Từ chối
                                </button>
                                <button class="modal-btn modal-btn-approve" onclick="approveFromModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Phê duyệt
                                </button>
                            `;
                        }
                    } else if (voucher.status === 'Rejected') {
                        if (isRequester) {
                            // Requester can edit and resubmit their rejected voucher
                            modalFooter.innerHTML = `
                                <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
                                <button class="modal-btn" style="background: #6366f1; color: white;" onclick="printVoucher()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    In phiếu
                                </button>
                                <button class="modal-btn" style="background: #3b82f6; color: white;" onclick="editVoucherFromModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    Chỉnh sửa & Gửi lại
                                </button>
                            `;
                        } else {
                            // Others can only view and print rejected vouchers
                            modalFooter.innerHTML = `
                                <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
                                <button class="modal-btn" style="background: #6366f1; color: white;" onclick="printVoucher()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    In phiếu
                                </button>
                            `;
                        }
                    } else {
                        // Approved vouchers - review and print only
                        modalFooter.innerHTML = `
                            <button class="modal-btn modal-btn-secondary" onclick="closeVoucherModal()">Đóng</button>
                            <button class="modal-btn" style="background: #6366f1; color: white;" onclick="printVoucher()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                In phiếu
                            </button>
                        `;
                    }
                } else {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            <p>Không tìm thấy thông tin phiếu</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading voucher details:', error);
                modalLoading.classList.remove('show');
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <p>Lỗi tải thông tin phiếu</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Render voucher details HTML
        // isRequester: boolean - if true, hide approver signature upload section
        function renderVoucherDetails(voucher, historyList, isRequester = false) {
            const statusClass = (voucher.status || 'Pending').toLowerCase();
            const statusText = {
                'pending': 'Chờ duyệt',
                'approved': 'Đã duyệt',
                'rejected': 'Từ chối'
            }[statusClass] || voucher.status;
            
            // Merge meta data from all history entries
            // (submission entry has requesterSignature, approval/rejection has approverSignature)
            let meta = {};
            let attachmentsUrl = voucher.attachments || ''; // Start with current voucher's attachments
            
            if (historyList && historyList.length > 0) {
                historyList.forEach(h => {
                    if (h.meta) {
                        meta = { ...meta, ...h.meta };
                    }
                    // Get attachments from any history entry (usually the Submit entry has it)
                    if (h.attachments && !attachmentsUrl) {
                        attachmentsUrl = h.attachments;
                    }
                });
            }
            // Also include current voucher's meta
            if (voucher.meta) {
                meta = { ...meta, ...voucher.meta };
            }
            
            // Store merged attachments URL for use in the template
            voucher.attachments = attachmentsUrl;
            
            console.log('Merged meta data:', meta);
            console.log('Attachments URL:', attachmentsUrl);
            
            // Build history timeline
            let historyHtml = '';
            if (historyList && historyList.length > 0) {
                historyHtml = historyList.map((h, index) => {
                    const actionClass = (h.action || '').toLowerCase().includes('reject') ? 'rejected' : 
                                       (h.action || '').toLowerCase().includes('approve') ? 'approved' : 'pending';
                    return `
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; ${index < historyList.length - 1 ? 'border-bottom: 1px solid #f1f5f9;' : ''}">
                            <div class="voucher-icon ${actionClass}" style="width: 32px; height: 32px; font-size: 0.75rem; flex-shrink: 0;">
                                ${actionClass === 'approved' ? '<i class="fas fa-check"></i>' : actionClass === 'rejected' ? '<i class="fas fa-times"></i>' : '<i class="fas fa-paper-plane"></i>'}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; font-size: 0.875rem; color: #1e293b;">${h.action || 'Submitted'}</div>
                                <div style="font-size: 0.75rem; color: #64748b;">
                                    ${h.by || 'N/A'} • ${h.timestampFormatted || h.timestamp || ''}
                                </div>
                                ${h.note ? `<div style="font-size: 0.8125rem; color: #475569; margin-top: 0.25rem; font-style: italic;">"${h.note}"</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Approver signature section (only for pending AND only for approvers, not requesters)
            let approverSignatureSection = '';
            if (voucher.status === 'Pending' && !isRequester) {
                approverSignatureSection = `
                    <div class="approver-signature-section">
                        <h4>✍️ Chữ ký người phê duyệt</h4>
                        <div class="approver-signature-preview" id="approver-signature-preview">
                            ${approverSignatureData 
                                ? `<img src="${approverSignatureData}" alt="Chữ ký" id="approver-signature-img">`
                                : `<span style="color: #94a3b8; font-size: 0.875rem;" id="approver-signature-placeholder">Chưa có chữ ký</span>`
                            }
                        </div>
                        <div class="signature-actions">
                            <label class="btn-secondary signature-upload-btn" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">
                                <input type="file" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="handleApproverSignatureUpload(event)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                ${approverSignatureData ? 'Đổi chữ ký' : 'Tải lên chữ ký'}
                            </label>
                            ${approverSignatureData ? `
                                <button type="button" class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.8125rem; color: #ef4444;" onclick="clearApproverSignature()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    Xóa
                                </button>
                            ` : ''}
                        </div>
                        <div class="signature-note">
                            <small>💡 Chữ ký sẽ được lưu để sử dụng cho các phê duyệt sau</small>
                        </div>
                    </div>
                `;
            }
            
            // Role indicator for the user
            let roleIndicator = '';
            if (isRequester) {
                roleIndicator = `
                    <div style="background: #dbeafe; color: #1e40af; padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        <span>Bạn là <strong>người đề nghị</strong> phiếu này</span>
                    </div>
                `;
            }
            
            return `
                ${roleIndicator}
                <div class="voucher-detail-grid">
                    <div class="voucher-detail-item">
                        <div class="label">Số phiếu</div>
                        <div class="value">${voucher.voucherNumber || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Loại phiếu</div>
                        <div class="value">${voucher.voucherType || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Công ty</div>
                        <div class="value">${voucher.company || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Người đề nghị</div>
                        <div class="value">${voucher.employee || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Phòng ban</div>
                        <div class="value">${meta.department || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Người nhận tiền</div>
                        <div class="value">${meta.payeeName || voucher.employee || 'N/A'}</div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Số tiền</div>
                        <div class="value" style="color: #059669; font-weight: 600;">
                            ${typeof voucher.amount === 'number' ? voucher.amount.toLocaleString('vi-VN') + ' ₫' : voucher.amount || '0 ₫'}
                        </div>
                    </div>
                    <div class="voucher-detail-item">
                        <div class="label">Trạng thái</div>
                        <div class="value">
                            <span class="voucher-status ${statusClass}" style="display: inline-block;">${statusText}</span>
                        </div>
                    </div>
                </div>
                
                ${voucher.note ? `
                <div class="voucher-detail-section">
                    <h4>📝 Nội dung / Lý do</h4>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; color: #334155; line-height: 1.6;">
                        ${voucher.note}
                    </div>
                </div>
                ` : ''}
                
                ${meta.amountInWords ? `
                <div class="voucher-detail-section">
                    <h4>💰 Số tiền bằng chữ</h4>
                    <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; color: #065f46; font-style: italic;">
                        ${meta.amountInWords}
                    </div>
                </div>
                ` : ''}
                
                ${voucher.attachments ? `
                <div class="voucher-detail-section">
                    <h4>📎 Tài liệu đính kèm</h4>
                    <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; border: 1px solid #bfdbfe;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                            <span style="font-weight: 600; color: #1e40af;">Chứng từ hỗ trợ trên Google Drive</span>
                        </div>
                        <p style="font-size: 0.8125rem; color: #64748b; margin-bottom: 0.75rem;">
                            Vui lòng xem xét tất cả tài liệu đính kèm trước khi phê duyệt hoặc từ chối.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${(function() {
                                // Parse attachments: format is "filename|url\nfilename2|url2" or just "url"
                                const lines = voucher.attachments.split('\n').filter(l => l.trim());
                                return lines.map(line => {
                                    const parts = line.split('|');
                                    let fileName, fileUrl;
                                    if (parts.length >= 2) {
                                        fileName = parts[0].trim();
                                        fileUrl = parts[1].trim();
                                    } else {
                                        fileUrl = parts[0].trim();
                                        fileName = 'Tài liệu đính kèm';
                                    }
                                    if (!fileUrl.startsWith('http')) return '';
                                    return '<a href="' + fileUrl + '" target="_blank" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #3b82f6; color: white; padding: 0.5rem 0.75rem; border-radius: 6px; text-decoration: none; font-size: 0.8125rem; font-weight: 500; margin-right: 0.5rem;">' +
                                        '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>' +
                                        fileName +
                                    '</a>';
                                }).join('');
                            })()}
                        </div>
                    </div>
                </div>
                ` : `
                <div class="voucher-detail-section">
                    <h4>📎 Tài liệu đính kèm</h4>
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border: 1px solid #fcd34d; color: #92400e;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            <span style="font-size: 0.875rem;">Không có tài liệu đính kèm</span>
                        </div>
                    </div>
                </div>
                `}
                
                ${approverSignatureSection}
                
                ${meta.requesterSignature ? `
                <div class="voucher-detail-section">
                    <h4>✍️ Chữ ký người đề nghị</h4>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
                        <img src="${meta.requesterSignature}" alt="Chữ ký người đề nghị" style="max-height: 80px; max-width: 200px;">
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">${voucher.employee || ''}</div>
                    </div>
                </div>
                ` : ''}
                
                ${meta.approverSignature ? `
                <div class="voucher-detail-section">
                    <h4>✍️ Chữ ký người phê duyệt</h4>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
                        <img src="${meta.approverSignature}" alt="Chữ ký người phê duyệt" style="max-height: 80px; max-width: 200px;">
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">${voucher.approvedBy || voucher.rejectedBy || ''}</div>
                    </div>
                </div>
                ` : ''}
                
                <div class="voucher-detail-section">
                    <h4>📋 Lịch sử xử lý</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${historyHtml || '<p style="color: #94a3b8; text-align: center; padding: 1rem;">Không có lịch sử</p>'}
                    </div>
                </div>
            `;
        }
        
        // Handle approver signature upload
        async function handleApproverSignatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.match(/^image\/(png|jpeg|jpg)$/)) {
                showToast('Chỉ hỗ trợ file PNG, JPG, JPEG', 'error');
                return;
            }
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('File quá lớn. Tối đa 2MB', 'error');
                return;
            }
            
            try {
                const base64Data = await fileToBase64(file);
                approverSignatureData = base64Data;
                localStorage.setItem(APPROVER_SIGNATURE_KEY, base64Data);
                
                // Update preview
                const preview = document.getElementById('approver-signature-preview');
                preview.innerHTML = `<img src="${base64Data}" alt="Chữ ký" id="approver-signature-img">`;
                
                showToast('Đã tải lên chữ ký', 'success');
                
                // Refresh modal content to show clear button
                if (currentModalVoucher) {
                    openVoucherDetail(currentModalVoucher.voucherNumber);
                }
            } catch (error) {
                showToast('Lỗi tải file: ' + error.message, 'error');
            }
        }
        
        // Clear approver signature
        function clearApproverSignature() {
            if (confirm('Bạn có chắc muốn xóa chữ ký?')) {
                approverSignatureData = null;
                localStorage.removeItem(APPROVER_SIGNATURE_KEY);
                
                const preview = document.getElementById('approver-signature-preview');
                if (preview) {
                    preview.innerHTML = `<span style="color: #94a3b8; font-size: 0.875rem;" id="approver-signature-placeholder">Chưa có chữ ký</span>`;
                }
                
                showToast('Đã xóa chữ ký', 'info');
                
                // Refresh modal content
                if (currentModalVoucher) {
                    openVoucherDetail(currentModalVoucher.voucherNumber);
                }
            }
        }
        
        // Approve voucher from modal
        async function approveFromModal() {
            if (!currentModalVoucher) return;
            
            if (!approverSignatureData) {
                showToast('Vui lòng tải lên chữ ký trước khi phê duyệt', 'error');
                return;
            }
            
            if (!confirm('Bạn có chắc muốn PHÊ DUYỆT phiếu này?')) return;
            
            const modal = document.getElementById('voucher-modal-overlay');
            const modalLoading = document.getElementById('modal-loading');
            const modalContent = document.getElementById('modal-content');
            const modalFooter = document.getElementById('modal-footer');
            
            modalLoading.classList.add('show');
            modalContent.style.opacity = '0.5';
            modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
                // Use POST request because approverSignature is too long for URL
                const requestData = {
                    action: 'approveVoucher',
                    voucher: {
                        voucherNumber: currentModalVoucher.voucherNumber,
                        voucherType: currentModalVoucher.voucherType || '',
                        company: currentModalVoucher.company || '',
                        employee: currentModalVoucher.employee || '',
                        amount: currentModalVoucher.amount || '',
                        requestorEmail: currentModalVoucher.requestorEmail || '',
                        approverEmail: currentModalVoucher.approverEmail || '',
                        approvedBy: 'Approver',
                        approverSignature: approverSignatureData
                    }
                };
                
                console.log('Sending approve request:', JSON.stringify(requestData).substring(0, 500));
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                modalLoading.classList.remove('show');
                modalContent.style.opacity = '1';
                
                if (result.success) {
                    showToast('Đã phê duyệt phiếu thành công!', 'success');
                    closeVoucherModal();
                    loadRecentVouchers();
                } else {
                    showToast(result.message || 'Lỗi phê duyệt', 'error');
                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error('Error approving:', error);
                modalLoading.classList.remove('show');
                modalContent.style.opacity = '1';
                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                showToast('Lỗi kết nối: ' + error.message, 'error');
            }
        }
        
        // Reject voucher from modal
        async function rejectFromModal() {
            if (!currentModalVoucher) return;
            
            const reason = prompt('Vui lòng nhập lý do từ chối:');
            if (reason === null) return; // User cancelled
            if (!reason.trim()) {
                showToast('Vui lòng nhập lý do từ chối', 'error');
                return;
            }
            
            const modal = document.getElementById('voucher-modal-overlay');
            const modalLoading = document.getElementById('modal-loading');
            const modalContent = document.getElementById('modal-content');
            const modalFooter = document.getElementById('modal-footer');
            
            modalLoading.classList.add('show');
            modalContent.style.opacity = '0.5';
            modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
                // Use POST request because approverSignature can be long
                const requestData = {
                    action: 'rejectVoucher',
                    voucher: {
                        voucherNumber: currentModalVoucher.voucherNumber,
                        voucherType: currentModalVoucher.voucherType || '',
                        company: currentModalVoucher.company || '',
                        employee: currentModalVoucher.employee || '',
                        amount: currentModalVoucher.amount || '',
                        requestorEmail: currentModalVoucher.requestorEmail || '',
                        approverEmail: currentModalVoucher.approverEmail || '',
                        rejectedBy: 'Approver',
                        reason: reason.trim(),
                        approverSignature: approverSignatureData || ''
                    }
                };
                
                console.log('Sending reject request:', JSON.stringify(requestData).substring(0, 500));
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);
                
                modalLoading.classList.remove('show');
                modalContent.style.opacity = '1';
                
                if (result.success) {
                    showToast('Đã từ chối phiếu', 'info');
                    closeVoucherModal();
                    loadRecentVouchers();
                } else {
                    showToast(result.message || 'Lỗi từ chối', 'error');
                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                }
            } catch (error) {
                console.error('Error rejecting:', error);
                modalLoading.classList.remove('show');
                modalContent.style.opacity = '1';
                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                showToast('Lỗi kết nối: ' + error.message, 'error');
            }
        }
        
        // Close voucher detail modal
        function closeVoucherModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('voucher-modal-overlay');
            modal.classList.remove('show');
            currentModalVoucher = null;
            currentModalMeta = null;
        }
        
        // Print voucher - opens print-friendly view matching Vietnamese voucher format
        function printVoucher() {
            if (!currentModalVoucher) {
                showToast('Không tìm thấy thông tin phiếu', 'error');
                return;
            }
            
            const voucher = currentModalVoucher;
            const meta = currentModalMeta || voucher.meta || {}; // Use merged meta
            
            // Determine voucher type title
            const voucherTypeUpper = (voucher.voucherType || '').toUpperCase();
            const isPhieuChi = voucherTypeUpper.includes('CHI') || voucherTypeUpper.includes('PAYMENT');
            const voucherTitle = isPhieuChi ? 'PHIẾU CHI' : 'PHIẾU THU';
            const formNumber = isPhieuChi ? '02 - TT' : '01 - TT';
            
            // Format date
            const now = new Date();
            const voucherDate = meta.voucherDate ? new Date(meta.voucherDate) : now;
            const day = voucherDate.getDate();
            const month = voucherDate.getMonth() + 1;
            const year = voucherDate.getFullYear();
            
            // Format amount
            let amountValue = 0;
            if (typeof voucher.amount === 'number') {
                amountValue = voucher.amount;
            } else if (voucher.amount) {
                amountValue = parseFloat(String(voucher.amount).replace(/[^\d]/g, '')) || 0;
            }
            const amountFormatted = amountValue.toLocaleString('vi-VN');
            
            // Get company address from data
            let companyAddress = '';
            const companyData = data.companies_data.find(c => c["Tên công ty"] === voucher.company);
            if (companyData) {
                companyAddress = companyData["Địa chỉ"] || '';
            }
            
            // Build print content matching the Vietnamese voucher format
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${voucherTitle} - ${voucher.voucherNumber}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            padding: 15mm 20mm; 
                            font-size: 13pt;
                            line-height: 1.4;
                            color: #000;
                        }
                        .voucher-container {
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .header-section {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 15px;
                        }
                        .header-left {
                            flex: 1;
                        }
                        .header-right {
                            text-align: right;
                            font-size: 11pt;
                        }
                        .company-name {
                            font-size: 15pt;
                            font-weight: bold;
                            text-transform: uppercase;
                            margin-bottom: 5px;
                        }
                        .voucher-number-line {
                            font-size: 11pt;
                            margin-top: 5px;
                        }
                        .form-reference {
                            font-size: 11pt;
                            font-style: italic;
                        }
                        .voucher-title {
                            text-align: center;
                            font-size: 22pt;
                            font-weight: bold;
                            font-style: italic;
                            margin: 20px 0 10px 0;
                        }
                        .voucher-date {
                            text-align: center;
                            font-size: 12pt;
                            margin-bottom: 25px;
                        }
                        .info-row {
                            display: flex;
                            margin-bottom: 12px;
                            font-size: 13pt;
                        }
                        .info-label {
                            min-width: 160px;
                            text-decoration: underline;
                        }
                        .info-value {
                            flex: 1;
                        }
                        .info-colon {
                            margin: 0 8px;
                        }
                        .amount-section {
                            margin: 20px 0;
                            padding: 10px 0;
                        }
                        .amount-words {
                            font-style: italic;
                            margin-top: 5px;
                        }
                        .attachments-section {
                            margin: 15px 0;
                            font-size: 12pt;
                            font-style: italic;
                        }
                        .signatures-section {
                            margin-top: 40px;
                        }
                        .signatures-row {
                            display: flex;
                            justify-content: space-between;
                            text-align: center;
                        }
                        .signature-box {
                            width: 18%;
                            min-height: 120px;
                        }
                        .signature-title {
                            font-size: 11pt;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        .signature-required {
                            color: red;
                        }
                        .signature-image-container {
                            height: 70px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 10px 0;
                        }
                        .signature-img {
                            max-height: 60px;
                            max-width: 120px;
                        }
                        .signature-name {
                            font-size: 12pt;
                            margin-top: 5px;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 3px 12px;
                            border-radius: 4px;
                            font-size: 11pt;
                            font-weight: bold;
                        }
                        .status-pending { background: #fef3c7; color: #92400e; }
                        .status-approved { background: #d1fae5; color: #065f46; }
                        .status-rejected { background: #fee2e2; color: #991b1b; }
                        .footer-section {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10pt;
                            color: #666;
                            border-top: 1px solid #ddd;
                            padding-top: 15px;
                        }
                        @media print {
                            body { padding: 10mm 15mm; }
                            .no-print { display: none !important; }
                            .signature-image-container { 
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                        .no-print {
                            margin-top: 30px;
                            text-align: center;
                            padding: 20px;
                            background: #f8fafc;
                            border-radius: 8px;
                        }
                        .no-print button {
                            padding: 12px 30px;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            margin: 0 5px;
                        }
                        .btn-print { background: #3b82f6; color: white; }
                        .btn-close { background: #6b7280; color: white; }
                    </style>
                </head>
                <body>
                    <div class="voucher-container">
                        <!-- Header Section -->
                        <div class="header-section">
                            <div class="header-left">
                                <div class="company-name">${voucher.company || 'CÔNG TY'}</div>
                                ${companyAddress ? `<div style="font-size: 11pt;">${companyAddress}</div>` : ''}
                                <div class="voucher-number-line">Số: <strong>${voucher.voucherNumber}</strong></div>
                            </div>
                            <div class="header-right">
                                <div style="font-weight: bold;">Mẫu số: ${formNumber}</div>
                                <div class="form-reference">(Ban hành theo Thông tư số 200/2014/TT-BTC</div>
                                <div class="form-reference">Ngày 22/12/2014 của Bộ Tài chính)</div>
                            </div>
                        </div>
                        
                        <!-- Voucher Title -->
                        <div class="voucher-title">${voucherTitle}</div>
                        <div class="voucher-date">Ngày ${day} tháng ${month} năm ${year}</div>
                        
                        <!-- Voucher Information -->
                        <div class="info-row">
                            <span class="info-label">Người nộp/nhận tiền</span>
                            <span class="info-colon">:</span>
                            <span class="info-value"><strong>${meta.payeeName || voucher.employee || 'N/A'}</strong></span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Nội dung</span>
                            <span class="info-colon">:</span>
                            <span class="info-value">${voucher.note || meta.reason || 'N/A'}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Số tiền (VNĐ)</span>
                            <span class="info-colon">:</span>
                            <span class="info-value"><strong>${amountFormatted}</strong></span>
                        </div>
                        
                        ${meta.amountInWords ? `
                        <div class="info-row">
                            <span class="info-label">Bằng chữ</span>
                            <span class="info-colon">:</span>
                            <span class="info-value" style="font-style: italic;">${meta.amountInWords}</span>
                        </div>
                        ` : ''}
                        
                        <div class="info-row" style="align-items: flex-start;">
                            <span class="info-label">Kèm theo</span>
                            <span class="info-colon">:</span>
                            <span class="info-value" style="font-style: italic;">${voucher.attachments ? (function() {
                                // Parse attachments: format is "filename|url\nfilename2|url2"
                                const lines = voucher.attachments.split(/\\n|\n/).filter(l => l.trim());
                                if (lines.length === 0) return '(Không có tệp đính kèm)';
                                
                                const linksList = lines.map((line, index) => {
                                    const parts = line.split('|');
                                    let fileName, fileUrl;
                                    if (parts.length >= 2) {
                                        fileName = parts[0].trim();
                                        fileUrl = parts[1].trim();
                                    } else {
                                        fileUrl = parts[0].trim();
                                        fileName = 'Tệp đính kèm ' + (index + 1);
                                    }
                                    if (!fileUrl.startsWith('http')) return '';
                                    return '<div style="margin-bottom: 4px;"><a href="' + fileUrl + '" target="_blank" style="color: #2563eb; text-decoration: underline;">' + fileName + '</a></div>';
                                }).filter(l => l).join('');
                                
                                return '<div style="display: flex; flex-direction: column;">' + linksList + '</div>';
                            })() : '(Cung cấp chứng từ bản gốc cho kế toán)'}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Trạng thái</span>
                            <span class="info-colon">:</span>
                            <span class="info-value">
                                <span class="status-badge status-${(voucher.status || 'pending').toLowerCase()}">
                                    ${voucher.status === 'Approved' ? 'Đã duyệt' : voucher.status === 'Rejected' ? 'Từ chối' : 'Chờ duyệt'}
                                </span>
                            </span>
                        </div>
                        
                        <!-- Signatures Section -->
                        <div class="signatures-section">
                            <div class="signatures-row">
                                <div class="signature-box">
                                    <div class="signature-title">Người lập <span class="signature-required">*</span></div>
                                    <div class="signature-image-container">
                                        ${meta.requesterSignature 
                                            ? `<img src="${meta.requesterSignature}" alt="Chữ ký" class="signature-img">`
                                            : ''
                                        }
                                    </div>
                                    <div class="signature-name">${voucher.employee || ''}</div>
                                </div>
                                
                                <div class="signature-box">
                                    <div class="signature-title">Kế toán trưởng <span class="signature-required">*</span></div>
                                    <div class="signature-image-container">
                                        ${(voucher.status === 'Approved' && meta.approverSignature) 
                                            ? `<img src="${meta.approverSignature}" alt="Chữ ký" class="signature-img">`
                                            : ''
                                        }
                                    </div>
                                    <div class="signature-name">${voucher.status === 'Approved' ? (voucher.approvedBy || '') : ''}</div>
                                </div>
                                
                                <div class="signature-box">
                                    <div class="signature-title">Giám đốc <span class="signature-required">*</span></div>
                                    <div class="signature-image-container">
                                        ${(voucher.status === 'Approved' && meta.approverSignature) 
                                            ? `<img src="${meta.approverSignature}" alt="Chữ ký" class="signature-img">`
                                            : ''
                                        }
                                    </div>
                                    <div class="signature-name">${voucher.status === 'Approved' ? (voucher.approvedBy || '') : ''}</div>
                                </div>
                                
                                <div class="signature-box">
                                    <div class="signature-title">Thủ quỹ <span class="signature-required">*</span></div>
                                    <div class="signature-image-container">
                                    </div>
                                    <div class="signature-name"></div>
                                </div>
                                
                                <div class="signature-box">
                                    <div class="signature-title">Người nộp/nhận tiền <span class="signature-required">*</span></div>
                                    <div class="signature-image-container">
                                        ${meta.requesterSignature 
                                            ? `<img src="${meta.requesterSignature}" alt="Chữ ký" class="signature-img">`
                                            : ''
                                        }
                                    </div>
                                    <div class="signature-name">${meta.payeeName || voucher.employee || ''}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="footer-section">
                            <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')} ${new Date().toLocaleTimeString('vi-VN')}</p>
                            <p>Tài liệu được tạo tự động từ hệ thống TLCG Workflow</p>
                        </div>
                        
                        <!-- Print Buttons (hidden when printing) -->
                        <div class="no-print">
                            <button class="btn-print" onclick="window.print()">🖨️ In phiếu</button>
                            <button class="btn-close" onclick="window.close()">✕ Đóng</button>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Open print window
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
            } else {
                showToast('Vui lòng cho phép popup để in phiếu', 'error');
            }
        }
        
        // Edit voucher from modal - load data into form for editing
        function editVoucherFromModal() {
            if (!currentModalVoucher) {
                showToast('Không tìm thấy thông tin phiếu', 'error');
                return;
            }
            
            const voucher = currentModalVoucher;
            const meta = currentModalMeta || voucher.meta || {}; // Use merged meta
            
            console.log('=== LOADING VOUCHER FOR EDIT ===');
            console.log('Voucher:', voucher);
            console.log('Meta:', meta);
            
            try {
                // Set company
                const companySelect = document.getElementById('company');
                if (companySelect && voucher.company) {
                    // Try exact match first
                    let found = false;
                    for (let option of companySelect.options) {
                        if (option.value === voucher.company || option.text === voucher.company) {
                            companySelect.value = option.value;
                            found = true;
                            break;
                        }
                    }
                    if (found) {
                        updateCompanyDetails(); // Trigger company change handler
                    }
                }
                
                // Set voucher type
                const voucherTypeSelect = document.getElementById('voucher-type');
                if (voucherTypeSelect && voucher.voucherType) {
                    voucherTypeSelect.value = voucher.voucherType;
                }
                
                // Set employee/requestor
                const employeeSelect = document.getElementById('employee');
                if (employeeSelect && voucher.employee) {
                    for (let option of employeeSelect.options) {
                        if (option.value === voucher.employee || option.text === voucher.employee) {
                            employeeSelect.value = option.value;
                            break;
                        }
                    }
                }
                
                // Set department
                const departmentInput = document.getElementById('department');
                if (departmentInput && meta.department) {
                    departmentInput.value = meta.department;
                }
                
                // Set payee name
                const payeeNameInput = document.getElementById('payee-name');
                if (payeeNameInput && meta.payeeName) {
                    payeeNameInput.value = meta.payeeName;
                }
                
                // Set reason/note
                const reasonInput = document.getElementById('reason');
                if (reasonInput && voucher.note) {
                    reasonInput.value = voucher.note;
                }
                
                // Set amount (parse from string if needed)
                let amount = voucher.amount;
                if (typeof amount === 'string') {
                    amount = amount.replace(/[^\d]/g, '');
                }
                const amountInput = document.getElementById('amount');
                if (amountInput && amount) {
                    amountInput.value = amount;
                    // Trigger amount change to update amount in words
                    amountInput.dispatchEvent(new Event('input'));
                }
                
                // Generate new voucher number for resubmission
                generateVoucherNumber();
                
                // Close modal and go to step 1
                closeVoucherModal();
                goToStep(1);
                
                showToast('Đã tải thông tin phiếu. Vui lòng kiểm tra và chỉnh sửa trước khi gửi lại.', 'info');
                
                // Scroll to top of form
                document.getElementById('voucher-form').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error loading voucher for edit:', error);
                showToast('Lỗi tải thông tin phiếu: ' + error.message, 'error');
            }
        }
        
        // Auto-refresh interval for Recent Vouchers (30 seconds)
        let recentVouchersRefreshInterval = null;
        const REFRESH_INTERVAL_MS = 30000; // 30 seconds
        
        // Start auto-refresh for Recent Vouchers
        function startAutoRefresh() {
            if (recentVouchersRefreshInterval) {
                clearInterval(recentVouchersRefreshInterval);
            }
            recentVouchersRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing Recent Vouchers...');
                loadRecentVouchers();
            }, REFRESH_INTERVAL_MS);
            console.log('Auto-refresh started (every 30 seconds)');
        }
        
        // Stop auto-refresh (e.g., when modal is open)
        function stopAutoRefresh() {
            if (recentVouchersRefreshInterval) {
                clearInterval(recentVouchersRefreshInterval);
                recentVouchersRefreshInterval = null;
                console.log('Auto-refresh stopped');
            }
        }
        
        // Initialize recent vouchers on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load recent vouchers after a short delay to ensure page is ready
            setTimeout(() => {
                loadRecentVouchers();
                startAutoRefresh();
            }, 1000);
        });
        
        // Stop auto-refresh when page is hidden (tab switched), resume when visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadRecentVouchers(); // Refresh immediately when tab becomes visible
                startAutoRefresh();
            }
        });
        // ============ END RECENT VOUCHERS FUNCTIONS ============
        
        function setCurrentDate() {
            const formattedDate = getCurrentVoucherDate();
            const voucherDateInput = document.getElementById('voucher-date');
            if (voucherDateInput) {
                // Set min date to today (prevent back date selection)
                voucherDateInput.setAttribute('min', formattedDate);
                // Set value to today (current system date) as default
                voucherDateInput.value = formattedDate;
                // Remove readonly to allow user to select date (but only from today onwards)
                voucherDateInput.removeAttribute('readonly');
                // Remove disabled style
                voucherDateInput.style.backgroundColor = '';
                voucherDateInput.style.cursor = '';
                
                // Add validation on change to ensure date is not in the past
                voucherDateInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    selectedDate.setHours(0, 0, 0, 0);
                    
                    if (selectedDate < today) {
                        alert('Ngày lập phiếu không được là ngày quá khứ. Vui lòng chọn ngày hiện tại trở đi.');
                        this.value = formattedDate; // Reset to today
                    }
                });
            }
        }
        
        function generateVoucherNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            const voucherNumber = `TL-${year}${month}-${randomNum}`;
            document.getElementById('voucher-number').value = voucherNumber;
        }
        
        function updateAmountInWords() {
            const amountInput = document.getElementById('amount');
            const amount = parseCurrency(amountInput.value) || 0;
            const amountInWordsInput = document.getElementById('amount-in-words');
            const amountInWordsDisplay = document.getElementById('amount-in-words-display');
            
            const amountInWords = amount > 0 ? convertNumberToWords(amount) + " đồng" : "";
            
            if (amountInWordsInput) {
                amountInWordsInput.value = amountInWords;
            }
            if (amountInWordsDisplay) {
                amountInWordsDisplay.textContent = amountInWords || "Không đồng";
            }
        }
        
        function convertNumberToWords(num) {
            const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const teens = ['mười', 'mười một', 'mười hai', 'mười ba', 'mười bốn', 'mười lăm', 'mười sáu', 'mười bảy', 'mười tám', 'mười chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ'];

            function convertLessThanOneThousand(n) {
                let s = '';
                if (n >= 100) {
                    s += units[Math.floor(n / 100)] + ' trăm ';
                    n %= 100;
                }
                if (n >= 20) {
                    s += tens[Math.floor(n / 10)] + ' ';
                    n %= 10;
                }
                if (n >= 10) {
                    s += teens[n - 10] + ' ';
                    n = 0;
                }
                if (n > 0) {
                    s += units[n] + ' ';
                }
                return s.trim();
            }

            if (num === 0) return 'Không';

            let result = '';
            let i = 0;
            let tempNum = num;

            while (tempNum > 0) {
                const chunk = tempNum % 1000;
                if (chunk !== 0) {
                    let chunkWords = convertLessThanOneThousand(chunk);
                    result = chunkWords + ' ' + scales[i] + ' ' + result;
                }
                tempNum = Math.floor(tempNum / 1000);
                i++;
            }
            return result.trim().replace(/\s+/g, ' ').replace(/mươi một/g, 'mươi mốt').replace(/mươi năm/g, 'mươi lăm').replace(/một trăm/g, 'một trăm').replace(/linh một/g, 'lẻ một').replace(/linh năm/g, 'lẻ năm');
        }
        
        function exportToPDF() {
            const element = document.getElementById('voucher-form');
            const opt = {
                margin: 10,
                filename: 'phieu_chi_thu.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
            showToast('Đã xuất PDF thành công!', 'success', 'Thành công');
        }
        
        function exportToExcel() {
            try {
                // Validate form before export
                if (!validateAllFields()) {
                    showToast('Vui lòng điền đầy đủ thông tin trước khi xuất Excel', 'error', 'Lỗi validation');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: Form Data
                const formData = [
                    ['PHIẾU THU/CHI - THÔNG TIN CHÍNH'],
                    [],
                    ['Công ty', document.getElementById('company').value],
                    ['Loại phiếu', document.getElementById('voucher-type').value],
                    ['Số phiếu', document.getElementById('voucher-number').value],
                    ['Ngày lập phiếu', getCurrentVoucherDate()], // Always use current system date
                    ['Người đề nghị', document.getElementById('employee').value],
                    ['Bộ phận', document.getElementById('department').value],
                    ['Người nộp/nhận', document.getElementById('payee-name').value],
                    ['Loại tiền', document.getElementById('currency').value],
                    ['Tổng số tiền', document.getElementById('amount').value],
                    ['Số tiền bằng chữ', document.getElementById('amount-in-words').value],
                    ['Lý do', document.getElementById('reason').value],
                    ['Người phê duyệt', document.getElementById('approver').value],
                    ['Trạng thái', document.getElementById('approval-status-display').textContent]
                ];
                
                const ws1 = XLSX.utils.aoa_to_sheet(formData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Thông tin phiếu');
                
                // Sheet 2: Expense Items
                const expenseData = [
                    ['STT', 'Nội dung', 'Số tiền', 'Số file đính kèm']
                ];
                
                expenseItems.forEach((item, index) => {
                    expenseData.push([
                        index + 1,
                        item.content || '',
                        item.amount || 0,
                        item.attachments ? item.attachments.length : 0
                    ]);
                });
                
                // Add total row
                const grandTotal = expenseItems.reduce((sum, item) => sum + (item.amount || 0), 0);
                expenseData.push(['', 'TỔNG CỘNG', grandTotal, '']);
                
                const ws2 = XLSX.utils.aoa_to_sheet(expenseData);
                
                // Set column widths
                ws2['!cols'] = [
                    { wch: 5 },   // STT
                    { wch: 40 },  // Nội dung
                    { wch: 15 },  // Số tiền
                    { wch: 15 }   // Số file đính kèm
                ];
                
                XLSX.utils.book_append_sheet(wb, ws2, 'Chi tiết chi phí');
                
                // Sheet 3: Approval History
                const historyData = [
                    ['Thời gian', 'Hành động', 'Người thực hiện', 'Gửi đến']
                ];
                
                if (approvalHistory.length > 0) {
                    approvalHistory.forEach(entry => {
                        historyData.push([
                            entry.timestamp || '',
                            entry.action || '',
                            entry.by || '',
                            entry.to || ''
                        ]);
                    });
                } else {
                    historyData.push(['Chưa có lịch sử phê duyệt']);
                }
                
                const ws3 = XLSX.utils.aoa_to_sheet(historyData);
                XLSX.utils.book_append_sheet(wb, ws3, 'Lịch sử phê duyệt');
                
                // Generate filename with date
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
                const voucherNumber = document.getElementById('voucher-number').value.replace(/[^a-zA-Z0-9]/g, '_');
                const filename = `Phieu_Thu_Chi_${voucherNumber}_${dateStr}.xlsx`;
                
                // Export file
                XLSX.writeFile(wb, filename);
                showToast('Đã xuất Excel thành công!', 'success', 'Thành công');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Có lỗi xảy ra khi xuất Excel: ' + error.message, 'error', 'Lỗi');
            }
        }
        
        function importFromExcelForm() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length > 0) {
                        const row = jsonData[0];
                        if (row.company) document.getElementById('company').value = row.company;
                        if (row.employee) document.getElementById('employee').value = row.employee;
                        if (row.payeeName) document.getElementById('payee-name').value = row.payeeName;
                        if (row.reason) document.getElementById('reason').value = row.reason;
                        if (row.approver) document.getElementById('approver').value = row.approver;
                        
                        updateCompanyDetails();
                        updateEmployeeDepartment();
                        updateGrandTotal(); 
                        debounceAutoSave();
                        showToast('Đã nhập dữ liệu từ Excel vào form chính thành công!', 'success', 'Thành công');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            input.click();
        }
        
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            spreadsheetId: localStorage.getItem('google_sheets_id') || '',
            sheetName: 'Phiếu Thu Chi',
            apiKey: ''
        };

        // Load saved spreadsheet ID
        if (GOOGLE_SHEETS_CONFIG.spreadsheetId) {
            console.log('Loaded saved Spreadsheet ID:', GOOGLE_SHEETS_CONFIG.spreadsheetId);
        }

        async function syncWithGoogleSheets() {
            try {
                if (!validateAllFields()) {
                    showToast('Vui lòng điền đầy đủ thông tin trước khi đồng bộ', 'error', 'Lỗi validation');
                    return;
                }

                // Check Google Apps Script URL
                if (!GOOGLE_APPS_SCRIPT_WEB_APP_URL || GOOGLE_APPS_SCRIPT_WEB_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    const setupUrl = confirm('Chưa cấu hình Google Apps Script URL.\n\nBạn có muốn xem hướng dẫn setup không?');
                    if (setupUrl) {
                        showToast('Vui lòng xem file GOOGLE_APPS_SCRIPT_SETUP.md để biết cách cấu hình', 'info', 'Hướng dẫn');
                    }
                    showToast('Đang xuất Excel để bạn có thể import thủ công...', 'warning', 'Cảnh báo');
                    exportToExcel();
                    return;
                }

                // Get or prompt for Spreadsheet ID
                if (!GOOGLE_SHEETS_CONFIG.spreadsheetId) {
                    const spreadsheetId = prompt(
                        'Vui lòng nhập Google Sheets ID:\n\n' +
                        'Có thể lấy từ URL của sheet:\n' +
                        'https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit\n\n' +
                        'Lưu ý: Sheet phải được share với email Google Apps Script của bạn!'
                    );
                    
                    if (!spreadsheetId || spreadsheetId.trim() === '') {
                        showToast('Cần Google Sheets ID để đồng bộ', 'error', 'Lỗi cấu hình');
                        return;
                    }
                    
                    GOOGLE_SHEETS_CONFIG.spreadsheetId = spreadsheetId.trim();
                    localStorage.setItem('google_sheets_id', GOOGLE_SHEETS_CONFIG.spreadsheetId);
                    showToast('Đã lưu Spreadsheet ID', 'success');
                }

                // Show loading
                const syncBtn = document.getElementById('sync-sheets-btn');
                const originalText = syncBtn.innerHTML;
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Đang đồng bộ...';

                // Collect files for upload to Drive
                const filesToUpload = [];
                for (let i = 0; i < expenseItems.length; i++) {
                    const item = expenseItems[i];
                    if (item.attachments && item.attachments.length > 0) {
                        for (const file of item.attachments) {
                            if (file instanceof File) {
                                try {
                                    // Convert file to base64
                                    const base64Data = await fileToBase64(file);
                                    filesToUpload.push({
                                        fileName: file.name,
                                        fileData: base64Data,
                                        mimeType: file.type,
                                        fileSize: file.size,
                                        rowIndex: i
                                    });
                                } catch (err) {
                                    console.error('Error converting file to base64:', file.name, err);
                                }
                            }
                        }
                    }
                }

                // Log file information for verification
                console.log('=== FILE UPLOAD INFO ===');
                console.log('Total expense items:', expenseItems.length);
                console.log('Files to upload:', filesToUpload.length);
                if (filesToUpload.length > 0) {
                    console.log('Files details:');
                    filesToUpload.forEach((f, idx) => {
                        const sizeMB = (f.fileSize / (1024 * 1024)).toFixed(2);
                        console.log(`  ${idx + 1}. Row ${f.rowIndex}: ${f.fileName} (${sizeMB} MB, ${f.mimeType})`);
                    });
                } else {
                    console.log('No files attached');
                }

                const voucherData = {
                    timestamp: new Date().toISOString(),
                    voucherNumber: document.getElementById('voucher-number').value,
                    voucherType: document.getElementById('voucher-type').value,
                    voucherDate: getCurrentVoucherDate(), // Always use current system date
                    company: document.getElementById('company').value,
                    employee: document.getElementById('employee').value,
                    department: document.getElementById('department').value,
                    payeeName: document.getElementById('payee-name').value,
                    currency: document.getElementById('currency').value,
                    totalAmount: document.getElementById('amount').value,
                    amountInWords: document.getElementById('amount-in-words').value,
                    reason: document.getElementById('reason').value,
                    approver: document.getElementById('approver').value,
                    status: document.getElementById('approval-status-display').textContent,
                    expenseItems: expenseItems.map((item, index) => ({
                        stt: index + 1,
                        content: item.content,
                        amount: item.amount,
                        attachments: item.attachments.length,
                        attachmentNames: item.attachments.map(f => f instanceof File ? f.name : f.name || 'Unknown').join(', ')
                    })),
                    approvalHistory: approvalHistory,
                    files: filesToUpload  // Send files for Drive upload
                };

                console.log('=== VOUCHER DATA TO SYNC ===');
                console.log('Voucher Number:', voucherData.voucherNumber);
                console.log('Expense Items:', voucherData.expenseItems);
                console.log('Files Info:', voucherData.filesInfo);

                // Retry logic
                let retries = 3;
                let success = false;
                
                while (retries > 0 && !success) {
                    try {
                        // Use a timeout to detect if request hangs
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                        await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'syncToSheets',
                                spreadsheetId: GOOGLE_SHEETS_CONFIG.spreadsheetId,
                                sheetName: GOOGLE_SHEETS_CONFIG.sheetName,
                                data: voucherData
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);
                        success = true;
                        
                        // Store files info for later use in approval email
                        window.lastSyncedVoucherFiles = {
                            voucherNumber: voucherData.voucherNumber,
                            files: filesToUpload
                        };
                        
                        showToast('Đã đồng bộ với Google Sheets thành công!', 'success', 'Thành công');
                        
                        // Update status in approval history
                        const now = new Date();
                        const timestamp = now.toLocaleString('vi-VN');
                        approvalHistory.push({
                            timestamp: timestamp,
                            action: 'Đồng bộ với Google Sheets',
                            by: document.getElementById('employee').value,
                            to: 'Google Sheets'
                        });
                        renderApprovalHistory();
                        
                    } catch (error) {
                        retries--;
                        if (retries > 0) {
                            console.log(`Sync failed, retrying... (${retries} attempts left)`);
                            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1s before retry
                } else {
                            throw error;
                        }
                    }
                }

                if (!success) {
                    throw new Error('Không thể đồng bộ sau nhiều lần thử');
                }

            } catch (error) {
                console.error('Error syncing with Google Sheets:', error);
                
                let errorMessage = 'Có lỗi xảy ra khi đồng bộ';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timeout. Vui lòng kiểm tra kết nối mạng và thử lại.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast(errorMessage + '\nĐang xuất Excel để bạn có thể import thủ công...', 'error', 'Lỗi');
                
                // Fallback: Export Excel
                setTimeout(() => {
                    exportToExcel();
                    showToast('Đã xuất Excel. Bạn có thể import vào Google Sheets thủ công.', 'info', 'Hướng dẫn');
                }, 1000);
                
            } finally {
                // Restore button
                const syncBtn = document.getElementById('sync-sheets-btn');
                syncBtn.disabled = false;
                syncBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>\n                Đồng bộ với Google Sheets';
            }
        }

        // Function to change Spreadsheet ID
        function changeSpreadsheetId() {
            const currentId = GOOGLE_SHEETS_CONFIG.spreadsheetId || '(chưa có)';
            const newId = prompt(
                'Spreadsheet ID hiện tại: ' + currentId + '\n\n' +
                'Nhập Spreadsheet ID mới (hoặc để trống để xóa):'
            );
            
            if (newId === null) return; // User cancelled
            
            if (newId.trim() === '') {
                GOOGLE_SHEETS_CONFIG.spreadsheetId = '';
                localStorage.removeItem('google_sheets_id');
                showToast('Đã xóa Spreadsheet ID', 'success');
            } else {
                GOOGLE_SHEETS_CONFIG.spreadsheetId = newId.trim();
                localStorage.setItem('google_sheets_id', GOOGLE_SHEETS_CONFIG.spreadsheetId);
                showToast('Đã cập nhật Spreadsheet ID', 'success');
            }
        }

        // Template Functions
        function saveTemplate() {
            if (!validateAllFields()) {
                showToast('Vui lòng điền đầy đủ thông tin trước khi lưu template', 'error', 'Lỗi validation');
                return;
            }

            const templateName = prompt('Nhập tên template:');
            if (!templateName) return;

            const template = {
                name: templateName,
                company: document.getElementById('company').value,
                voucherType: document.getElementById('voucher-type').value,
                employee: document.getElementById('employee').value,
                payeeName: document.getElementById('payee-name').value,
                currency: document.getElementById('currency').value,
                reason: document.getElementById('reason').value,
                approver: document.getElementById('approver').value,
                expenseItems: expenseItems.map(item => ({
                    content: item.content,
                    amount: item.amount
                })),
                createdAt: new Date().toISOString()
            };

            const templates = JSON.parse(localStorage.getItem('voucher_templates') || '[]');
            templates.push(template);
            localStorage.setItem('voucher_templates', JSON.stringify(templates));
            
            showToast(`Đã lưu template "${templateName}" thành công!`, 'success', 'Thành công');
        }

        function loadTemplate() {
            const templates = JSON.parse(localStorage.getItem('voucher_templates') || '[]');
            if (templates.length === 0) {
                showToast('Chưa có template nào được lưu', 'info', 'Thông báo');
                return;
            }

            const templateNames = templates.map((t, i) => `${i + 1}. ${t.name} (${new Date(t.createdAt).toLocaleDateString('vi-VN')})`).join('\n');
            const choice = prompt(`Chọn template (nhập số):\n${templateNames}`);
            const index = parseInt(choice) - 1;

            if (isNaN(index) || index < 0 || index >= templates.length) {
                showToast('Lựa chọn không hợp lệ', 'error', 'Lỗi');
                return;
            }

            const template = templates[index];
            document.getElementById('company').value = template.company || '';
            document.getElementById('voucher-type').value = template.voucherType || '';
            document.getElementById('employee').value = template.employee || '';
            if (template.employee) updateEmployeeDepartment();
            document.getElementById('payee-name').value = template.payeeName || '';
            document.getElementById('currency').value = template.currency || '';
            document.getElementById('reason').value = template.reason || '';
            document.getElementById('approver').value = template.approver || '';
            
            if (template.expenseItems && template.expenseItems.length > 0) {
                expenseItems = template.expenseItems.map(item => ({
                    content: item.content,
                    amount: item.amount,
                    attachments: []
                }));
                renderExpenseTable();
            }

            updateCompanyDetails();
            debounceAutoSave();
            showToast(`Đã load template "${template.name}"`, 'success', 'Thành công');
        }

        // Searchable Dropdown Functions
        function initializeSearchableDropdowns() {
            const searchableSelects = ['company', 'employee', 'approver', 'payee-dropdown'];
            searchableSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    makeSearchable(select);
                }
            });
        }

        function makeSearchable(selectElement) {
            const wrapper = document.createElement('div');
            wrapper.className = 'searchable-select';
            selectElement.parentNode.insertBefore(wrapper, selectElement);
            wrapper.appendChild(selectElement);

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.className = 'search-input';
            searchInput.placeholder = 'Tìm kiếm...';
            wrapper.insertBefore(searchInput, selectElement);

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'dropdown-options';
            wrapper.appendChild(optionsContainer);

            function updateOptions() {
                const searchTerm = searchInput.value.toLowerCase();
                const options = Array.from(selectElement.options);
                
                optionsContainer.innerHTML = '';
                let hasVisible = false;

                options.forEach((option, index) => {
                    if (index === 0) return; // Skip first empty option
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'dropdown-option';
                    if (option.text.toLowerCase().includes(searchTerm)) {
                        optionDiv.textContent = option.text;
                        optionDiv.onclick = () => {
                            selectElement.value = option.value;
                            selectElement.dispatchEvent(new Event('change'));
                            optionsContainer.classList.remove('show');
                            searchInput.value = '';
                        };
                        optionsContainer.appendChild(optionDiv);
                        hasVisible = true;
                    }
                });

                if (hasVisible && searchInput.value) {
                    optionsContainer.classList.add('show');
                } else {
                    optionsContainer.classList.remove('show');
                }
            }

            searchInput.addEventListener('input', updateOptions);
            searchInput.addEventListener('focus', () => {
                if (searchInput.value) updateOptions();
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    optionsContainer.classList.remove('show');
                }
            });
        }

        // File Preview Functions
        function previewFileByIndex(itemIndex, fileIndex) {
            if (!expenseItems[itemIndex] || !expenseItems[itemIndex].attachments[fileIndex]) {
                showToast('File không tồn tại', 'error');
                return;
            }
            
            const file = expenseItems[itemIndex].attachments[fileIndex];
            const modal = document.createElement('div');
            modal.className = 'file-preview-modal';
            modal.innerHTML = `
                <button class="close-preview" onclick="this.parentElement.remove()">&times;</button>
            `;

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                modal.appendChild(img);
            } else if (file.type === 'application/pdf') {
                const iframe = document.createElement('iframe');
                iframe.src = URL.createObjectURL(file);
                iframe.style.width = '90%';
                iframe.style.height = '90%';
                modal.appendChild(iframe);
            } else {
                modal.innerHTML = `
                    <div style="color: white; text-align: center; padding: 20px;">
                        <p style="font-size: 18px; margin-bottom: 10px;">Không thể preview file này</p>
                        <p style="font-size: 14px; margin-bottom: 20px;">${file.name}</p>
                        <p style="font-size: 12px; color: #ccc;">Loại file: ${file.type || 'Unknown'}</p>
                        <p style="font-size: 12px; color: #ccc;">Kích thước: ${(file.size / 1024).toFixed(2)} KB</p>
                        <button class="close-preview" onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;">Đóng</button>
                    </div>
                `;
            }

            document.body.appendChild(modal);
            modal.classList.add('show');
        }

        function removeFileFromRow(rowIndex, fileIndex) {
            if (expenseItems[rowIndex] && expenseItems[rowIndex].attachments) {
                expenseItems[rowIndex].attachments.splice(fileIndex, 1);
                renderExpenseTable();
                debounceAutoSave();
            }
        }

        // Expose functions globally for onclick handlers
        window.previewFileByIndex = previewFileByIndex;
        window.removeFileFromRow = removeFileFromRow;
        window.changeSpreadsheetId = changeSpreadsheetId;
        
        function saveVoucher() {
            if (!validateAllFields()) {
                showToast('Vui lòng điền đầy đủ thông tin bắt buộc và kiểm tra lại các trường có lỗi', 'error', 'Lỗi validation');
                // Scroll to first error
                const firstError = document.querySelector('.invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }
            
            // Save to localStorage
            saveToLocalStorage();
            showToast('Phiếu đã được lưu thành công!', 'success', 'Thành công');
        }
        
        async function sendForApproval() {
            // Validate approver field specifically
            const approverField = document.getElementById('approver');
            if (!approverField.value) {
                validateField('approver', '', 'Người phê duyệt');
            }
            
            // Validate all fields including approver
            const requiredFields = ['company', 'voucher-type', 'employee', 'payee-name', 'currency', 'reason', 'approver'];
            let isValid = true;
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                const fieldNames = {
                    'company': 'Công ty',
                    'voucher-type': 'Loại phiếu',
                    'employee': 'Người đề nghị',
                    'payee-name': 'Người nộp/nhận',
                    'currency': 'Loại tiền',
                    'reason': 'Lý do',
                    'approver': 'Người phê duyệt'
                };
                if (!validateField(field, element ? element.value : '', fieldNames[field])) {
                    isValid = false;
                }
            });

            if (expenseItems.length === 0 || expenseItems.some(item => !item.content || item.amount === 0)) {
                showToast('Vui lòng nhập ít nhất một dòng chi tiết và điền đầy đủ Nội dung, Số tiền', 'error');
                isValid = false;
            }
            
            if (!isValid) {
                showToast('Vui lòng điền đầy đủ thông tin bắt buộc và kiểm tra lại các trường có lỗi', 'error', 'Lỗi validation');
                // Scroll to first error
                const firstError = document.querySelector('.invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.add('show');
            document.getElementById('send-approval-btn').disabled = true;

            // Ensure voucher number is generated if not already set
            let voucherNumber = document.getElementById('voucher-number').value;
            if (!voucherNumber || voucherNumber.trim() === '' || voucherNumber === 'TL-2023-') {
                console.log('⚠️ Voucher number missing or invalid, generating new one...');
                generateVoucherNumber();
                voucherNumber = document.getElementById('voucher-number').value;
            }
            
            // Validate voucher number format
            if (!voucherNumber || !voucherNumber.match(/^TL-\d{4}\d{2}-\d{4}$/)) {
                console.error('❌ Invalid voucher number format:', voucherNumber);
                showToast('Lỗi: Số phiếu không hợp lệ. Vui lòng thử lại.', 'error');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }
            
            console.log('✅ Voucher number validated:', voucherNumber);
            const voucherType = document.getElementById('voucher-type').value;
            const companyName = document.getElementById('company').value;
            const requestorName = document.getElementById('employee').value;
            const payeeName = document.getElementById('payee-name').value;
            const totalAmount = document.getElementById('amount').value;
            const amountInWords = document.getElementById('amount-in-words').value;
            const reason = document.getElementById('reason').value;
            
            // Get voucher date from input, but validate it's not in the past
            const voucherDateInput = document.getElementById('voucher-date');
            let voucherDate = voucherDateInput ? voucherDateInput.value : '';
            
            // Validate date is not in the past
            if (voucherDate) {
                const selectedDate = new Date(voucherDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    console.warn('⚠️ Selected date is in the past, using current date instead');
                    showToast('Ngày lập phiếu không được là ngày quá khứ. Đã tự động sử dụng ngày hiện tại.', 'warning');
                    voucherDate = getCurrentVoucherDate(); // Use current date
                    if (voucherDateInput) {
                        voucherDateInput.value = voucherDate; // Update input
                    }
                }
            } else {
                // If no date selected, use current date
                voucherDate = getCurrentVoucherDate();
            }
            
            const department = document.getElementById('department').value;

            const selectedApproverName = document.getElementById('approver').value;
            const selectedCompanyData = data.companies_data.find(c => c["Tên công ty"] === companyName);

            // Debug: Log để kiểm tra
            console.log('=== DEBUG EMAIL ===');
            console.log('Selected Approver:', selectedApproverName);
            console.log('Company Name:', companyName);
            console.log('Company Data:', selectedCompanyData);
            console.log('Approver Email Map:', approverEmailMap);
            console.log('Employee Email Map:', employeeEmailMap);

            // Tìm email người phê duyệt - thử nhiều cách
            let approverEmail = approverEmailMap[selectedApproverName];
            if (!approverEmail) {
                // Thử tìm theo partial match
                const approverKey = Object.keys(approverEmailMap).find(key => 
                    key.includes(selectedApproverName) || selectedApproverName.includes(key)
                );
                if (approverKey) {
                    approverEmail = approverEmailMap[approverKey];
                    console.log('Found approver email by partial match:', approverEmail);
                }
            }

            // Lấy email từ company data
            const directorEmail = selectedCompanyData ? (selectedCompanyData["Email Đại diện pháp luật"] || '') : '';
            const chiefAccountantEmail = selectedCompanyData ? (selectedCompanyData["Email Kế toán trưởng"] || '') : '';
            const requestorEmail = employeeEmailMap[requestorName] || '';
            
            // Email regex for validation (declare early so it can be used in debug logs)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            // Debug: Check if requestorEmail was found
            console.log('=== REQUESTOR EMAIL DEBUG ===');
            console.log('Requestor Name:', requestorName);
            console.log('Employee Email Map Keys:', Object.keys(employeeEmailMap));
            console.log('Requestor Email Found:', requestorEmail);
            console.log('Requestor Email Valid:', requestorEmail && emailRegex.test(requestorEmail));
            console.log('=== END REQUESTOR EMAIL DEBUG ===');

            console.log('Approver Email:', approverEmail);
            console.log('Director Email:', directorEmail);
            console.log('Chief Accountant Email:', chiefAccountantEmail);
            console.log('Requestor Email:', requestorEmail);

            // Tạo danh sách recipients - ưu tiên approver, sau đó là director và accountant
            const recipients = [];
            if (approverEmail) recipients.push(approverEmail);
            if (directorEmail && !recipients.includes(directorEmail)) recipients.push(directorEmail);
            if (chiefAccountantEmail && !recipients.includes(chiefAccountantEmail)) recipients.push(chiefAccountantEmail);
            
            const ccRecipients = [];
            if (requestorEmail && !recipients.includes(requestorEmail)) ccRecipients.push(requestorEmail);

            console.log('Final Recipients:', recipients);
            console.log('Final CC Recipients:', ccRecipients);

            if (recipients.length === 0) {
                // Hiển thị thông tin debug chi tiết
                let errorMsg = 'Không tìm thấy địa chỉ email người nhận.\n\n';
                errorMsg += 'Thông tin debug:\n';
                errorMsg += `- Người phê duyệt: ${selectedApproverName || '(chưa chọn)'}\n`;
                errorMsg += `- Email người phê duyệt: ${approverEmail || 'Không tìm thấy'}\n`;
                errorMsg += `- Công ty: ${companyName || '(chưa chọn)'}\n`;
                if (selectedCompanyData) {
                    errorMsg += `- Email Đại diện pháp luật: ${directorEmail || 'Không có'}\n`;
                    errorMsg += `- Email Kế toán trưởng: ${chiefAccountantEmail || 'Không có'}\n`;
                } else {
                    errorMsg += '- Không tìm thấy dữ liệu công ty\n';
                }
                errorMsg += '\nVui lòng kiểm tra lại thông tin công ty và người phê duyệt.';
                
                alert(errorMsg);
                showToast('Không tìm thấy địa chỉ email người nhận. Xem console để biết chi tiết.', 'error', 'Lỗi email');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }

            const subject = `[PHIẾU ${voucherType.toUpperCase()}] Yêu cầu phê duyệt - ${voucherNumber}`;
            
            // Tạo link - Production URL
            // TODO: Update URL này sau khi deploy lên web server
            // Nếu đang test local, comment dòng dưới và uncomment phần auto-detect
            const baseUrl = 'https://workflow.egg-ventures.com';
            
            // Auto-detect URL (uncomment nếu muốn tự động detect)
            // let baseUrl;
            // if (window.location.protocol === 'file:') {
            //     baseUrl = '.';
            // } else {
            //     baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            // }
            
            // Debug: Log requestorEmail
            console.log('=== CREATING APPROVAL LINKS ===');
            console.log('Requestor Name:', requestorName);
            console.log('Requestor Email:', requestorEmail);
            console.log('Approver Email:', approverEmail);
            
            if (!requestorEmail || requestorEmail.trim() === '') {
                console.warn('⚠️ WARNING: requestorEmail is empty! Email approval notification may not work.');
                console.warn('Please check employeeEmailMap for:', requestorName);
            }
            
            // Tạo query string
            const queryParams = new URLSearchParams({
                voucherNumber: voucherNumber,
                voucherType: voucherType,
                company: companyName,
                employee: requestorName,
                amount: totalAmount,
                requestorEmail: requestorEmail || '',
                approverEmail: approverEmail || ''
            });
            
            console.log('Query Params:', queryParams.toString());
            
            const approvalLink = `${baseUrl}/approve_voucher.html?${queryParams.toString()}`;
            const rejectionLink = `${baseUrl}/reject_voucher.html?${queryParams.toString()}`;
            
            console.log('Approval Link:', approvalLink);

            // Get current date/time for submission (not the form date)
            const submitDateTime = new Date();
            const currentDateTime = submitDateTime.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const formattedSubmitDateTime = `lúc ${currentDateTime}`;

            // Email body for APPROVERS (with buttons)
            const approverEmailBodyHtml = `
                <p>Kính gửi các cấp quản lý,</p>
                <p>Phiếu <b>${voucherType}</b> số <b>${voucherNumber}</b> đã được tạo và đang chờ phê duyệt.</p>
                <p><b>Thông tin chi tiết phiếu:</b></p>
                <ul>
                    <li><b>Loại phiếu:</b> ${voucherType}</li>
                    <li><b>Số phiếu:</b> ${voucherNumber}</li>
                    <li><b>Ngày lập phiếu:</b> ${formattedSubmitDateTime}</li>
                    <li><b>Công ty:</b> ${companyName}</li>
                    <li><b>Người đề nghị:</b> ${requestorName} (${requestorEmail || 'Không có email'})</li>
                    <li><b>Bộ phận:</b> ${department}</li>
                    <li><b>Người nộp/nhận:</b> ${payeeName}</li>
                    <li><b>Tổng số tiền:</b> ${totalAmount}</li>
                    <li><b>Số tiền bằng chữ:</b> ${amountInWords}</li>
                    <li><b>Lý do:</b> ${reason}</li>
                </ul>
                <p><b>Chi tiết các khoản mục:</b></p>
                <table style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">STT</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Nội dung</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Số tiền</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Đính kèm</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseItems.map((item, index) => {
                            // Handle attachments - can be File objects or plain objects with name property
                            let attachmentsList = 'Không có';
                            if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                                const fileNames = item.attachments.map(f => {
                                    // Handle both File objects and plain objects
                                    if (f instanceof File) {
                                        return f.name;
                                    } else if (f && typeof f === 'object' && f.name) {
                                        return f.name;
                                    }
                                    return '';
                                }).filter(name => name); // Remove empty strings
                                
                                if (fileNames.length > 0) {
                                    attachmentsList = fileNames.join(', ');
                                }
                            }
                            
                            return `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.content || '-'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatCurrency(item.amount || 0)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${attachmentsList}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p><b>Vui lòng xem xét và phê duyệt/trả lại phiếu này:</b></p>
                <div style="margin: 20px 0;">
                    <a href="${approvalLink}" style="background-color: #34A853; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-right: 10px; display: inline-block; font-weight: bold;">✅ Phê duyệt</a>
                    <a href="${rejectionLink}" style="background-color: #EA4335; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;">❌ Trả lại / Từ chối</a>
                </div>
                <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                    <p style="margin: 0; color: #856404;"><b>Lưu ý:</b> Nếu phiếu cần chỉnh sửa, vui lòng click nút "Trả lại / Từ chối" và điền lý do. Email thông báo sẽ tự động được gửi đến người đề nghị.</p>
                </div>
                ${currentSignatureData ? `
                <div style="margin: 20px 0; padding: 15px; border-top: 1px solid #ddd;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">Chữ ký người đề nghị:</p>
                    <img src="${currentSignatureData}" alt="Chữ ký" style="max-height: 80px; max-width: 200px;">
                </div>
                ` : ''}
                <p>Trân trọng,<br>Hệ thống Kế toán Tự động</p>
            `;
            
            // Email body for REQUESTER (info only, NO buttons)
            const requesterEmailBodyHtml = `
                <p>Kính gửi ${requestorName},</p>
                <p>Phiếu <b>${voucherType}</b> số <b>${voucherNumber}</b> đã được gửi để phê duyệt.</p>
                <p><b>Thông tin chi tiết phiếu:</b></p>
                <ul>
                    <li><b>Loại phiếu:</b> ${voucherType}</li>
                    <li><b>Số phiếu:</b> ${voucherNumber}</li>
                    <li><b>Ngày lập phiếu:</b> ${formattedSubmitDateTime}</li>
                    <li><b>Công ty:</b> ${companyName}</li>
                    <li><b>Người đề nghị:</b> ${requestorName}</li>
                    <li><b>Bộ phận:</b> ${department}</li>
                    <li><b>Người nộp/nhận:</b> ${payeeName}</li>
                    <li><b>Tổng số tiền:</b> ${totalAmount}</li>
                    <li><b>Số tiền bằng chữ:</b> ${amountInWords}</li>
                    <li><b>Lý do:</b> ${reason}</li>
                    <li><b>Người phê duyệt:</b> ${selectedApproverName}</li>
                </ul>
                <p><b>Chi tiết các khoản mục:</b></p>
                <table style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr style="background-color: #f2f2f2;">
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">STT</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Nội dung</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Số tiền</th>
                            <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Đính kèm</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseItems.map((item, index) => {
                            // Handle attachments - can be File objects or plain objects with name property
                            let attachmentsList = 'Không có';
                            if (item.attachments && Array.isArray(item.attachments) && item.attachments.length > 0) {
                                const fileNames = item.attachments.map(f => {
                                    // Handle both File objects and plain objects
                                    if (f instanceof File) {
                                        return f.name;
                                    } else if (f && typeof f === 'object' && f.name) {
                                        return f.name;
                                    }
                                    return '';
                                }).filter(name => name); // Remove empty strings
                                
                                if (fileNames.length > 0) {
                                    attachmentsList = fileNames.join(', ');
                                }
                            }
                            
                            return `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${item.content || '-'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${formatCurrency(item.amount || 0)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${attachmentsList}</td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <p style="color: #666; font-style: italic;">Email thông báo kết quả phê duyệt sẽ được gửi đến bạn sau khi người phê duyệt xử lý.</p>
                ${currentSignatureData ? `
                <div style="margin: 20px 0; padding: 15px; border-top: 1px solid #ddd;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">Chữ ký của bạn:</p>
                    <img src="${currentSignatureData}" alt="Chữ ký" style="max-height: 80px; max-width: 200px;">
                </div>
                ` : ''}
                <p>Trân trọng,<br>Hệ thống Kế toán Tự động</p>
            `;

            // Validate email format (emailRegex already declared earlier)
            const validRecipients = recipients.filter(email => emailRegex.test(email));
            const validCCRecipients = ccRecipients.filter(email => emailRegex.test(email));

            if (validRecipients.length === 0) {
                showToast('Không có email hợp lệ để gửi. Vui lòng kiểm tra lại thông tin.', 'error', 'Lỗi email');
                console.error('No valid email addresses found');
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
                return;
            }
            
            // Ensure requester email is included even if not in CC
            if (!validCCRecipients.includes(requestorEmail) && requestorEmail && emailRegex.test(requestorEmail)) {
                validCCRecipients.push(requestorEmail);
                console.log('Added requestor email to notification list:', requestorEmail);
            }
            
            // CRITICAL FIX: Ensure requesterEmail.to is always set if requestorEmail is valid
            // Priority: 1) validCCRecipients (if has requestorEmail), 2) requestorEmail directly
            let requesterEmailTo = '';
            if (validCCRecipients.length > 0) {
                requesterEmailTo = validCCRecipients.join(',');
            }
            // If requesterEmailTo is still empty but requestorEmail is valid, use it directly
            if (!requesterEmailTo && requestorEmail && emailRegex.test(requestorEmail)) {
                requesterEmailTo = requestorEmail;
                console.log('⚠️ validCCRecipients was empty, using requestorEmail directly:', requestorEmail);
            }
            // Final fallback: if still empty but requestorEmail exists (even if not in map), use it
            if (!requesterEmailTo && requestorEmail && requestorEmail.trim() !== '') {
                requesterEmailTo = requestorEmail.trim();
                console.log('⚠️ Using requestorEmail as final fallback:', requestorEmail);
            }
            
            console.log('Final requesterEmail.to:', requesterEmailTo);
            console.log('requestorEmail value:', requestorEmail);
            console.log('validCCRecipients:', validCCRecipients);

            // Collect files for upload to Drive
            const filesToUpload = [];
            const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB max per file
            
            for (let i = 0; i < expenseItems.length; i++) {
                const item = expenseItems[i];
                if (item.attachments && item.attachments.length > 0) {
                    for (const file of item.attachments) {
                        if (file instanceof File) {
                            // Check file size
                            if (file.size > MAX_FILE_SIZE) {
                                console.warn(`File ${file.name} is too large (${(file.size / 1024 / 1024).toFixed(2)} MB). Max: 10MB. Skipping.`);
                                continue;
                            }
                            
                            try {
                                // Convert file to base64
                                const base64Data = await fileToBase64(file);
                                
                                // Verify base64 data was generated
                                if (!base64Data || base64Data.length < 100) {
                                    console.error(`Failed to convert ${file.name} to base64. Result was empty or too short.`);
                                    continue;
                                }
                                
                                console.log(`✅ File ${file.name}: ${file.size} bytes -> ${base64Data.length} chars base64`);
                                
                                filesToUpload.push({
                                    fileName: file.name,
                                    fileData: base64Data,
                                    mimeType: file.type || 'application/octet-stream',
                                    fileSize: file.size,
                                    rowIndex: i
                                });
                            } catch (err) {
                                console.error('Error converting file to base64:', file.name, err);
                            }
                        }
                    }
                }
            }

            // Log file information for verification
            console.log('=== FILE UPLOAD INFO ===');
            console.log('Total expense items:', expenseItems.length);
            console.log('Files to upload:', filesToUpload.length);
            if (filesToUpload.length > 0) {
                console.log('Files details:');
                filesToUpload.forEach((f, idx) => {
                    const sizeMB = (f.fileSize / (1024 * 1024)).toFixed(2);
                    console.log(`  ${idx + 1}. Row ${f.rowIndex}: ${f.fileName} (${sizeMB} MB, ${f.mimeType})`);
                });
            } else {
                console.log('No files attached');
            }

            const payload = {
                action: 'sendApprovalEmail',
                email: {
                    to: validRecipients.join(','),
                    cc: '', // No CC - requester will get separate email
                    subject: subject,
                    body: approverEmailBodyHtml // Email with buttons for approvers
                },
                requesterEmail: {
                    to: requesterEmailTo, // Requester gets separate email (always set if requestorEmail is valid)
                    subject: `[THÔNG BÁO] Phiếu ${voucherType} ${voucherNumber} đã được gửi phê duyệt`,
                    body: requesterEmailBodyHtml // Email without buttons for requester
                },
                voucher: {
                    voucherNumber: voucherNumber || '',
                    voucherType: voucherType || '',
                    company: companyName || '',
                    employee: requestorName || '',
                    amount: totalAmount || '0',
                    requestorEmail: requestorEmail || '',
                    approverEmail: approverEmail || '',
                    voucherDate: voucherDate || '',
                    department: department || '',
                    payeeName: payeeName || '',
                    reason: reason || '',
                    files: filesToUpload,  // Files for Drive upload
                    requesterSignature: currentSignatureData || '' // Requester signature for history
                }
            };

            console.log('=== VOUCHER DATA FOR HISTORY ===');
            console.log('Voucher Number:', payload.voucher.voucherNumber);
            console.log('Voucher Type:', payload.voucher.voucherType);
            console.log('Company:', payload.voucher.company);
            console.log('Employee:', payload.voucher.employee);
            console.log('Amount:', payload.voucher.amount);
            console.log('Requestor Email:', payload.voucher.requestorEmail);
            console.log('Full Voucher Object:', payload.voucher);
            console.log('=== END VOUCHER DATA ===');
            
            console.log('=== EMAIL PAYLOAD DEBUG ===');
            console.log('Valid Recipients:', validRecipients);
            console.log('Valid CC Recipients:', validCCRecipients);
            console.log('Requestor Email:', requestorEmail);
            console.log('Requester Email To (final):', requesterEmailTo);
            console.log('Requester Email Subject:', `[THÔNG BÁO] Phiếu ${voucherType} ${voucherNumber} đã được gửi phê duyệt`);
            console.log('=== END EMAIL PAYLOAD DEBUG ===');

            // Debug: Log payload trước khi gửi
            console.log('=== SENDING EMAIL ===');
            console.log('Recipients:', recipients);
            console.log('CC Recipients:', ccRecipients);
            console.log('Google Apps Script URL:', GOOGLE_APPS_SCRIPT_WEB_APP_URL);
            
            // Calculate total payload size
            const payloadString = JSON.stringify(payload);
            const payloadSizeKB = (payloadString.length / 1024).toFixed(2);
            const payloadSizeMB = (payloadString.length / 1024 / 1024).toFixed(2);
            console.log(`📦 Total payload size: ${payloadSizeKB} KB (${payloadSizeMB} MB)`);
            console.log(`📁 Files in payload: ${filesToUpload.length}`);
            filesToUpload.forEach((f, i) => {
                console.log(`   File ${i+1}: ${f.fileName} - base64 length: ${f.fileData ? f.fileData.length : 0}`);
            });
            
            // Check if payload is too large (> 5MB might fail)
            if (payloadString.length > 5 * 1024 * 1024) {
                console.warn('⚠️ Payload is very large (> 5MB), upload may fail');
            }

            try {
                // Use text/plain with UTF-8 charset to properly handle Vietnamese characters
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=UTF-8',
                    },
                    body: payloadString,
                });
                
                console.log('Response status:', response.status);
                console.log('Response received (no-cors mode, cannot read body)');

                // Since mode: 'no-cors' is used, response.ok will always be false.
                // We rely on the Apps Script to actually send the email and assume success
                // if no network error occurs. For a more robust solution, the Apps Script
                // should return a JSON response and the client should handle CORS.
                // For this example, we'll assume success if the fetch completes without error.

                // Update UI status and history
                // Update status display with proper status text
                const statusDisplay = document.getElementById('approval-status-display');
                statusDisplay.textContent = 'Đã gửi thông tin'; // Show "Đã gửi thông tin" when sent for approval
                statusDisplay.classList.remove('status-pending', 'status-rejected', 'status-approved');
                statusDisplay.classList.add('status-pending'); // Keep pending style for visual consistency

                // Update review status as well
                const reviewStatus = document.getElementById('review-status');
                if (reviewStatus) {
                    reviewStatus.textContent = 'Đã gửi thông tin';
                }

                const now = new Date();
                const timestamp = now.toLocaleString('vi-VN');
                approvalHistory.push({
                    timestamp: timestamp,
                    action: 'Đã gửi thông tin',
                    by: requestorName,
                    to: [selectedApproverName, selectedCompanyData ? selectedCompanyData["Đại diện pháp luật"] : '', selectedCompanyData ? selectedCompanyData["Kế toán trưởng"] : ''].filter(Boolean).join(', ')
                });
                renderApprovalHistory();

                showToast(`Đã gửi yêu cầu phê duyệt cho ${validRecipients.join(', ')}${validCCRecipients.length > 0 ? ' (CC: ' + validCCRecipients.join(', ') + ')' : ''}`, 'success', 'Gửi thành công');

            } catch (error) {
                console.error('Lỗi khi gửi yêu cầu phê duyệt qua Google Apps Script:', error);
                showToast('Không thể gửi yêu cầu phê duyệt tự động. Đang chuyển sang gửi qua email client', 'warning', 'Cảnh báo');
                
                // Fallback to mailto: if webhook fails
                const mailtoLink = `mailto:${recipients.join(',')}?cc=${ccRecipients.join(',')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBodyHtml.replace(/<[^>]*>?/gm, ''))}`; // Remove HTML for mailto body
                window.open(mailtoLink, '_blank');
            } finally {
                loadingIndicator.classList.remove('show');
                document.getElementById('send-approval-btn').disabled = false;
            }
        }

        function renderApprovalHistory() {
            const historyList = document.getElementById('approval-history-list');
            historyList.innerHTML = '';

            if (approvalHistory.length === 0) {
                historyList.innerHTML = '<li>Chưa có yêu cầu phê duyệt nào được gửi.</li>';
                return;
            }

            approvalHistory.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.textContent = `${entry.timestamp}: ${entry.action} bởi ${entry.by} (gửi đến: ${entry.to})`;
                historyList.appendChild(listItem);
            });
        }

        // Expense Table Functions
        function renderExpenseTable() {
            const tableBody = document.getElementById('expense-table-body');
            tableBody.innerHTML = '';

            expenseItems.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" value="${item.content || ''}" oninput="updateExpenseItem(${index}, 'content', this.value)"></td>
                    <td><input type="text" value="${formatCurrency(item.amount || 0)}" oninput="updateExpenseItem(${index}, 'amount', parseCurrency(this.value))" onblur="this.value = formatCurrency(parseCurrency(this.value))"></td>
                    <td class="attachment-cell">
                        <button type="button" class="attachment-button" onclick="triggerAttachmentInput(${index})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                            Đính kèm (${item.attachments.length})
                        </button>
                        <div class="file-preview-container" id="file-preview-${index}">
                            ${item.attachments.map((file, fileIndex) => {
                                const fileUrl = URL.createObjectURL(file);
                                const isImage = file.type.startsWith('image/');
                                return `
                                <div class="file-preview-item">
                                    ${isImage ? `<img src="${fileUrl}" alt="${file.name}" onclick="previewFileByIndex(${index}, ${fileIndex})" style="cursor: pointer; max-width: 100px; max-height: 100px;">` : ''}
                                    <div class="file-name" title="${file.name}">${file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name}</div>
                                    <button class="file-remove" onclick="removeFileFromRow(${index}, ${fileIndex})" title="Xóa file">&times;</button>
                                    ${!isImage ? `<button style="margin-top: 5px; padding: 4px 8px; font-size: 11px; background: var(--primary-color); color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="previewFileByIndex(${index}, ${fileIndex})">Preview</button>` : ''}
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </td>
                    <td><button type="button" class="remove-row-btn" onclick="removeExpenseRow(${index})">&times;</button></td>
                `;
            });
            updateGrandTotal();
        }

        function addExpenseRow() {
            expenseItems.push({ content: '', amount: 0, attachments: [] });
            renderExpenseTable();
            debounceAutoSave();
        }

        async function removeExpenseRow(index) {
            const confirmed = await showConfirmation(
                'Bạn có chắc chắn muốn xóa dòng này không?',
                'Xác nhận xóa'
            );
            
            if (confirmed) {
            expenseItems.splice(index, 1);
            renderExpenseTable();
                debounceAutoSave();
                showToast('Đã xóa dòng thành công', 'success');
            }
        }

        function updateExpenseItem(index, field, value) {
            expenseItems[index][field] = value;
            if (field === 'amount') {
                updateGrandTotal();
            }
            debounceAutoSave();
        }

        function triggerAttachmentInput(index) {
            // Use a global hidden file input that's always accessible
            let globalFileInput = document.getElementById('global-attachment-input');
            if (!globalFileInput) {
                // Create global file input if it doesn't exist
                globalFileInput = document.createElement('input');
                globalFileInput.type = 'file';
                globalFileInput.multiple = true;
                globalFileInput.id = 'global-attachment-input';
                globalFileInput.style.position = 'fixed';
                globalFileInput.style.left = '-9999px';
                globalFileInput.style.opacity = '0';
                globalFileInput.style.width = '1px';
                globalFileInput.style.height = '1px';
                globalFileInput.style.overflow = 'hidden';
                document.body.appendChild(globalFileInput);
            }
            
            // Store the index for when file is selected
            globalFileInput.setAttribute('data-row-index', index);
            
            // Clear previous value to allow selecting same file again
            globalFileInput.value = '';
            
            // Set up one-time event listener
            const handleFileSelect = (event) => {
                handleRowFileSelect(event, index);
                globalFileInput.removeEventListener('change', handleFileSelect);
            };
            
            globalFileInput.addEventListener('change', handleFileSelect);
            globalFileInput.click();
        }

        function handleRowFileSelect(event, index) {
            const files = Array.from(event.target.files);
            const validFiles = [];
            let hasError = false;
            
            files.forEach(file => {
                if (validateFile(file)) {
                    validFiles.push(file);
                } else {
                    hasError = true;
                }
            });
            
            if (validFiles.length > 0) {
                expenseItems[index].attachments = validFiles;
            renderExpenseTable();
                debounceAutoSave();
                if (validFiles.length === files.length) {
                    showToast(`Đã thêm ${validFiles.length} file thành công`, 'success');
                } else {
                    showToast(`Đã thêm ${validFiles.length}/${files.length} file`, 'warning');
                }
            } else if (!hasError) {
                expenseItems[index].attachments = [];
                renderExpenseTable();
            }
        }

        function updateGrandTotal() {
            const grandTotal = expenseItems.reduce((sum, item) => sum + (item.amount || 0), 0);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            document.getElementById('amount').value = formatCurrency(grandTotal);
            updateAmountInWords();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function parseCurrency(currencyString) {
            const cleanedString = currencyString.replace(/[^0-9,.]/g, '');
            const parts = cleanedString.split(',');
            if (parts.length > 1) {
                const lastPart = parts[parts.length - 1];
                if (lastPart.length <= 3 && lastPart.includes('.')) { 
                    return parseFloat(cleanedString.replace(/\./g, '').replace(',', '.'));
                } else if (lastPart.length <= 3 && !lastPart.includes('.')) { 
                    return parseFloat(cleanedString.replace(/,/g, ''));
                }
            }
            return parseFloat(cleanedString.replace(/\./g, '').replace(',', '.')) || 0;
        }

        async function copyFromExcelToTable() {
            try {
                const text = await navigator.clipboard.readText();
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    alert('Không có dữ liệu để dán từ clipboard.');
                    return;
                }

                const newItems = [];
                lines.forEach(line => {
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        const content = parts[0] || '';
                        const amount = parseCurrency(parts[1]) || 0;
                        newItems.push({ content, amount, attachments: [] });
                    }
                });

                if (newItems.length > 0) {
                    expenseItems = newItems;
                    renderExpenseTable();
                    debounceAutoSave();
                    showToast('Đã dán dữ liệu từ Excel vào bảng chi tiết thành công!', 'success', 'Thành công');
                } else {
                    showToast('Không thể phân tích dữ liệu dán. Vui lòng đảm bảo định dạng là "Nội dung\\tSố tiền"', 'error', 'Lỗi');
                }

            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                showToast('Không thể truy cập clipboard. Vui lòng đảm bảo bạn đã cấp quyền cho trình duyệt hoặc thử nhập từ file', 'error', 'Lỗi');
            }
        }

        function importExcelToTable() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    if (jsonData.length > 1) {
                        const newItems = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 2) {
                                const content = row[0] || '';
                                const amount = parseFloat(row[1]) || 0;
                                newItems.push({ content, amount, attachments: [] });
                            }
                        }

                        if (newItems.length > 0) {
                            expenseItems = newItems;
                            renderExpenseTable();
                            debounceAutoSave();
                            showToast('Đã nhập dữ liệu từ file Excel vào bảng chi tiết thành công!', 'success', 'Thành công');
                        } else {
                            showToast('Không tìm thấy dữ liệu hợp lệ trong file Excel. Vui lòng đảm bảo file có các cột "Nội dung", "Số tiền"', 'error', 'Lỗi');
                        }
                    } else {
                        showToast('File Excel trống hoặc không có dữ liệu', 'error', 'Lỗi');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            
            input.click();
        }

        /*
         * Google Apps Script (Code.gs) for sending emails:
         *
         * Instructions:
         * 1. Go to script.google.com and create a new project.
         * 2. Copy the following code into the Code.gs file.
         * 3. Save the project.
         * 4. Deploy the script as a Web App:
         *    - Click "Deploy" -> "New deployment".
         *    - Select "Web app" as the type.
         *    - Set "Execute as" to "Me" (your Google account).
         *    - Set "Who has access" to "Anyone".
         *    - Click "Deploy".
         *    - Authorize the script if prompted (it will ask for permission to send emails on your behalf).
         *    - Copy the "Web app URL" and replace 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' in the HTML with this URL.
         * 5. Test the integration by filling out the form and clicking "Gửi phê duyệt".
         */
        /*
        function doPost(e) {
            try {
                const requestBody = JSON.parse(e.postData.contents);
                const action = requestBody.action;

                if (action === 'sendApprovalEmail') {
                    const emailData = requestBody.email;
                    const to = emailData.to;
                    const cc = emailData.cc;
                    const subject = emailData.subject;
                    const body = emailData.body;

                    GmailApp.sendEmail(to, subject, '', {
                        htmlBody: body,
                        cc: cc
                    });

                    return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Email sent successfully.' }))
                        .setMimeType(ContentService.MimeType.JSON);
                } else {
                    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Invalid action.' }))
                        .setMimeType(ContentService.MimeType.JSON);
                }
            } catch (error) {
                return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.message }))
                    .setMimeType(ContentService.MimeType.JSON);
            }
        }
        */
    </script>
</body>
</html>