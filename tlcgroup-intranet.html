<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLCGroup - Global Intranet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: #1e293b; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            margin: 0;
            padding: 0;
        }
        /* Kissflow-style Modern Design */
        .kissflow-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .kissflow-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .kissflow-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .kissflow-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
            transition: all 0.3s;
        }
        .kissflow-card:hover .kissflow-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-left: 4px solid;
        }
        .search-bar {
            background: white;
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        .search-bar:focus-within {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }
        #app { 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            flex: 1; 
        }
        #main-content { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
            min-height: 0;
        }
        footer {
            margin-top: auto;
            flex-shrink: 0;
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .toast {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
            font-size: 14px;
            font-weight: 500;
        }
        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Form Validation */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transition: all 0.2s;
        }
        input.error, select.error, textarea.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        input.success, select.success, textarea.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .success-message {
            color: #10b981;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* Enhanced Hover Effects */
        .process-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .process-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #3b82f6;
        }
        /* Button Improvements */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        button:not(:disabled):active {
            transform: translateY(0);
        }
        /* Page Transitions */
        .page-section {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .nav-link.active { 
            color: #667eea; 
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 2px solid #667eea; 
        }
        .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; font-weight: 700; text-transform: uppercase; }
        #custom-logo-img { max-height: 32px; width: auto; object-fit: contain; }
        .page-section { transition: all 0.3s ease-in-out; }
        .form-section-container { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .sub-tab { transition: all 0.2s; border-bottom: 3px solid transparent; }
        .sub-tab.active { background: #f1f5f9; color: #2563eb; border-bottom-color: #2563eb; font-weight: 700; }
        input, select, textarea { border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.625rem; width: 100%; font-size: 0.875rem; background-color: white; }
        input:read-only, textarea:read-only { background-color: #f8fafc; color: #64748b; }
        label { display: block; font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 0.35rem; }
        /* Enhanced Approval Workflow Styles */
        .approval-block { 
            border: 2px dashed #cbd5e1; 
            padding: 1.5rem; 
            border-radius: 1rem; 
            background: #f8fafc; 
            margin-top: 1.5rem; 
        }
        .approval-timeline {
            position: relative;
            padding-left: 2rem;
        }
        .approval-timeline::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }
        .approval-step {
            position: relative;
            padding-bottom: 1.5rem;
        }
        .approval-step::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 3px solid #cbd5e1;
            z-index: 1;
        }
        .approval-step.completed::before {
            background: #10b981;
            border-color: #10b981;
        }
        .approval-step.active::before {
            background: #3b82f6;
            border-color: #3b82f6;
            animation: pulse 2s infinite;
        }
        .approval-step.pending::before {
            background: #fbbf24;
            border-color: #fbbf24;
        }
        .approval-step.rejected::before {
            background: #ef4444;
            border-color: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .approval-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .approval-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .approval-comment {
            background: #f8fafc;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            border-left: 3px solid #3b82f6;
        }
        .approval-history {
            max-height: 300px;
            overflow-y: auto;
        }
        .approval-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .badge-changes-requested { background: #dbeafe; color: #1e40af; }
        .parallel-approval {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .hidden { display: none !important; }
        
        /* Enhanced Kissflow-style Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        .data-table th { 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
            padding: 1rem 1.25rem; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #475569; 
            border-bottom: 2px solid #e2e8f0; 
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }
        .data-table th:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
        }
        .data-table th.sortable::after {
            content: ' ↕';
            opacity: 0.3;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }
        .data-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
            color: #667eea;
        }
        .data-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
            color: #667eea;
        }
        .data-table td { 
            padding: 1rem 1.25rem; 
            border-bottom: 1px solid #f1f5f9; 
            transition: background 0.2s;
        }
        .data-table tbody tr {
            transition: all 0.2s;
        }
        .data-table tbody tr:hover {
            background: #f8fafc;
            transform: scale(1.001);
        }
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Table Container with Filters */
        .table-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 1.5rem;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        .table-filters {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .filter-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #475569;
        }
        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .table-search {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            width: 250px;
            transition: all 0.2s;
        }
        .table-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .signature-box { 
            border: 1px solid #e2e8f0; 
            padding: 1rem; 
            border-radius: 0.75rem; 
            background: white; 
            text-align: center;
            transition: all 0.2s;
        }
        .signature-box:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        /* Enhanced Stats Cards */
        .stats-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        /* Enhanced Process Cards */
        .process-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        .process-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s;
        }
        .process-card:hover::before {
            transform: scaleX(1);
        }
        .process-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        /* Enhanced Form Container */
        .form-section-container {
            background: white;
            border-radius: 20px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }
        .form-section-container:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div id="app" class="flex flex-col flex-1">
        <!-- LOGIN PAGE -->
        <div id="login-page" class="hidden min-h-screen flex items-center justify-center bg-slate-900 p-4 fixed inset-0 z-50 bg-opacity-95">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative">
                <div class="absolute top-4 right-4">
                    <select onchange="setLanguage(this.value)" class="text-xs bg-slate-100 border-none rounded-lg px-2 py-1 outline-none cursor-pointer">
                        <option value="en">English</option>
                        <option value="vi">Tiếng Việt</option>
                    </select>
                </div>
                <div class="text-center mb-8">
                    <div id="login-logo-preview" class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-xl mb-4 text-white text-3xl">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h1 data-i18n="loginTitle" class="text-2xl font-bold text-slate-800">TLCGroup Login</h1>
                    <p data-i18n="loginSubtitle" class="text-slate-500 text-sm">Employee Portal Access</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label data-i18n="emailLabel">Email Address</label>
                        <input type="email" id="login-email" placeholder="admin@tlcgroup.com" required 
                               oninput="validateEmailInput(this)">
                        <div id="login-email-error" class="error-message hidden"></div>
                    </div>
                    <div>
                        <label data-i18n="passwordLabel">Password</label>
                        <input type="password" id="login-pass" placeholder="Enter your password" required
                               oninput="validatePasswordInput(this)">
                        <div id="login-pass-error" class="error-message hidden"></div>
                    </div>
                    <button type="submit" data-i18n="signIn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">Sign In</button>
                    <button type="button" onclick="closeLogin()" class="w-full bg-slate-200 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-300 transition text-sm">Cancel</button>
                </form>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="main-content" class="flex flex-col flex-1">
            <nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-slate-200/50 px-6 py-4 shadow-sm">
                <div class="max-w-7xl mx-auto flex items-center justify-between">
                    <div class="flex items-center space-x-8">
                        <div class="flex items-center space-x-3 cursor-pointer" onclick="showPage('home')">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span id="default-logo-icon" class="text-white text-lg font-black italic">TLC</span>
                                <img id="custom-logo-img" class="hidden w-full h-full object-contain rounded-xl" alt="Logo">
                            </div>
                            <span class="font-bold text-xl text-slate-800 tracking-tight">TLCGroup</span>
                        </div>
                        <div class="hidden lg:flex space-x-1">
                            <button onclick="showPage('home')" class="nav-link px-4 py-2 rounded-lg text-slate-600 hover:text-purple-600 hover:bg-purple-50 font-medium transition" id="nav-home" data-i18n="navDashboard">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </button>
                            <button onclick="showPage('comm')" class="nav-link px-4 py-2 rounded-lg text-slate-600 hover:text-purple-600 hover:bg-purple-50 font-medium transition" id="nav-comm" data-i18n="navComm">
                                <i class="fas fa-comments mr-2"></i>Communications
                            </button>
                            <button onclick="showPage('profile')" class="nav-link px-4 py-2 rounded-lg text-slate-600 hover:text-purple-600 hover:bg-purple-50 font-medium transition" id="nav-profile" data-i18n="navTasks">
                                <i class="fas fa-tasks mr-2"></i>My Tasks
                            </button>
                            <button onclick="showPage('admin')" class="nav-link px-4 py-2 rounded-lg text-orange-600 hover:text-orange-700 hover:bg-orange-50 font-bold transition hidden" id="nav-admin" data-i18n="navAdmin">
                                <i class="fas fa-shield-alt mr-2"></i>Admin
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center bg-slate-100 rounded-lg p-1">
                            <button onclick="setLanguage('en')" id="lang-en" class="px-2 py-1 text-[10px] font-bold rounded-md transition">EN</button>
                            <button onclick="setLanguage('vi')" id="lang-vi" class="px-2 py-1 text-[10px] font-bold rounded-md transition">VI</button>
                        </div>
                        <div id="user-nav-section" class="flex items-center space-x-3 border-l pl-4 ml-2">
                            <div id="login-button-section" class="hidden">
                                <button onclick="showLogin()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">Sign In</button>
                            </div>
                            <div id="user-info-section" class="hidden flex items-center space-x-3">
                                <div class="text-right hidden sm:block cursor-pointer" onclick="showPage('profile')">
                                    <p id="user-display-name" class="text-sm font-semibold text-slate-800"></p>
                                    <p id="user-display-role" class="text-xs text-slate-500 uppercase"></p>
                                </div>
                                <div class="relative group">
                                    <img id="user-avatar" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-sm cursor-pointer hover:ring-2 hover:ring-blue-500 transition" onclick="showPage('profile')">
                                    <div class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-xl border border-slate-200 hidden group-hover:block z-50 overflow-hidden">
                                        <button onclick="showPage('profile')" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 transition border-b border-slate-100">
                                            <i class="fas fa-user mr-2"></i> Profile
                                        </button>
                                        <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">
                                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Home Dashboard - Kissflow Style -->
            <main id="page-home" class="max-w-7xl mx-auto p-6 space-y-8 page-section animate-in fade-in">
                <!-- Welcome Header -->
                <header class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2" data-i18n="opsHubTitle">
                                Welcome back<span id="welcome-name" class="text-purple-200"></span>!
                            </h2>
                            <p class="text-purple-100 text-lg" data-i18n="opsHubDesc">Manage your workflows and processes</p>
                        </div>
                        <!-- Search Bar -->
                        <div class="search-bar w-80 hidden lg:block">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-search text-slate-400"></i>
                                <input type="text" placeholder="Search workflows, processes..." 
                                       class="border-none outline-none flex-1 text-slate-700 placeholder-slate-400"
                                       id="global-search">
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="stats-card border-l-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Active Processes</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1">12</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tasks text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card border-l-emerald-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Completed</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1">48</p>
                            </div>
                            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-emerald-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card border-l-amber-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Pending</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1">5</p>
                            </div>
                            <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-amber-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="stats-card border-l-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">This Month</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1">65</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Cards - Kissflow Style -->
                <div>
                    <h3 class="text-xl font-bold text-white mb-4">Workflow Processes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="kissflow-card p-6 process-card group cursor-pointer" onclick="showPage('process-o2c')">
                            <div class="kissflow-icon bg-gradient-to-br from-emerald-400 to-emerald-600 text-white">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-emerald-600 transition" data-i18n="o2cTitle">Order to Cash</h3>
                            <p class="text-sm text-slate-500 mb-4">Quotation, Contract, and VAT Invoicing</p>
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                                <span class="text-emerald-600 text-sm font-semibold flex items-center gap-2">
                                    <i class="fas fa-play-circle"></i>
                                    <span data-i18n="openProcesses">Launch</span>
                                </span>
                                <span class="text-xs text-slate-400">3 workflows</span>
                            </div>
                        </div>
                        <div class="kissflow-card p-6 process-card group cursor-pointer" onclick="showPage('process-p2p')">
                            <div class="kissflow-icon bg-gradient-to-br from-blue-400 to-blue-600 text-white">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-blue-600 transition" data-i18n="p2pTitle">Purchase to Pay</h3>
                            <p class="text-sm text-slate-500 mb-4">Procurement, Acceptance, and Payments</p>
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                                <span class="text-blue-600 text-sm font-semibold flex items-center gap-2">
                                    <i class="fas fa-play-circle"></i>
                                    <span data-i18n="openProcesses">Launch</span>
                                </span>
                                <span class="text-xs text-slate-400">4 workflows</span>
                            </div>
                        </div>
                        <div class="kissflow-card p-6 process-card group cursor-pointer" onclick="showPage('process-cash')">
                            <div class="kissflow-icon bg-gradient-to-br from-amber-400 to-amber-600 text-white">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-2 group-hover:text-amber-600 transition" data-i18n="cashTitle">Cash & Admin</h3>
                            <p class="text-sm text-slate-500 mb-4">Cash Book and Vouchers</p>
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                                <span class="text-amber-600 text-sm font-semibold flex items-center gap-2">
                                    <i class="fas fa-play-circle"></i>
                                    <span data-i18n="openProcesses">Launch</span>
                                </span>
                                <span class="text-xs text-slate-400">2 workflows</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activities - Kissflow Style -->
                <div class="mt-8">
                    <div class="kissflow-card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-slate-800">Recent Activities</h3>
                            <button class="text-sm text-purple-600 font-semibold hover:text-purple-700">View All</button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-slate-50 transition">
                                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check text-emerald-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-slate-800">Invoice #INV-2025-001 approved</p>
                                    <p class="text-xs text-slate-500">2 hours ago</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-slate-50 transition">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-invoice text-blue-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-slate-800">New purchase request submitted</p>
                                    <p class="text-xs text-slate-500">5 hours ago</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 p-3 rounded-lg hover:bg-slate-50 transition">
                                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-amber-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-slate-800">Payment voucher pending approval</p>
                                    <p class="text-xs text-slate-500">1 day ago</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- O2C DETAILED -->
            <main id="page-process-o2c" class="hidden max-w-7xl mx-auto p-6 page-section animate-in fade-in">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="showPage('home')" class="text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-2xl font-bold text-slate-800">Order-to-Cash & VAT System</h2>
                </div>
                <div class="form-section-container">
                    <div class="flex bg-slate-50 border-b overflow-x-auto">
                        <button onclick="toggleSubTab('o2c-comp', 'o2ct', 'o2cp')" class="o2ct sub-tab px-6 py-4 text-xs uppercase font-bold tracking-wider active">1. Company</button>
                        <button onclick="toggleSubTab('o2c-cust', 'o2ct', 'o2cp')" class="o2ct sub-tab px-6 py-4 text-xs uppercase font-bold tracking-wider">2. Customer</button>
                        <button onclick="toggleSubTab('o2c-quot', 'o2ct', 'o2cp')" class="o2ct sub-tab px-6 py-4 text-xs uppercase font-bold tracking-wider">3. Quotation</button>
                        <button onclick="toggleSubTab('o2c-cont', 'o2ct', 'o2cp')" class="o2ct sub-tab px-6 py-4 text-xs uppercase font-bold tracking-wider">4. Contract</button>
                        <button onclick="toggleSubTab('o2c-inv', 'o2ct', 'o2cp')" class="o2ct sub-tab px-6 py-4 text-xs uppercase font-bold tracking-wider">5. Invoice</button>
                    </div>
                    <div class="p-8">
                        <!-- Step 1: Company -->
                        <div id="o2c-comp" class="o2cp space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label>Select Company</label><select id="o2c-co-select" onchange="lookupCompany('o2c-co')"><option value="">-- Select Company --</option></select></div>
                                <div><label>Requester</label><select id="o2c-req-select"><option value="">-- Select Person --</option></select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label>Tax Code</label><input type="text" id="o2c-co-tax" readonly></div>
                                <div><label>Legal Rep</label><input type="text" id="o2c-co-rep" readonly></div>
                            </div>
                        </div>
                        <!-- Step 2: Customer -->
                        <div id="o2c-cust" class="o2cp hidden space-y-4">
                            <div class="bg-slate-50 p-4 rounded-xl flex gap-6 mb-4">
                                <label class="flex items-center gap-2 text-sm font-bold cursor-pointer"><input type="radio" name="o2c-cust-opt" value="ex" checked onchange="o2cToggleCust('ex')"> Existing Customer</label>
                                <label class="flex items-center gap-2 text-sm font-bold cursor-pointer"><input type="radio" name="o2c-cust-opt" value="new" onchange="o2cToggleCust('new')"> New Customer</label>
                            </div>
                            <div id="o2c-cust-ex-area" class="space-y-4">
                                <div><label>Search Existing Customer</label><select id="o2c-cust-select" onchange="lookupCustomer()"><option value="">-- Select --</option></select></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label>Customer Name</label><input type="text" id="o2c-cu-name" readonly></div>
                                    <div><label>Tax ID</label><input type="text" id="o2c-cu-tax" readonly></div>
                                </div>
                            </div>
                            <div id="o2c-cust-new-area" class="hidden space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label>Full Name</label><input type="text" placeholder="Full name..."></div>
                                    <div><label>Tax ID</label><input type="text" placeholder="Tax ID..."></div>
                                </div>
                                <div><label>Full Address</label><textarea rows="2"></textarea></div>
                            </div>
                        </div>
                        <!-- Step 3: Quotation -->
                        <div id="o2c-quot" class="o2cp hidden space-y-6">
                            <div class="flex justify-between items-center"><h3 class="font-bold">Items & Prices</h3><button onclick="addRow('o2c-items-body')" class="text-blue-600 font-bold text-xs"><i class="fas fa-plus"></i> Add Line</button></div>
                            <div class="table-container"><table class="data-table border"><thead><tr><th>No</th><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody id="o2c-items-body"></tbody></table></div>
                            <!-- Enhanced Approval Workflow -->
                            <div class="approval-block border-blue-200 bg-blue-50/30">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-blue-800 flex items-center gap-2">
                                        <i class="fas fa-check-circle"></i>
                                        Quotation Approval Workflow
                                    </h4>
                                    <span class="approval-badge badge-pending">
                                        <i class="fas fa-clock"></i>
                                        Pending
                                    </span>
                                </div>
                                
                                <!-- Approval Timeline -->
                                <div class="approval-timeline">
                                    <!-- Step 1: Manager Approval -->
                                    <div class="approval-step active">
                                        <div class="approval-card">
                                            <div class="flex items-center justify-between mb-2">
                                                <div>
                                                    <p class="font-semibold text-slate-800">Level 1: Manager Approval</p>
                                                    <p class="text-xs text-slate-500">Assigned to: <select class="inline-block border-none bg-transparent text-xs font-semibold text-slate-700" id="o2c-mgr-approver"><option>Select Manager</option></select></p>
                                                </div>
                                                <span class="approval-badge badge-pending">Pending</span>
                                            </div>
                                            <div class="approval-actions">
                                                <button onclick="approveStep('o2c-quot', 1)" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-700 transition">
                                                    <i class="fas fa-check mr-2"></i>Approve
                                                </button>
                                                <button onclick="rejectStep('o2c-quot', 1)" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition">
                                                    <i class="fas fa-times mr-2"></i>Reject
                                                </button>
                                                <button onclick="requestChanges('o2c-quot', 1)" class="flex-1 bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-amber-700 transition">
                                                    <i class="fas fa-edit mr-2"></i>Request Changes
                                                </button>
                                            </div>
                                            <textarea id="o2c-quot-comment-1" placeholder="Add comment (optional)" class="mt-2 w-full text-sm border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2: Director Approval (Conditional) -->
                                    <div class="approval-step pending">
                                        <div class="approval-card">
                                            <div class="flex items-center justify-between mb-2">
                                                <div>
                                                    <p class="font-semibold text-slate-800">Level 2: Director Approval</p>
                                                    <p class="text-xs text-slate-500">Required if amount &gt; 10,000,000 VND</p>
                                                    <p class="text-xs text-slate-500">Assigned to: <select class="inline-block border-none bg-transparent text-xs font-semibold text-slate-700" id="o2c-dir-approver"><option>Select Director</option></select></p>
                                                </div>
                                                <span class="approval-badge badge-pending">Waiting</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Approval History -->
                                <div class="mt-4 pt-4 border-t border-slate-200">
                                    <button onclick="toggleApprovalHistory('o2c-quot-history')" class="text-sm text-blue-600 font-semibold hover:text-blue-700 flex items-center gap-2">
                                        <i class="fas fa-history"></i>
                                        View Approval History
                                        <i class="fas fa-chevron-down text-xs" id="o2c-quot-history-icon"></i>
                                    </button>
                                    <div id="o2c-quot-history" class="approval-history hidden mt-3 space-y-2">
                                        <div class="text-xs text-slate-500 italic">No history yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Step 4: Contract -->
                        <div id="o2c-cont" class="o2cp hidden space-y-6">
                            <!-- Parallel Approval: Legal, Accountant & Director -->
                            <div class="approval-block border-emerald-200 bg-emerald-50/20">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-emerald-800 flex items-center gap-2">
                                        <i class="fas fa-gavel"></i>
                                        Legal, Accountant & Director Approval
                                    </h4>
                                    <span class="text-xs text-slate-600 bg-white px-3 py-1 rounded-full border border-emerald-200">
                                        <i class="fas fa-sitemap mr-1"></i>Parallel Approval
                                    </span>
                                </div>
                                
                                <div class="parallel-approval">
                                    <!-- Legal Approval -->
                                    <div class="approval-card">
                                        <div class="flex items-center justify-between mb-3">
                                            <label class="font-semibold text-slate-800 flex items-center gap-2">
                                                <i class="fas fa-balance-scale text-emerald-600"></i>
                                                Legal
                                            </label>
                                            <span class="approval-badge badge-pending">Pending</span>
                                        </div>
                                        <select id="o2c-app-legal" class="mb-3">
                                            <option value="">Select Legal Officer</option>
                                        </select>
                                        <div class="approval-actions">
                                            <button onclick="approveParallel('legal', 'o2c-cont')" class="flex-1 bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-emerald-700 transition">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="rejectParallel('legal', 'o2c-cont')" class="flex-1 bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-700 transition">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <input type="text" id="o2c-legal-sign" class="mt-2 text-center text-sm" placeholder="Sign name">
                                        <textarea id="o2c-legal-comment" placeholder="Comment" class="mt-2 w-full text-xs border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                    </div>
                                    
                                    <!-- Accountant Approval -->
                                    <div class="approval-card">
                                        <div class="flex items-center justify-between mb-3">
                                            <label class="font-semibold text-slate-800 flex items-center gap-2">
                                                <i class="fas fa-calculator text-blue-600"></i>
                                                Accountant
                                            </label>
                                            <span class="approval-badge badge-pending">Pending</span>
                                        </div>
                                        <select id="o2c-app-acc" class="mb-3">
                                            <option value="">Select Accountant</option>
                                        </select>
                                        <div class="approval-actions">
                                            <button onclick="approveParallel('accountant', 'o2c-cont')" class="flex-1 bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-emerald-700 transition">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="rejectParallel('accountant', 'o2c-cont')" class="flex-1 bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-700 transition">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <input type="text" id="o2c-acc-sign" class="mt-2 text-center text-sm" placeholder="Sign name">
                                        <textarea id="o2c-acc-comment" placeholder="Comment" class="mt-2 w-full text-xs border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                    </div>
                                    
                                    <!-- Director Approval -->
                                    <div class="approval-card">
                                        <div class="flex items-center justify-between mb-3">
                                            <label class="font-semibold text-slate-800 flex items-center gap-2">
                                                <i class="fas fa-user-tie text-purple-600"></i>
                                                Director
                                            </label>
                                            <span class="approval-badge badge-pending">Pending</span>
                                        </div>
                                        <select id="o2c-app-dir" class="mb-3">
                                            <option value="">Select Director</option>
                                        </select>
                                        <div class="approval-actions">
                                            <button onclick="approveParallel('director', 'o2c-cont')" class="flex-1 bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-emerald-700 transition">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="rejectParallel('director', 'o2c-cont')" class="flex-1 bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-700 transition">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <input type="text" id="o2c-dir-sign" class="mt-2 text-center text-sm" placeholder="Sign name">
                                        <textarea id="o2c-dir-comment" placeholder="Comment" class="mt-2 w-full text-xs border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs text-blue-800">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>Parallel Approval:</strong> All three approvals must be completed before proceeding to next step.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Step 5: Invoice -->
                        <div id="o2c-inv" class="o2cp hidden space-y-6">
                             <div class="approval-block border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-4">🧾 VAT Invoice Issuance</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label>Invoice No</label><input type="text" placeholder="INV-2025-..."></div>
                                    <div><label>Date</label><input type="date"></div>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- P2P DETAILED -->
            <main id="page-process-p2p" class="hidden max-w-7xl mx-auto p-6 page-section animate-in fade-in">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="showPage('home')" class="text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-2xl font-bold text-slate-800">Purchase to Pay System</h2>
                </div>
                <div class="form-section-container">
                    <div class="flex bg-slate-50 border-b">
                        <button onclick="toggleSubTab('p2p-pr', 'p2pt', 'p2pp')" class="p2pt sub-tab px-6 py-4 text-xs uppercase font-bold active">1. Purchase Request</button>
                        <button onclick="toggleSubTab('p2p-acc', 'p2pt', 'p2pp')" class="p2pt sub-tab px-6 py-4 text-xs uppercase font-bold">2. Acceptance Minutes</button>
                        <button onclick="toggleSubTab('p2p-pay', 'p2pt', 'p2pp')" class="p2pt sub-tab px-6 py-4 text-xs uppercase font-bold">3. Payment Request</button>
                    </div>
                    <div class="p-8">
                        <div id="p2p-pr" class="p2pp space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label>PR Request No</label><input type="text" id="p2p-pr-no" readonly></div>
                                <div><label>Company</label><select id="p2p-co-select" onchange="lookupCompany('p2p-co')"><option value="">-- Select --</option></select></div>
                            </div>
                            
                            <!-- Enhanced Multi-level Approval -->
                            <div class="approval-block border-blue-200 bg-blue-50/30">
                                <div class="flex items-center justify-between mb-4">
                                    <h4 class="font-bold text-blue-800 flex items-center gap-2">
                                        <i class="fas fa-clipboard-check"></i>
                                        Purchase Request Approval Workflow
                                    </h4>
                                    <span class="approval-badge badge-pending">
                                        <i class="fas fa-clock"></i>
                                        In Progress
                                    </span>
                                </div>
                                
                                <div class="approval-timeline">
                                    <!-- Step 1: Budget Approval -->
                                    <div class="approval-step active">
                                        <div class="approval-card">
                                            <div class="flex items-center justify-between mb-2">
                                                <div>
                                                    <p class="font-semibold text-slate-800 flex items-center gap-2">
                                                        <i class="fas fa-dollar-sign text-emerald-600"></i>
                                                        Step 1: Budget Approval
                                                    </p>
                                                    <p class="text-xs text-slate-500 mt-1">Assigned to: <select class="inline-block border-none bg-transparent text-xs font-semibold text-slate-700" id="p2p-budget-app"><option>Select Budget Approver</option></select></p>
                                                </div>
                                                <span class="approval-badge badge-pending">Active</span>
                                            </div>
                                            <div class="approval-actions">
                                                <button onclick="approveStep('p2p-pr', 1)" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-700 transition">
                                                    <i class="fas fa-check mr-2"></i>Approve
                                                </button>
                                                <button onclick="rejectStep('p2p-pr', 1)" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition">
                                                    <i class="fas fa-times mr-2"></i>Reject
                                                </button>
                                            </div>
                                            <textarea id="p2p-pr-comment-1" placeholder="Add comment" class="mt-2 w-full text-sm border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 2: Supplier Approval (Parallel with Budget) -->
                                    <div class="approval-step active">
                                        <div class="approval-card">
                                            <div class="flex items-center justify-between mb-2">
                                                <div>
                                                    <p class="font-semibold text-slate-800 flex items-center gap-2">
                                                        <i class="fas fa-truck text-blue-600"></i>
                                                        Step 2: Supplier Approval
                                                    </p>
                                                    <p class="text-xs text-slate-500 mt-1">Can run parallel with Budget Approval</p>
                                                    <p class="text-xs text-slate-500">Assigned to: <select class="inline-block border-none bg-transparent text-xs font-semibold text-slate-700" id="p2p-supp-app"><option>Select Supplier Approver</option></select></p>
                                                </div>
                                                <span class="approval-badge badge-pending">Active</span>
                                            </div>
                                            <div class="approval-actions">
                                                <button onclick="approveStep('p2p-pr', 2)" class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-700 transition">
                                                    <i class="fas fa-check mr-2"></i>Approve
                                                </button>
                                                <button onclick="rejectStep('p2p-pr', 2)" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-700 transition">
                                                    <i class="fas fa-times mr-2"></i>Reject
                                                </button>
                                            </div>
                                            <textarea id="p2p-pr-comment-2" placeholder="Add comment" class="mt-2 w-full text-sm border border-slate-200 rounded-lg p-2 resize-none" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Step 3: Final Approval (Sequential - after Step 1 & 2) -->
                                    <div class="approval-step pending">
                                        <div class="approval-card">
                                            <div class="flex items-center justify-between mb-2">
                                                <div>
                                                    <p class="font-semibold text-slate-800 flex items-center gap-2">
                                                        <i class="fas fa-check-double text-purple-600"></i>
                                                        Step 3: Final Approval
                                                    </p>
                                                    <p class="text-xs text-slate-500 mt-1">Required after Budget & Supplier approval</p>
                                                    <p class="text-xs text-slate-500">Assigned to: <select class="inline-block border-none bg-transparent text-xs font-semibold text-slate-700" id="p2p-final-app"><option>Select Final Approver</option></select></p>
                                                </div>
                                                <span class="approval-badge badge-pending">Waiting</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Approval Progress -->
                                <div class="mt-4 pt-4 border-t border-slate-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-semibold text-slate-700">Approval Progress</span>
                                        <span class="text-sm text-slate-500">0 of 3 completed</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div id="p2p-pr-approval-progress" class="bg-emerald-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Approval History -->
                                <div class="mt-4 pt-4 border-t border-slate-200">
                                    <button onclick="toggleApprovalHistory('p2p-pr-history')" class="text-sm text-blue-600 font-semibold hover:text-blue-700 flex items-center gap-2">
                                        <i class="fas fa-history"></i>
                                        View Approval History
                                        <i class="fas fa-chevron-down text-xs" id="p2p-pr-history-icon"></i>
                                    </button>
                                    <div id="p2p-pr-history" class="approval-history hidden mt-3 space-y-2">
                                        <div class="text-xs text-slate-500 italic">No history yet</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="p2p-acc" class="p2pp hidden space-y-6">
                            <h3 class="text-xl font-bold text-center border-b pb-4">BIÊN BẢN NGHIỆM THU</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="p-4 border rounded-xl bg-slate-50"><h5 class="text-[10px] font-black text-blue-600 uppercase mb-2">Bên A (Nghiệm thu)</h5><p id="p2p-side-a-name" class="font-bold">---</p></div>
                                <div class="p-4 border rounded-xl bg-slate-50"><h5 class="text-[10px] font-black text-blue-600 uppercase mb-2">Bên B (Cung cấp)</h5><input type="text" placeholder="Nhà cung cấp / Supplier..."></div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="signature-box"><label>Người lập</label><select id="acc-creator"></select><input type="text" class="mt-2 text-xs" placeholder="Sign..."></div>
                                <div class="signature-box"><label>Người nghiệm thu</label><select id="acc-acceptor"></select><input type="text" class="mt-2 text-xs" placeholder="Sign..."></div>
                                <div class="signature-box"><label>Kế toán trưởng</label><input type="text" class="bg-slate-50" readonly id="p2p-acc-accountant"><input type="text" class="mt-2 text-xs" placeholder="Sign..."></div>
                                <div class="signature-box"><label>Giám đốc</label><input type="text" class="bg-slate-50" readonly id="p2p-acc-director"><input type="text" class="mt-2 text-xs" placeholder="Sign..."></div>
                            </div>
                        </div>

                        <div id="p2p-pay" class="p2pp hidden space-y-6">
                             <div class="approval-block border-orange-200 bg-orange-50/10">
                                <h4 class="font-bold text-orange-800 mb-4 uppercase text-center">Đề nghị thanh toán</h4>
                                <label>Final Approver</label><select id="p2p-final-app"></select>
                                <button class="w-full bg-orange-600 text-white font-bold py-3 rounded-xl mt-4">SUBMIT FINAL PAYMENT</button>
                             </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- CASH DETAILED -->
            <main id="page-process-cash" class="hidden max-w-7xl mx-auto p-6 page-section animate-in fade-in">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="showPage('home')" class="text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-2xl font-bold text-slate-800">Cash & Vouchers</h2>
                </div>

                <!-- Top-line Summary: Voucher vs Cash Book -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Voucher Topline -->
                    <div class="form-section-container">
                        <div class="p-4 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-purple-600 uppercase tracking-wide mb-1">
                                    Voucher Summary
                                </p>
                                <p class="text-sm text-slate-600">
                                    <span id="topline-voucher-total">-</span> vouchers •
                                    <span id="topline-voucher-pending">-</span> pending •
                                    <span id="topline-voucher-approved">-</span> approved •
                                    <span id="topline-voucher-rejected">-</span> rejected
                                </p>
                            </div>
                            <button
                                type="button"
                                onclick="window.open('phieu_thu_chi.html', '_blank')"
                                class="inline-flex items-center gap-2 text-xs font-semibold text-purple-600 hover:text-purple-700">
                                <span>Open Vouchers</span>
                                <i class="fas fa-arrow-up-right-from-square text-[11px]"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Cash Book Topline -->
                    <div class="form-section-container">
                        <div class="p-4 flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-sky-600 uppercase tracking-wide mb-1">
                                    Cash Book Summary
                                </p>
                                <p class="text-sm text-slate-600">
                                    Balance today: <span id="topline-cashbook-balance">145,000,000 ₫</span> •
                                    Entries today: <span id="topline-cashbook-entries">1</span>
                                </p>
                            </div>
                            <button
                                type="button"
                                onclick="showToast('Cash Book detail view will be implemented in the next phase.', 'info')"
                                class="inline-flex items-center gap-2 text-xs font-semibold text-slate-500 hover:text-slate-700">
                                <span>View Cash Book</span>
                                <i class="fas fa-up-right-from-square text-[11px]"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Detailed Voucher Status Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" id="cash-summary-cards">
                    <div class="stats-card border-l-purple-500">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Total Vouchers</h3>
                            <i class="fas fa-file-invoice text-purple-500 text-xl"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="summary-total">-</p>
                        <p class="text-xs text-slate-500 mt-1">All vouchers</p>
                    </div>
                    <div class="stats-card border-l-amber-500">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Pending</h3>
                            <i class="fas fa-clock text-amber-500 text-xl"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="summary-pending">-</p>
                        <p class="text-xs text-slate-500 mt-1">Awaiting approval</p>
                    </div>
                    <div class="stats-card border-l-emerald-500">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Approved</h3>
                            <i class="fas fa-check-circle text-emerald-500 text-xl"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="summary-approved">-</p>
                        <p class="text-xs text-slate-500 mt-1">Completed</p>
                    </div>
                    <div class="stats-card border-l-red-500">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Rejected</h3>
                            <i class="fas fa-times-circle text-red-500 text-xl"></i>
                        </div>
                        <p class="text-3xl font-bold text-slate-800" id="summary-rejected">-</p>
                        <p class="text-xs text-slate-500 mt-1">Declined</p>
                    </div>
                </div>

                <!-- Recent Vouchers + Vouchers/Cash Book Summary Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recent Vouchers Summary -->
                    <div class="form-section-container">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fas fa-history text-purple-600"></i>
                                        Recent Vouchers
                                    </h3>
                                    <p class="text-sm text-slate-500 mt-1">Latest voucher activities</p>
                                </div>
                                <button onclick="loadCashSummary()" class="text-sm text-purple-600 hover:text-purple-700 font-semibold flex items-center gap-2">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh
                                </button>
                            </div>
                            <div id="recent-vouchers-list" class="space-y-3">
                                <div class="text-center py-8 text-slate-400">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading vouchers...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vouchers & Cash Book Cards -->
                    <div class="space-y-4">
                        <!-- Vouchers (Phiếu Thu/Chi) Card -->
                        <button
                            type="button"
                            onclick="window.open('phieu_thu_chi.html', '_blank')"
                            class="w-full text-left form-section-container hover:shadow-xl transition transform hover:-translate-y-0.5">
                            <div class="p-6 flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-purple-600 uppercase tracking-wide mb-1">
                                        Vouchers (Phiếu Thu/Chi)
                                    </p>
                                    <h3 class="text-lg font-bold text-slate-800 mb-1">
                                        Voucher Workflow Summary
                                    </h3>
                                    <p class="text-sm text-slate-500">
                                        Xem, tạo mới và theo dõi toàn bộ phiếu thu/chi trong tab mới.
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-purple-100 text-purple-600">
                                        <i class="fas fa-file-invoice"></i>
                                    </span>
                                    <i class="fas fa-arrow-up-right-from-square text-slate-400"></i>
                                </div>
                            </div>
                        </button>

                        <!-- Cash Book (Sổ quỹ) Card -->
                        <button
                            type="button"
                            onclick="showToast('Cash Book detail view will be implemented in the next phase.', 'info')"
                            class="w-full text-left form-section-container hover:shadow-xl transition transform hover:-translate-y-0.5">
                            <div class="p-6 flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold text-sky-600 uppercase tracking-wide mb-1">
                                        Cash Book (Sổ quỹ)
                                    </p>
                                    <h3 class="text-lg font-bold text-slate-800 mb-1">
                                        Cash Book Summary
                                    </h3>
                                    <p class="text-sm text-slate-500">
                                        Màn hình chi tiết sổ quỹ (bảng giao dịch, lọc, phân trang) sẽ được mở rộng sau.
                                    </p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-sky-100 text-sky-600">
                                        <i class="fas fa-book"></i>
                                    </span>
                                    <i class="fas fa-up-right-from-square text-slate-300"></i>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </main>

            <!-- Admin & Profile -->
            <main id="page-profile" class="hidden max-w-7xl mx-auto p-6 space-y-8 animate-in slide-in-from-right-4">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 flex flex-col md:flex-row md:items-center justify-between gap-6 shadow-sm">
                    <div class="flex items-center space-x-6">
                        <img id="profile-avatar" src="" class="w-20 h-20 rounded-2xl shadow-md border-4 border-white">
                        <div>
                            <div class="flex items-center gap-3"><h2 id="profile-name" class="text-2xl font-bold"></h2><span id="admin-verified-badge" class="hidden bg-orange-500 text-white text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest shadow-sm">Administrator</span></div>
                            <p id="profile-role" class="text-slate-500"></p>
                        </div>
                    </div>
                    <div>
                        <button onclick="handleLogout()" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- User Profile Details -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <i class="fas fa-user-circle"></i>
                        <span>Thông tin cá nhân</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Email</label>
                            <p id="profile-email" class="mt-1 text-slate-800"></p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Chức vụ</label>
                            <p id="profile-position" class="mt-1 text-slate-800"></p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Phòng ban</label>
                            <p id="profile-department" class="mt-1 text-slate-800"></p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Công ty</label>
                            <p id="profile-company" class="mt-1 text-slate-800"></p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Điện thoại</label>
                            <p id="profile-phone" class="mt-1 text-slate-800"></p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Employee ID</label>
                            <p id="profile-employee-id" class="mt-1 text-slate-800"></p>
                        </div>
                    </div>
                </div>
                <div id="admin-management-hub" class="hidden space-y-6">
                    <div class="admin-card p-6 border-blue-100 shadow-blue-50 shadow-lg">
                        <h3 class="font-bold text-blue-800 mb-6 flex items-center gap-2"><i class="fas fa-user-plus"></i> <span>User Management</span></h3>
                        <form onsubmit="handleAddEmployee(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="new-emp-name" required placeholder="Full Name"><input type="email" id="new-emp-email" required placeholder="Email"></div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">ADD EMPLOYEE</button>
                        </form>
                        <div id="mgmt-feedback" class="hidden mt-4 p-3 rounded-xl text-xs font-bold text-center border"></div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- FOOTER -->
        <footer class="mt-auto border-t border-slate-200 py-6 bg-white text-center text-xs text-slate-400">
            <p>&copy; 2025 TLCGroup. All rights reserved.</p>
        </footer>
    </div>

    <script>
        const apiKey = "";
        // ⚠️ IMPORTANT: Replace with your Google Apps Script Web App URL
        const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwTbvtCOS5GVNCHDeRguD8CKnvIh0XeubKpke4_gdIizOvh_V24h3F2nwpyKnFos_Om/exec';
        
        let currentLang = 'en';
        let currentUser = null;
        let requestedPage = 'home'; // Store the page user wants to access
        const publicPages = ['home']; // Pages that don't require login

        const companiesData = [
            { name: "CÔNG TY TNHH TƯ VẤN TLC", addr: "B.3.09, Tầng 3, Lô B, Số 34-35 Bến Vân Đồn, HCM", tax: "0313519756", rep: "Lê Ngân Anh", accountant: "Nguyễn Thị Nhanh" },
            { name: "CÔNG TY TNHH EGG VENTURES", addr: "Lầu 7, Tòa nhà Vincom Center, 72 Lê Thánh Tôn, HCM", tax: "0314494060", rep: "Phạm Thị Dung", accountant: "Nguyễn Văn An" },
            { name: "CÔNG TY CP ĐẦU TƯ CHINH PHONG", addr: "Lầu 10, Diamond Plaza, 34 Lê Duẩn, HCM", tax: "0314097507", rep: "Hoàng Văn Em", accountant: "Lê Minh Cường" }
        ];

        const customersData = [
            { name: "CÔNG TY TNHH ABC", taxId: "0123456789", addr: "123 Đường ABC, Q1, HCM" },
            { name: "CÔNG TY CP XYZ", taxId: "9876543210", addr: "456 Đường XYZ, Q3, HCM" }
        ];

        const employeeNames = ["Lê Ngân Anh", "Nguyễn Văn Chinh", "Lê Thùy Linh", "Nguyễn Lực", "Nguyễn Thị Nhanh", "Nguyễn Văn An", "Phạm Thị Dung", "Hoàng Văn Em", "Lê Minh Cường"];

        const translations = {
            en: { loginTitle: "TLCGroup Login", opsHubTitle: "Group Operations Hub", o2cTitle: "Order to Cash", p2pTitle: "Purchase to Pay", cashTitle: "Cash & Admin", openProcesses: "Launch System", backToDash: "Back", quotation: "Quotation", contract: "Contract", vatInvoice: "VAT Invoice", purchaseRequest: "Purchase Request", acceptance: "Acceptance", paymentRequest: "Payment Request", cashBook: "Cash Book", vouchers: "Vouchers", aiTitle: "✨ Ask TLC AI", aiWelcome: "Hello! I can help with O2C, P2P or Cash." },
            vi: { loginTitle: "Đăng nhập TLCGroup", opsHubTitle: "Vận hành Nhóm", o2cTitle: "Bán hàng (O2C)", p2pTitle: "Mua hàng (P2P)", cashTitle: "Tiền mặt & Quản trị", openProcesses: "Mở hệ thống", backToDash: "Quay lại", quotation: "Báo giá", contract: "Hợp đồng", vatInvoice: "Hóa đơn VAT", purchaseRequest: "Yêu cầu mua hàng", acceptance: "Biên bản nghiệm thu", paymentRequest: "Đề nghị thanh toán", cashBook: "Sổ quỹ", vouchers: "Phiếu thu/chi", aiTitle: "✨ Hỏi Đáp TLC AI", aiWelcome: "Xin chào! Tôi có thể giúp gì về O2C, P2P hay Tiền mặt?" }
        };

        function showPage(pageId) {
            // Check if page requires authentication
            const isPublicPage = publicPages.includes(pageId);
            
            // If page requires login and user is not logged in, show login screen
            if (!isPublicPage && !currentUser) {
                requestedPage = pageId; // Store the page they want to access
                showLogin();
                return;
            }
            
            // Hide login if showing a page
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            // Show the requested page
            document.querySelectorAll('main').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(`page-${pageId}`);
            if (target) target.classList.remove('hidden'); else document.getElementById('page-home').classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navBaseId = pageId.startsWith('process-') ? pageId.replace('process-', '') : pageId;
            const navBtn = document.getElementById(`nav-${navBaseId}`);
            if (navBtn) navBtn.classList.add('active');
            
            // Load summary data when entering Cash & Admin page
            if (pageId === 'process-cash') {
                loadCashSummary();
            }
            
            window.scrollTo(0,0);
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
        }

        function closeLogin() {
            document.getElementById('login-page').classList.add('hidden');
            // Reset requested page to home if user cancels
            requestedPage = 'home';
            showPage('home');
        }

        function handleLogout() {
            // Show logout confirmation toast
            showToast('Logged out successfully', 'info');
            
            // Clear current user (in-memory + persistent)
            currentUser = null;
            try {
                localStorage.removeItem('tlc_current_user');
            } catch (e) {
                console.warn('Could not clear localStorage user:', e);
            }
            
            // Update UI (will show login button)
            updateUI();
            
            // Hide main content, show login page
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            
            // Reset requested page
            requestedPage = 'home';
            
            // Clear login form
            const emailInput = document.getElementById('login-email');
            const passInput = document.getElementById('login-pass');
            if (emailInput) {
                emailInput.value = '';
                emailInput.classList.remove('error', 'success');
            }
            if (passInput) {
                passInput.value = '';
                passInput.classList.remove('error', 'success');
            }
            
            // Hide error messages
            const emailError = document.getElementById('login-email-error');
            const passError = document.getElementById('login-pass-error');
            if (emailError) emailError.classList.add('hidden');
            if (passError) passError.classList.add('hidden');
            
            // Show homepage if login page is hidden
            showPage('home');
            
            console.log('User logged out');
        }

        function toggleSubTab(paneId, tabClass, paneClass) {
            document.querySelectorAll('.' + paneClass).forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(paneId);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.' + tabClass).forEach(t => t.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
        }

        function lookupCompany(prefix) {
            const val = document.getElementById(`${prefix}-select`).value;
            const co = companiesData.find(c => c.name === val);
            if (!co) return;
            const taxInput = document.getElementById(`${prefix}-tax`); if(taxInput) taxInput.value = co.tax;
            const repInput = document.getElementById(`${prefix}-rep`); if(repInput) repInput.value = co.rep;
            const addrText = document.getElementById(`${prefix}-addr`); if(addrText) addrText.value = co.addr;
            const sideAName = document.getElementById('p2p-side-a-name'); if(sideAName) sideAName.innerText = co.name;
            const accountantInput = document.getElementById('p2p-acc-accountant'); if(accountantInput) accountantInput.value = co.accountant;
            const directorInput = document.getElementById('p2p-acc-director'); if(directorInput) directorInput.value = co.rep;
        }

        function o2cToggleCust(type) {
            if(type === 'ex') {
                document.getElementById('o2c-cust-ex-area').classList.remove('hidden');
                document.getElementById('o2c-cust-new-area').classList.add('hidden');
            } else {
                document.getElementById('o2c-cust-ex-area').classList.add('hidden');
                document.getElementById('o2c-cust-new-area').classList.remove('hidden');
            }
        }

        function lookupCustomer() {
            const val = document.getElementById('o2c-cust-select').value;
            const cu = customersData.find(c => c.name === val);
            if (!cu) return;
            document.getElementById('o2c-cu-name').value = cu.name;
            document.getElementById('o2c-cu-tax').value = cu.taxId;
        }

        function addRow(bodyId) {
            const body = document.getElementById(bodyId);
            if(!body) return;
            const row = document.createElement('tr');
            row.innerHTML = `<td class="p-2 text-xs">${body.children.length+1}</td><td class="p-2"><input type="text" class="text-xs"></td><td class="p-2"><input type="number" class="w-12 text-xs" value="1"></td><td class="p-2"><input type="number" class="w-full text-xs"></td><td class="p-2 font-bold text-xs">0</td>`;
            body.appendChild(row);
        }

        function convertToWords(n) {
            const el = document.getElementById('cash-words');
            if(!el) return;
            if(!n || n == 0) { el.innerText = '---'; return; }
            el.innerText = `(Simulated) ${parseFloat(n).toLocaleString()} Vietnamese Dong only.`;
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            
            // Show loading with spinner
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner inline-block mr-2"></div> Signing in...';
            
            // Check if Web App URL is configured
            if (!GOOGLE_APPS_SCRIPT_WEB_APP_URL || GOOGLE_APPS_SCRIPT_WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE' || GOOGLE_APPS_SCRIPT_WEB_APP_URL.trim() === '') {
                // Fallback to simple authentication (for testing without backend)
                console.warn('⚠️ Web App URL not configured. Using fallback authentication.');
                currentUser = email.toLowerCase().includes('admin') 
                    ? { name: 'Super Admin', role: 'System Administrator', isAdmin: true, id: 'ADM-001', email: email }
                    : { name: 'Alex Smith', role: 'Finance Operations', isAdmin: false, id: 'EMP-772', email: email };
                // Persist fallback user as well
                try {
                    localStorage.setItem('tlc_current_user', JSON.stringify(currentUser));
                } catch (e) {
                    console.warn('Could not persist fallback user:', e);
                }
                updateUI();
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                showPage(requestedPage || 'home');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            try {
                console.log('Sending login request to:', GOOGLE_APPS_SCRIPT_WEB_APP_URL);
                console.log('Request payload:', { action: 'login', email: email, password: '***' });
                
                // Use FormData to avoid CORS preflight (Google Apps Script works better with form data)
                // FormData doesn't trigger preflight OPTIONS request
                const formData = new FormData();
                formData.append('action', 'login');
                formData.append('email', email);
                formData.append('password', password);
                
                console.log('Using FormData to avoid CORS preflight');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                    // Don't set Content-Type header - browser will set it automatically for FormData
                    // This avoids CORS preflight OPTIONS request
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                console.log('Response headers:', response.headers);
                
                // Check if response is ok
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response not OK:', response.status, errorText);
                    showToast('Login failed: Server returned error ' + response.status + '. Please check Apps Script logs.', 'error');
                    return;
                }
                
                // Try to parse as JSON
                let result;
                const responseText = await response.text();
                console.log('Response text:', responseText);
                console.log('Response text length:', responseText.length);
                
                // Check if response is empty
                if (!responseText || responseText.trim() === '') {
                    console.error('Response is empty');
                    showToast('Login error: Empty response from server. Please check Apps Script deployment and logs.', 'error');
                    return;
                }
                
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Failed to parse JSON:', parseError);
                    console.error('Response text:', responseText);
                    console.error('Response text type:', typeof responseText);
                    showToast('Login error: Invalid response from server. Check console for details.', 'error');
                    return;
                }
                
                console.log('Login response:', result);
                console.log('Result data:', result.data);
                console.log('Result data type:', typeof result.data);
                console.log('Result data keys:', result.data ? Object.keys(result.data) : 'N/A');
                
                if (result.success && result.data) {
                    // Set current user from server response - use actual data from Google Sheet
                    // Map all fields from Google Sheet (DO NOT include password)
                    // Map user data from API response - prioritize employeeId from backend
                    const employeeId = result.data.employeeId || result.data['EmployeeId'] || result.data['employeeId'] || '';
                    
                    currentUser = {
                        email: result.data.email || email,
                        name: result.data.name || result.data['Họ và tên'] || 'User',
                        role: result.data.role || result.data['Chức vụ'] || 'User',
                        isAdmin: result.data.isAdmin || false,
                        id: employeeId || 'N/A', // Use employeeId from sheet, or 'N/A' if empty
                        employeeId: employeeId, // Store separately for profile display
                        department: result.data.department || result.data['Phòng ban'] || '',
                        company: result.data.company || result.data['Công ty'] || '',
                        phone: result.data.phone || result.data['Điện thoại'] || ''
                    };
                    console.log('Current user set:', currentUser);
                    console.log('User name:', currentUser.name);
                    console.log('User role:', currentUser.role);
                    console.log('User id:', currentUser.id);
                    console.log('User department:', currentUser.department);
                    console.log('User company:', currentUser.company);
                    console.log('User phone:', currentUser.phone);
                    
                    // Persist login session
                    try {
                        localStorage.setItem('tlc_current_user', JSON.stringify(currentUser));
                    } catch (e) {
                        console.warn('Could not persist user in localStorage:', e);
                    }
                    
                    // Show success toast
                    showToast('Login successful! Welcome, ' + currentUser.name, 'success');
                    
                    // Small delay for toast visibility, then update UI
                    setTimeout(() => {
                        updateUI();
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        showPage(requestedPage || 'home');
                    }, 500);
                } else {
                    console.error('Login failed:', result.message);
                    console.error('Result:', result);
                    showToast('Login failed: ' + (result.message || 'Invalid credentials'), 'error');
                }
            } catch (error) {
                console.error('=== LOGIN ERROR ===');
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Full error object:', error);
                
                // More specific error messages
                let errorMessage = 'Login error: ';
                let errorType = 'error';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your internet connection and Web App URL.';
                    errorType = 'error';
                } else if (error.name === 'SyntaxError') {
                    errorMessage += 'Invalid response format. Please check Apps Script logs.';
                    errorType = 'error';
                } else {
                    errorMessage += error.message + '. Please check console (F12) for details.';
                    errorType = 'error';
                }
                
                showToast(errorMessage, errorType);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Form Validation
        function validateEmailInput(input) {
            const errorDiv = document.getElementById('login-email-error');
            if (input.validity.valid) {
                input.classList.remove('error');
                input.classList.add('success');
                if (errorDiv) errorDiv.classList.add('hidden');
            } else {
                input.classList.remove('success');
                input.classList.add('error');
                if (errorDiv) {
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a valid email address';
                    errorDiv.classList.remove('hidden');
                }
            }
        }
        
        function validatePasswordInput(input) {
            const errorDiv = document.getElementById('login-pass-error');
            if (input.value.length >= 1) {
                input.classList.remove('error');
                input.classList.add('success');
                if (errorDiv) errorDiv.classList.add('hidden');
            } else {
                input.classList.remove('success');
                input.classList.add('error');
                if (errorDiv) {
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Password is required';
                    errorDiv.classList.remove('hidden');
                }
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Icon based on type
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'error') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas ${icon} text-lg"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Global Search Functionality
        function initGlobalSearch() {
            const searchInput = document.getElementById('global-search');
            if (!searchInput) return;
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = searchInput.value.toLowerCase().trim();
                    if (!query) return;
                    
                    // Search workflows
                    const workflows = ['Order to Cash', 'Purchase to Pay', 'Cash & Vouchers'];
                    const matched = workflows.find(w => w.toLowerCase().includes(query));
                    
                    if (matched) {
                        if (matched.includes('Cash')) showPage('process-cash');
                        else if (matched.includes('Purchase')) showPage('process-p2p');
                        else if (matched.includes('Order')) showPage('process-o2c');
                        showToast(`Opening ${matched}...`, 'info');
                    } else {
                        showToast('No results found', 'warning');
                    }
                }
            });
        }

        function updateUI() {
            const loginBtnSection = document.getElementById('login-button-section');
            const userInfoSection = document.getElementById('user-info-section');
            
            if(!currentUser) {
                // Show login button, hide user info
                if(loginBtnSection) loginBtnSection.classList.remove('hidden');
                if(userInfoSection) userInfoSection.classList.add('hidden');
                return;
            }
            
            // User is logged in - show user info, hide login button
            if(loginBtnSection) loginBtnSection.classList.add('hidden');
            if(userInfoSection) userInfoSection.classList.remove('hidden');
            
            document.getElementById('user-display-name').textContent = currentUser.name;
            document.getElementById('user-display-role').textContent = currentUser.role;
            
            // Update welcome name in dashboard
            const welcomeName = document.getElementById('welcome-name');
            if (welcomeName && currentUser.name) {
                welcomeName.textContent = ', ' + currentUser.name.split(' ')[0];
            }
            const av = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=${currentUser.isAdmin ? 'ea580c' : '2563eb'}&color=fff`;
            document.getElementById('user-avatar').src = av;
            document.getElementById('profile-avatar').src = av;
            document.getElementById('profile-name').textContent = currentUser.name;
            // Display role and EmployeeId - use employeeId from sheet if available
            const displayId = currentUser.employeeId || currentUser.id || 'N/A';
            document.getElementById('profile-role').textContent = `${currentUser.role} • ID: ${displayId}`;
            
            // Update profile details (if elements exist)
            const profileEmail = document.getElementById('profile-email');
            const profilePosition = document.getElementById('profile-position');
            const profileDepartment = document.getElementById('profile-department');
            const profileCompany = document.getElementById('profile-company');
            const profilePhone = document.getElementById('profile-phone');
            const profileEmployeeId = document.getElementById('profile-employee-id');
            
            if (profileEmail) profileEmail.textContent = currentUser.email || 'N/A';
            if (profilePosition) profilePosition.textContent = currentUser.role || 'N/A';
            if (profileDepartment) profileDepartment.textContent = currentUser.department || 'N/A';
            if (profileCompany) profileCompany.textContent = currentUser.company || 'N/A';
            if (profilePhone) profilePhone.textContent = currentUser.phone || 'N/A';
            // Display EmployeeId from sheet (Column H) - use employeeId field first, then id
            if (profileEmployeeId) {
                const displayEmployeeId = currentUser.employeeId || currentUser.id || 'N/A';
                profileEmployeeId.textContent = displayEmployeeId;
            }
            
            if (currentUser.isAdmin) {
                document.getElementById('nav-admin').classList.remove('hidden');
                document.getElementById('admin-management-hub').classList.remove('hidden');
                document.getElementById('admin-verified-badge').classList.remove('hidden');
            }
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerHTML = translations[lang][key];
            });
            const enBtn = document.getElementById('lang-en'); if(enBtn) enBtn.className = `px-2 py-1 text-[10px] font-bold rounded-md transition ${lang === 'en' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`;
            const viBtn = document.getElementById('lang-vi'); if(viBtn) viBtn.className = `px-2 py-1 text-[10px] font-bold rounded-md transition ${lang === 'vi' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`;
            const aiArea = document.getElementById('ai-messages');
            if (aiArea) aiArea.innerHTML = `<div class="chat-message bg-blue-100 text-blue-800 p-3 rounded-2xl rounded-tl-none">${translations[lang].aiWelcome}</div>`;
        }

        function toggleAIChat() { document.getElementById('ai-chat-window').classList.toggle('hidden'); }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const text = input.value.trim();
            if(!text) return;
            const area = document.getElementById('ai-messages');
            area.insertAdjacentHTML('beforeend', `<div class="chat-message self-end bg-slate-200 p-3 rounded-2xl rounded-tr-none ml-auto">${text}</div>`);
            input.value = "";
            const loadId = 'l-' + Date.now();
            area.insertAdjacentHTML('beforeend', `<div id="${loadId}" class="chat-message bg-blue-100 p-3 rounded-2xl rounded-tl-none italic loading-dots">Thinking</div>`);
            area.scrollTop = area.scrollHeight;
            const res = await callGemini(text, `TLCGroup Hub AI. Help with company processes.`);
            const loader = document.getElementById(loadId);
            if(loader) { loader.classList.remove('loading-dots', 'italic'); loader.innerHTML = `<div>${res.replace(/\n/g, '<br>')}</div>`; }
            area.scrollTop = area.scrollHeight;
        }

        async function callGemini(p, s) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: p }] }], systemInstruction: { parts: [{ text: s }] } }) });
                const d = await r.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
            } catch (e) { return "Service unavailable."; }
        }

        function handleAddEmployee(event) {
            event.preventDefault();
            const name = document.getElementById('new-emp-name').value;
            const email = document.getElementById('new-emp-email').value;
            const feedback = document.getElementById('mgmt-feedback');
            feedback.classList.remove('hidden');
            feedback.className = 'mt-4 p-3 rounded-xl text-xs font-bold text-center border bg-green-50 text-green-700 border-green-200';
            feedback.textContent = `Employee ${name} (${email}) added successfully!`;
            document.getElementById('new-emp-name').value = '';
            document.getElementById('new-emp-email').value = '';
        }

        // Enhanced Approval Workflow Functions
        const approvalHistory = {}; // Store approval history
        
        function approveStep(processId, stepNumber) {
            const comment = document.getElementById(`${processId}-comment-${stepNumber}`)?.value || '';
            const approver = currentUser ? currentUser.name : 'Unknown';
            const timestamp = new Date().toLocaleString('vi-VN');
            
            // Update step status
            const stepElement = document.querySelector(`#${processId} .approval-step:nth-child(${stepNumber})`);
            if (stepElement) {
                stepElement.classList.remove('active', 'pending');
                stepElement.classList.add('completed');
                
                const badge = stepElement.querySelector('.approval-badge');
                if (badge) {
                    badge.className = 'approval-badge badge-approved';
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> Approved';
                }
                
                // Disable buttons
                const buttons = stepElement.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }
            
            // Add to history
            if (!approvalHistory[processId]) approvalHistory[processId] = [];
            approvalHistory[processId].push({
                step: stepNumber,
                action: 'approved',
                approver: approver,
                comment: comment,
                timestamp: timestamp
            });
            
            // Update next step if exists
            const nextStep = document.querySelector(`#${processId} .approval-step:nth-child(${stepNumber + 1})`);
            if (nextStep && nextStep.classList.contains('pending')) {
                nextStep.classList.remove('pending');
                nextStep.classList.add('active');
                const nextBadge = nextStep.querySelector('.approval-badge');
                if (nextBadge) {
                    nextBadge.className = 'approval-badge badge-pending';
                    nextBadge.innerHTML = '<i class="fas fa-clock"></i> Active';
                }
            }
            
            // Update approval history display
            updateApprovalHistory(processId);
            
            // Update progress if exists
            updateApprovalProgress(processId);
            
            showToast(`Step ${stepNumber} approved successfully`, 'success');
        }
        
        function rejectStep(processId, stepNumber) {
            const comment = document.getElementById(`${processId}-comment-${stepNumber}`)?.value || '';
            if (!comment.trim()) {
                showToast('Please add a comment explaining the rejection', 'warning');
                return;
            }
            
            const approver = currentUser ? currentUser.name : 'Unknown';
            const timestamp = new Date().toLocaleString('vi-VN');
            
            // Update step status
            const stepElement = document.querySelector(`#${processId} .approval-step:nth-child(${stepNumber})`);
            if (stepElement) {
                stepElement.classList.remove('active', 'pending');
                stepElement.classList.add('rejected');
                
                const badge = stepElement.querySelector('.approval-badge');
                if (badge) {
                    badge.className = 'approval-badge badge-rejected';
                    badge.innerHTML = '<i class="fas fa-times-circle"></i> Rejected';
                }
                
                // Disable buttons
                const buttons = stepElement.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }
            
            // Add to history
            if (!approvalHistory[processId]) approvalHistory[processId] = [];
            approvalHistory[processId].push({
                step: stepNumber,
                action: 'rejected',
                approver: approver,
                comment: comment,
                timestamp: timestamp
            });
            
            // Update approval history display
            updateApprovalHistory(processId);
            
            showToast(`Step ${stepNumber} rejected`, 'error');
        }
        
        function requestChanges(processId, stepNumber) {
            const comment = document.getElementById(`${processId}-comment-${stepNumber}`)?.value || '';
            if (!comment.trim()) {
                showToast('Please specify what changes are needed', 'warning');
                return;
            }
            
            const approver = currentUser ? currentUser.name : 'Unknown';
            const timestamp = new Date().toLocaleString('vi-VN');
            
            // Add to history
            if (!approvalHistory[processId]) approvalHistory[processId] = [];
            approvalHistory[processId].push({
                step: stepNumber,
                action: 'changes_requested',
                approver: approver,
                comment: comment,
                timestamp: timestamp
            });
            
            // Update approval history display
            updateApprovalHistory(processId);
            
            showToast('Changes requested. Requestor will be notified.', 'info');
        }
        
        function approveParallel(role, processId) {
            const commentId = `o2c-${role}-comment`;
            const comment = document.getElementById(commentId)?.value || '';
            const approver = currentUser ? currentUser.name : 'Unknown';
            const timestamp = new Date().toLocaleString('vi-VN');
            
            // Update card status
            const card = document.getElementById(`o2c-app-${role}`)?.closest('.approval-card');
            if (card) {
                const badge = card.querySelector('.approval-badge');
                if (badge) {
                    badge.className = 'approval-badge badge-approved';
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> Approved';
                }
                
                // Disable buttons
                const buttons = card.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }
            
            // Add to history
            if (!approvalHistory[processId]) approvalHistory[processId] = [];
            approvalHistory[processId].push({
                role: role,
                action: 'approved',
                approver: approver,
                comment: comment,
                timestamp: timestamp
            });
            
            // Check if all parallel approvals are done
            checkParallelApprovalStatus(processId);
            
            showToast(`${role.charAt(0).toUpperCase() + role.slice(1)} approval completed`, 'success');
        }
        
        function rejectParallel(role, processId) {
            const commentId = `o2c-${role}-comment`;
            const comment = document.getElementById(commentId)?.value || '';
            if (!comment.trim()) {
                showToast('Please add a comment explaining the rejection', 'warning');
                return;
            }
            
            const approver = currentUser ? currentUser.name : 'Unknown';
            const timestamp = new Date().toLocaleString('vi-VN');
            
            // Update card status
            const card = document.getElementById(`o2c-app-${role}`)?.closest('.approval-card');
            if (card) {
                const badge = card.querySelector('.approval-badge');
                if (badge) {
                    badge.className = 'approval-badge badge-rejected';
                    badge.innerHTML = '<i class="fas fa-times-circle"></i> Rejected';
                }
                
                // Disable buttons
                const buttons = card.querySelectorAll('button');
                buttons.forEach(btn => btn.disabled = true);
            }
            
            // Add to history
            if (!approvalHistory[processId]) approvalHistory[processId] = [];
            approvalHistory[processId].push({
                role: role,
                action: 'rejected',
                approver: approver,
                comment: comment,
                timestamp: timestamp
            });
            
            showToast(`${role.charAt(0).toUpperCase() + role.slice(1)} approval rejected`, 'error');
        }
        
        function checkParallelApprovalStatus(processId) {
            const cards = document.querySelectorAll(`#${processId} .parallel-approval .approval-card`);
            const approved = Array.from(cards).filter(card => 
                card.querySelector('.badge-approved')
            ).length;
            const rejected = Array.from(cards).filter(card => 
                card.querySelector('.badge-rejected')
            ).length;
            
            if (approved === cards.length) {
                showToast('All parallel approvals completed!', 'success');
            } else if (rejected > 0) {
                showToast('One or more approvals rejected', 'error');
            }
        }
        
        function updateApprovalHistory(processId) {
            const historyContainer = document.getElementById(`${processId}-history`);
            if (!historyContainer || !approvalHistory[processId]) return;
            
            const history = approvalHistory[processId];
            historyContainer.innerHTML = history.map(item => {
                const actionIcon = item.action === 'approved' ? 'fa-check-circle text-emerald-600' :
                                 item.action === 'rejected' ? 'fa-times-circle text-red-600' :
                                 'fa-edit text-amber-600';
                const actionText = item.action === 'approved' ? 'Approved' :
                                  item.action === 'rejected' ? 'Rejected' :
                                  'Changes Requested';
                
                return `
                    <div class="approval-comment">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-slate-700">
                                <i class="fas ${actionIcon} mr-1"></i>
                                ${actionText} by ${item.approver}
                            </span>
                            <span class="text-xs text-slate-500">${item.timestamp}</span>
                        </div>
                        ${item.comment ? `<p class="text-xs text-slate-600 mt-1">${item.comment}</p>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function updateApprovalProgress(processId) {
            const progressBar = document.getElementById(`${processId}-approval-progress`);
            if (!progressBar) return;
            
            const steps = document.querySelectorAll(`#${processId} .approval-step`);
            const completed = Array.from(steps).filter(step => 
                step.classList.contains('completed')
            ).length;
            const total = steps.length;
            
            const percentage = (completed / total) * 100;
            progressBar.style.width = `${percentage}%`;
            
            const progressText = progressBar.parentElement.querySelector('span:last-child');
            if (progressText) {
                progressText.textContent = `${completed} of ${total} completed`;
            }
        }
        
        function toggleApprovalHistory(historyId) {
            const history = document.getElementById(historyId);
            const icon = document.getElementById(`${historyId}-icon`);
            if (!history) return;
            
            history.classList.toggle('hidden');
            if (icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        }
        
        // Table Sorting Function - Kissflow Style
        let sortDirection = {};
        function sortTable(tableBodyId, columnIndex) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const currentDir = sortDirection[tableBodyId + columnIndex] || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortDirection[tableBodyId + columnIndex] = newDir;
            
            // Update header classes
            const headers = document.querySelectorAll(`#${tableBodyId}`).closest('table')?.querySelectorAll('th');
            if (headers) {
                headers.forEach((h, i) => {
                    h.classList.remove('sort-asc', 'sort-desc');
                    if (i === columnIndex) {
                        h.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex]?.textContent.trim() || '';
                const bText = b.cells[columnIndex]?.textContent.trim() || '';
                
                // Try to parse as number
                const aNum = parseFloat(aText.replace(/,/g, ''));
                const bNum = parseFloat(bText.replace(/,/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // String comparison
                return newDir === 'asc' 
                    ? aText.localeCompare(bText)
                    : bText.localeCompare(aText);
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            
            showToast(`Table sorted by column ${columnIndex + 1} (${newDir === 'asc' ? 'ascending' : 'descending'})`, 'info');
        }
        
        // Filter Table Function
        function filterTable(tableBodyId, filterType) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                let show = true;
                
                if (filterType === 'debit') {
                    const debit = row.cells[3]?.textContent.trim();
                    show = debit && debit !== '-';
                } else if (filterType === 'credit') {
                    const credit = row.cells[4]?.textContent.trim();
                    show = credit && credit !== '-';
                }
                
                row.style.display = show ? '' : 'none';
            });
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.closest('.filter-btn')?.classList.add('active');
        }
        
        // Search Table Function
        function searchTable(tableBodyId, searchTerm) {
            const tbody = document.getElementById(tableBodyId);
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        // Load Cash & Admin Summary
        async function loadCashSummary() {
            const summaryCards = document.getElementById('cash-summary-cards');
            const recentList = document.getElementById('recent-vouchers-list');
            
            if (!summaryCards || !recentList) return;
            
            // Show loading state
            recentList.innerHTML = `
                <div class="text-center py-8 text-slate-400">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading vouchers...</p>
                </div>
            `;
            
            try {
                // Fetch summary data from Google Apps Script
                const formData = new FormData();
                formData.append('action', 'getVoucherSummary');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    
                    // Update summary cards
                    const total = data.total || 0;
                    const pending = data.pending || 0;
                    const approved = data.approved || 0;
                    const rejected = data.rejected || 0;

                    document.getElementById('summary-total').textContent = total;
                    document.getElementById('summary-pending').textContent = pending;
                    document.getElementById('summary-approved').textContent = approved;
                    document.getElementById('summary-rejected').textContent = rejected;

                    // Update top-line voucher summary
                    const tlTotal = document.getElementById('topline-voucher-total');
                    const tlPending = document.getElementById('topline-voucher-pending');
                    const tlApproved = document.getElementById('topline-voucher-approved');
                    const tlRejected = document.getElementById('topline-voucher-rejected');
                    if (tlTotal) tlTotal.textContent = total;
                    if (tlPending) tlPending.textContent = pending;
                    if (tlApproved) tlApproved.textContent = approved;
                    if (tlRejected) tlRejected.textContent = rejected;
                    
                    // Update recent vouchers list
                    if (data.recent && data.recent.length > 0) {
                        recentList.innerHTML = data.recent.map(voucher => {
                            const statusClass = voucher.status === 'Approved' ? 'bg-emerald-100 text-emerald-700' :
                                                voucher.status === 'Rejected' ? 'bg-red-100 text-red-700' :
                                                'bg-amber-100 text-amber-700';
                            const statusIcon = voucher.status === 'Approved' ? 'fa-check-circle' :
                                             voucher.status === 'Rejected' ? 'fa-times-circle' :
                                             'fa-clock';
                            
                            return `
                                <div class="flex items-center justify-between p-4 bg-white border border-slate-200 rounded-lg hover:shadow-md transition">
                                    <div class="flex items-center gap-4 flex-1">
                                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-file-invoice text-purple-600"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-1">
                                                <h4 class="font-bold text-slate-800">${voucher.voucherNumber || 'N/A'}</h4>
                                                <span class="status-badge ${statusClass}">
                                                    <i class="fas ${statusIcon} mr-1"></i>
                                                    ${voucher.status || 'Pending'}
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-4 text-sm text-slate-600">
                                                <span><i class="fas fa-building mr-1"></i> ${voucher.company || 'N/A'}</span>
                                                <span><i class="fas fa-user mr-1"></i> ${voucher.employee || 'N/A'}</span>
                                                <span><i class="fas fa-money-bill-wave mr-1"></i> ${formatCurrency(voucher.amount || 0)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-slate-500">${voucher.timestamp || ''}</p>
                                        <p class="text-xs text-slate-400 mt-1">${voucher.action || ''}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        recentList.innerHTML = `
                            <div class="text-center py-8 text-slate-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>No vouchers found</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(result.message || 'Failed to load summary');
                }
            } catch (error) {
                console.error('Error loading cash summary:', error);
                recentList.innerHTML = `
                    <div class="text-center py-8 text-red-400">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Error loading vouchers</p>
                        <p class="text-xs mt-1">${error.message}</p>
                    </div>
                `;
                
                // Set default values
                document.getElementById('summary-total').textContent = '0';
                document.getElementById('summary-pending').textContent = '0';
                document.getElementById('summary-approved').textContent = '0';
                document.getElementById('summary-rejected').textContent = '0';
            }
        }

        // Format currency helper
        function formatCurrency(amount) {
            if (!amount || amount === 0) return '0 ₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount).replace('₫', '₫');
        }
        
        // Initialize table search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInputs = document.querySelectorAll('.table-search');
            searchInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    const tableBodyId = e.target.closest('.table-container')?.querySelector('tbody')?.id;
                    if (tableBodyId) {
                        searchTable(tableBodyId, e.target.value);
                    }
                });
            });
            
            // Initialize filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const filterType = e.target.textContent.trim().toLowerCase();
                    const tableBodyId = e.target.closest('.table-container')?.querySelector('tbody')?.id;
                    if (tableBodyId && filterType !== 'all') {
                        filterTable(tableBodyId, filterType);
                    } else if (tableBodyId) {
                        // Show all
                        const rows = document.getElementById(tableBodyId)?.querySelectorAll('tr');
                        rows?.forEach(row => row.style.display = '');
                    }
                });
            });
        });

        window.onload = () => {
            setLanguage('en');

            // Restore login session from localStorage if available
            try {
                const stored = localStorage.getItem('tlc_current_user');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed && parsed.email) {
                        currentUser = parsed;
                        console.log('Restored user from localStorage:', currentUser);
                        updateUI();
                        // Show main content directly, keep user on home dashboard
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                    } else {
                        updateUI();
                    }
                } else {
                    updateUI();
                }
            } catch (e) {
                console.warn('Error restoring user from localStorage:', e);
                updateUI();
            }

            // Initialize global search
            initGlobalSearch();
            // Show homepage by default (public access)
            showPage('home');
            // Seed dropdowns safely
            const seedSelect = (id, data, valKey = 'name') => {
                const el = document.getElementById(id);
                if (el) {
                    data.forEach(item => {
                        const val = typeof item === 'string' ? item : item[valKey];
                        el.insertAdjacentHTML('beforeend', `<option value="${val}">${val}</option>`);
                    });
                }
            };
            seedSelect('o2c-co-select', companiesData);
            seedSelect('p2p-co-select', companiesData);
            seedSelect('o2c-req-select', employeeNames);
            seedSelect('o2c-cust-select', customersData);
            seedSelect('p2p-budget-app', employeeNames);
            seedSelect('p2p-supp-app', employeeNames);
            seedSelect('p2p-final-app', employeeNames);
            seedSelect('acc-creator', employeeNames);
            seedSelect('acc-acceptor', employeeNames);
            seedSelect('o2c-app-legal', employeeNames);
            seedSelect('o2c-app-acc', employeeNames);
            seedSelect('o2c-app-dir', employeeNames);
            addRow('o2c-items-body');
        };
    </script>

</body>
</html>

